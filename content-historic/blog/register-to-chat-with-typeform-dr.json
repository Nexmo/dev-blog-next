{"_filedata":{"slug":"register-to-chat-with-typeform-dr"},"title":"Register to Chat with Typeform","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2019/11/TW_Typeform_1200x675.png","author":310,"published":true,"published_at":"2019-11-20T13:46:48","tags":[1628,1623,1636,793,1336],"body":"In this article, you’ll learn how to set up [Typeform](https://www.typeform.com/) and capture data from a webhook in the [Node.js](https://nodejs.org/en/) framework [Express.js](https://expressjs.com/). You’ll use [Passport.js](http://www.passportjs.org/) to authenticate a user, use [Nexmo’s Node.js Server SDK](https://github.com/Nexmo/nexmo-node/tree/beta) to register a user, and generate a JWT to use with [Nexmo’s JavaScript Client SDK](https://developer.nexmo.com/client-sdk/overview).\n\nYou’ll be starting from a pre-built chat application built using [Nexmo’s JavaScript Client SDK](https://developer.nexmo.com/client-sdk/overview) and [Bootstrap](https://getbootstrap.com/).\n\nThis tutorial starts from the [master](https://github.com/nexmo-community/nexmo-chat-typeform-magiclinks) branch and ends at the [tutorial-finish](https://github.com/nexmo-community/nexmo-chat-typeform-magiclinks/tree/tutorial-finish) branch. You can skip to the end by checking out `tutorial-finish` and following the [README](https://github.com/lukeocodes/nexmo-chat-typeform-magiclinks/blob/tutorial-finish/README.md) to get up and running quickly.\n\n## Prerequisites\n\n### Node & NPM\n\nTo follow this guide, you’ll need Node.js and NPM installed. This guide uses Node.js 13.1 and NPM 6.12. Check you have stable or long-term support versions of Node.js installed, at least.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">node --version</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dc9341376275-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dc9341376275-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dc9341376275-1\"><span class=\"crayon-v\">node</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-i\">version</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dc9341376275-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm --version</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dcc326527425-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dcc326527425-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dcc326527425-1\"><span class=\"crayon-v\">npm</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-i\">version</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dcc326527425-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nIf you don’t have Node.js or NPM, or you have older versions, head over to [nodejs.org and install the correct version](https://nodejs.org/en/) if you don’t have it.\n\n### Nexmo Account\n\n[Sign up for a free Nexmo account](https://dashboard.nexmo.com/sign-up).\n\n### Nexmo CLI\n\nTo set up your application, you’ll need to install the [Nexmo CLI](https://github.com/Nexmo/nexmo-cli/tree/beta). Install it using NPM in terminal.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm install -g nexmo-cli@beta</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dce380886582-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dce380886582-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dce380886582-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-v\">install</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">g</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nexmo</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">cli</span><span class=\"crayon-sy\">@</span><span class=\"crayon-i\">beta</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dce380886582-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nNow, configure the CLI using your API key and secret, found on your [Nexmo account dashboard](https://dashboard.nexmo.com/).\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">nexmo setup &lt;your_api_key&gt; &lt;your_api_secret&gt;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dcf418948424-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dcf418948424-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dcf418948424-1\"><span class=\"crayon-e\">nexmo </span><span class=\"crayon-v\">setup</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">your_api_key</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">your_api_secret</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dcf418948424-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n### MongoDB\n\nWe’ll be storing information in MongoDB. If you don’t have MongoDB installed, follow the correct [MongoDB Community Edition installation guide](https://docs.mongodb.com/manual/administration/install-community/) for your system.\n\n### Ngrok\n\nBecause you’ll be receiving information from a 3rd party, you’ll need to expose the application running on your local machine, but in a safe way. Ngrok is a safe way to use a single command for an instant, secure URL that allows you to access your local machine, even through a NAT or firewall.\n\n[Sign up and configure ngrok](https://ngrok.com/) by following the instructions on their site.\n\n### Typeform\n\nYou’ll use Typeform to capture input from users, so [sign-up now for a free Typeform account](https://admin.typeform.com/signup).\n\n### Email SMTP Provider\n\nYou’ll be sending emails. You’ll need the hostname, port, a login and a password for an SMTP provider.\n\nYou can use [Google Mail to send email from an app](https://support.google.com/a/answer/176600?hl=en).\n\n### Git (optional)\n\nYou can use git to clone the demo application from GitHub.\n\n> If you’re not comfortable with git, this guide also contains instructions on downloading the project as a ZIP file.\n\nFollow this [guide to install git](https://git-scm.com/book/en/v2/Getting-Started-Installing-Git)\n\n## Starting Out\n\nThe application you’re starting with is a chat application built using Bootstrap and the [Nexmo JavaScript Client SDK](https://developer.nexmo.com/client-sdk/overview). It’s configurable through editing static files, but launched using [Express.js](https://expressjs.com/), a lightweight Node.js based http server.\n\n### Basic Installation\n\nClone the demo application straight from GitHub.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">git clone https://github.com/nexmo-community/nexmo-chat-typeform-magiclinks.git</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd0304054146-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dd0304054146-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd0304054146-1\"><span class=\"crayon-e\">git </span><span class=\"crayon-r\">clone</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">https</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//github.com/nexmo-community/nexmo-chat-typeform-magiclinks.git</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dd0304054146-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nOr, for those not comfortable with git commands, you can [download the demo application as a zip file](https://github.com/nexmo-community/nexmo-chat-typeform-magiclinks/archive/master.zip) and unpack it locally.\n\nOnce cloned or unpacked, change into the new demo application directory.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">cd nexmo-chat-typeform-magiclinks</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd1951762105-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dd1951762105-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd1951762105-1\"><span class=\"crayon-e\">cd </span><span class=\"crayon-v\">nexmo</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">chat</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">typeform</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">magiclinks</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dd1951762105-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nInstall the npm dependencies.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm install</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd2242342357-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dd2242342357-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd2242342357-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-i\">install</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dd2242342357-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nInstalled alongside Node.js is a package called `nodemon`, that will automatically reload your server if you edit any files.\n\nStart the application the standard way.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm start</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd3141241417-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dd3141241417-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd3141241417-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-i\">start</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dd3141241417-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nStart the application, but with nodemon instead.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm run dev</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd4466686108-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dd4466686108-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd4466686108-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-e\">run </span><span class=\"crayon-i\">dev</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dd4466686108-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n> **_Tip:_** If you’re running the application with `nodemon` for the rest of this tutorial, whenever I suggest restarting the application you won’t need to do that because `nodemon` does it for you. However, if you need to reauthenticate with the application, you will still need to do that, as the session information is stored in memory and not configured to use any other storage.\n\nWhichever way you choose to run the application, once it’s running you can try it out in your favourite browser, which should be able to find it running locally: [http://0.0.0.0:3000/](http://0.0.0.0:3000).\n\n![Chat running locally](https://www.nexmo.com/wp-content/uploads/2019/11/local_url.png)\n\nAs the application is unconfigured, you’ll see a very plain empty chat application that you cannot submit messages too. In the real world with error handling, you might show the user a connection error.\n\nBut, if you check the browser console now, you’ll just see a Nexmo API error for a missing token. This means the application tried to connect but didn’t provide a user token permitting access the API.\n\nTest ngrok is configured properly, by running ngrok in a separate tab or window to `npm`.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">ngrok http 3000</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd5540560351-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dd5540560351-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd5540560351-1\"><span class=\"crayon-e\">ngrok </span><span class=\"crayon-i\">http</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3000</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dd5540560351-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n![Chat running locally through ngrok](https://www.nexmo.com/wp-content/uploads/2019/11/ngrok_url.png)\n\nYou need to run this `ngrok` command, and `npm` at the same time. This means you need two terminal windows or tabs available, both at the application directory.\n\n> **_Tip:_** If you need to repeat any quests later, like submitting data from Typeform to the webhook, you can open up [ngrok’s web interface at http://127.0.0.1:4040](http://127.0.0.1:4040) while it’s running and **_Replay_** a request.\n\nOne thing to remember is that until you pay for ngrok, your URL will be different every time you start it. Remember this when configuring your Typeform webhook later on. If you stop ngrok, you will need to reconfigure Typeform with the new URL when you start it again.\n\n> **_Tip:_** If you’re confident with using a tool like [Postman](https://www.getpostman.com/) or writing manual cURL requests, and once you have your first webhook request from Typeform, you could create a request to be able to repeat that request later.\n\n## Get Chatting\n\nIn the prerequisites, you setup your CLI using your Nexmo API key and secret. Now, you can run CLI commands to create a Nexmo application, user, conversation, join the user to the conversation and generate a JWT so your user can chat.\n\n### Nexmo Configuration\n\nYou’ll need to use some of the IDs returned once you’ve ran some of the commands. Keep a note, by copying and pasting your application, conversation, and user IDs.\n\n#### Create Nexmo Application\n\nThis command creates a new Nexmo application with RTC (real-time communication) capabilities. You won’t be capturing the events in your application, so you can provide an example web address for the event URL. The private key will be output to a file path of your choice.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">nexmo app:create \"Nexmo RTC Chat\" --capabilities=rtc --rtc-event-url=http://example.com --keyfile=private.key # Application created: 4556dbae-bf...f6e33350d8 # Credentials written to .nexmo-app # Private Key saved to: private.key</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd6602712661-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dd6602712661-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd6602712661-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dd6602712661-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd6602712661-5\">5</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd6602712661-1\"><span class=\"crayon-e\">nexmo </span><span class=\"crayon-v\">app</span><span class=\"crayon-o\">:</span><span class=\"crayon-i\">create</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Nexmo RTC Chat\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">capabilities</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">rtc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">rtc</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">event</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">url</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//example.com --keyfile=private.key</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dd6602712661-2\"><span class=\"crayon-p\"># Application created: 4556dbae-bf...f6e33350d8</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd6602712661-3\"><span class=\"crayon-p\"># Credentials written to .nexmo-app</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dd6602712661-4\"><span class=\"crayon-p\"># Private Key saved to: private.key</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd6602712661-5\">&nbsp;</div></div></td></tr></tbody></table>\n\n> **_Tip:_** Your application is also output to a config file (`.nexmo-app`) in the directory you ran this command. This means that some further commands from this directory will be relevative to this application, like creating users and conversations.\n\n#### Create Nexmo Conversation\n\nWith an application created, you can create a conversation. The conversation will be what your users join to send messages to and fro.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">nexmo conversation:create display_name=\"Typeform Chatroom\" # Conversation created: CON-a57b0...11e57f56d</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd7395609870-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dd7395609870-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd7395609870-3\">3</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd7395609870-1\"><span class=\"crayon-e\">nexmo </span><span class=\"crayon-v\">conversation</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">create </span><span class=\"crayon-v\">display_name</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"Typeform Chatroom\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dd7395609870-2\"><span class=\"crayon-p\"># Conversation created: CON-a57b0...11e57f56d</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd7395609870-3\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Create Your User\n\nNow, create a user. This will be the user you authenticate with. For the moment you just need a user name and display name.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">nexmo user:create name=&lt;USER_NAME&gt; display_name=&lt;DISPLAY_NAME&gt; # User created: USR-6eaa4...e36b8a47f</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd8854531512-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dd8854531512-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd8854531512-3\">3</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd8854531512-1\"><span class=\"crayon-e\">nexmo </span><span class=\"crayon-v\">user</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">create </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">USER_NAME</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">display_name</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">DISPLAY_NAME</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dd8854531512-2\"><span class=\"crayon-p\"># User created: USR-6eaa4...e36b8a47f</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd8854531512-3\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Add User To Conversation\n\nWith your conversation ID and user ID, run this command to join the conversation with your user.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">nexmo member:add &lt;CONVERSATION_ID&gt; action=join channel='{\"type\":\"app\"}' user_id=&lt;USER_ID&gt; # Member added: MEM-df772...1ad7fa06</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd9315776296-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dd9315776296-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dd9315776296-3\">3</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd9315776296-1\"><span class=\"crayon-e\">nexmo </span><span class=\"crayon-v\">member</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">add</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">CONVERSATION_ID</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">action</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">join </span><span class=\"crayon-v\">channel</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">'{\"type\":\"app\"}'</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user_id</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">USER_ID</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dd9315776296-2\"><span class=\"crayon-p\"># Member added: MEM-df772...1ad7fa06</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dd9315776296-3\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Generate User Token\n\nUse this command to generate a user token in the form of a JWT, usable by the API but also by Nexmo’s JavaScript Client SDK. It will return a JWT for you to use which expires in 24 hours, **or 86400 seconds**.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">nexmo jwt:generate ./private.key sub=&lt;USER_NAME&gt; exp=$(($(date +%s)+86400)) acl='{\"paths\":{\"/*/users/**\":{},\"/*/conversations/**\":{},\"/*/sessions/**\":{},\"/*/devices/**\":{},\"/*/image/**\":{},\"/*/media/**\":{},\"/*/applications/**\":{},\"/*/push/**\":{},\"/*/knocking/**\":{}}}' application_id=&lt;APPLICATION_ID&gt; # eyJhbGciOi...XVCJ9.eyJpYXQiOjE1NzM5M...In0.qn7J6...efWBpemaCDC7HtqA</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dda322118475-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dda322118475-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dda322118475-3\">3</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dda322118475-1\"><span class=\"crayon-e\">nexmo </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-o\">:</span><span class=\"crayon-i\">generate</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-m\">private</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">key </span><span class=\"crayon-v\">sub</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">USER_NAME</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">exp</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">date</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-o\">%</span><span class=\"crayon-v\">s</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">86400</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">acl</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">'{\"paths\":{\"/*/users/**\":{},\"/*/conversations/**\":{},\"/*/sessions/**\":{},\"/*/devices/**\":{},\"/*/image/**\":{},\"/*/media/**\":{},\"/*/applications/**\":{},\"/*/push/**\":{},\"/*/knocking/**\":{}}}'</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">application_id</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">APPLICATION_ID</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dda322118475-2\"><span class=\"crayon-p\"># eyJhbGciOi...XVCJ9.eyJpYXQiOjE1NzM5M...In0.qn7J6...efWBpemaCDC7HtqA</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dda322118475-3\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Configure The Application\n\nTo configure your application, edit the `views/layout.hbs` file and find the JavaScript configuration around line 61.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">&lt;script&gt; var userName = ''; var displayName = ''; var conversationId = ''; var clientToken = ''; &lt;/script&gt;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07ddb917176068-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07ddb917176068-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07ddb917176068-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07ddb917176068-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07ddb917176068-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07ddb917176068-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07ddb917176068-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07ddb917176068-1\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-ta\">&lt;script&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07ddb917176068-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">userName</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">''</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07ddb917176068-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">displayName</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">''</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07ddb917176068-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">conversationId</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">''</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07ddb917176068-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">clientToken</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">''</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07ddb917176068-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-ta\">&lt;/script&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07ddb917176068-7\">&nbsp;</div></div></td></tr></tbody></table>\n\nFirstly, configure the application like this, but by the end of the guide you’ll be able to authenticate with a magic link and the clientside application with get your user token from your authorized session.\n\nEdit the config with the values you’ve generated in the commands above.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">&lt;script&gt; var userName = 'luke.oliff@vonage.com'; var displayName = 'Luke Oliff'; var conversationId = 'CON-123...y6346'; var clientToken = 'eyJhbG9.eyJzdWIiO.Sfl5c'; &lt;/script&gt;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07ddc567381011-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07ddc567381011-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07ddc567381011-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07ddc567381011-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07ddc567381011-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07ddc567381011-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07ddc567381011-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07ddc567381011-1\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-ta\">&lt;script&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07ddc567381011-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">userName</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'luke.oliff@vonage.com'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07ddc567381011-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">displayName</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Luke Oliff'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07ddc567381011-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">conversationId</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'CON-123...y6346'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07ddc567381011-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">clientToken</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'eyJhbG9.eyJzdWIiO.Sfl5c'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07ddc567381011-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-ta\">&lt;/script&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07ddc567381011-7\">&nbsp;</div></div></td></tr></tbody></table>\n\nNow, you can start the application again and start chatting… with yourself… because no one else can log in.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm start</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07ddd773704835-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07ddd773704835-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07ddd773704835-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-i\">start</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07ddd773704835-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n![Running chat without errors](https://www.nexmo.com/wp-content/uploads/2019/11/working_chat.png)\n\n## Creating a Typeform\n\nYou can capture as much data as you like from your Typeform. But, for this guide, ensure you have a least an email field on the form.\n\nOnce you have created your Typeform, click over to the **Connect** tab on your Typeform edit page and click on **Webhooks**.\n\nClick on **Add a webhook** and enter the URL as `https://<your_url>.ngrok.io/webhooks/magiclink`. Then click **Save webhook**.\n\n![Configure Typeform webhook](https://www.nexmo.com/wp-content/uploads/2019/11/configure_typeform_webhook.png)\n\n> Once created, you can go back and add a secret to verify requests reaching your webhook are actually coming from Typeform.\n\nIf you complete your Typeform now and submit it while your application is running, the Typeform will receive a `404 Not Found` error and retry. _If a webhook request fails for any reason, Typeform will retry the request to your endpoint three times using a back-off mechanism after 5, 10, and 20 minutes._\n\n## Environment Variables\n\nFrom here on in, you’re going to be configuring your application with credentials that not only might differ between environments but also that you won’t want to commit along with your source code.\n\n`dotenv` was already a dependency of the starting project, so check out the `.env` file where it already contains the default port for the application. You’ll be coming back to this file soon to add more environment variables.\n\n## Add a Webhook\n\nNow, to fix your potential `404 Not Found` error, add the webhook by creating a new file in the application called `routes/webhook.js`. In the new file, add the following code.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">var express = require('express'); var router = express.Router(); /* POST webhook generates a magic link email to the provided email address */ router.post('/magiclink', (req, res, next) =&gt; { console.log(req.body); // always return a response... res.sendStatus(200); }); module.exports = router;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dde059623574-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dde059623574-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dde059623574-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dde059623574-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dde059623574-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dde059623574-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dde059623574-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dde059623574-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dde059623574-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dde059623574-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dde059623574-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dde059623574-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dde059623574-13\">13</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dde059623574-1\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">express</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'express'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dde059623574-2\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">router</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">express</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Router</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dde059623574-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dde059623574-4\"><span class=\"crayon-c\">/* POST webhook generates a magic link email to the provided email address */</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dde059623574-5\"><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/magiclink'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dde059623574-6\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">body</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dde059623574-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dde059623574-8\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// always return a response...</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dde059623574-9\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sendStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dde059623574-10\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dde059623574-11\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dde059623574-12\"><span class=\"crayon-v\">module</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">exports</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dde059623574-13\">&nbsp;</div></div></td></tr></tbody></table>\n\nEdit `app.js` and add in the webhook router.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">// ... var indexRouter = require('./routes/index'); var webhookRouter = require('./routes/webhook'); // ... app.use('/', indexRouter); app.use('/webhooks', webhookRouter); // ...</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de0411459976-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de0411459976-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de0411459976-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de0411459976-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de0411459976-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de0411459976-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de0411459976-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de0411459976-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de0411459976-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de0411459976-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de0411459976-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de0411459976-12\">12</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de0411459976-1\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de0411459976-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de0411459976-3\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">indexRouter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'./routes/index'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de0411459976-4\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">webhookRouter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'./routes/webhook'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de0411459976-5\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de0411459976-6\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de0411459976-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de0411459976-8\"><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">use</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">indexRouter</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de0411459976-9\"><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">use</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/webhooks'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">webhookRouter</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de0411459976-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de0411459976-11\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de0411459976-12\">&nbsp;</div></div></td></tr></tbody></table>\n\nWith npm and ngrok running you should now be able to complete your Typeform and receive a webhook request. The payload will contain data that looks like this and it will be output in the window where you started the application with npm.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">{ ... \"form_response\": { ... \"answers\": [ { \"type\": \"email\", \"email\": \"email@example.com\", \"field\": { \"type\": \"email\", } } ] } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de1827890882-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de1827890882-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de1827890882-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de1827890882-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de1827890882-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de1827890882-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de1827890882-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de1827890882-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de1827890882-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de1827890882-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de1827890882-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de1827890882-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de1827890882-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de1827890882-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de1827890882-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de1827890882-16\">16</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de1827890882-1\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de1827890882-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de1827890882-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"form_response\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de1827890882-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de1827890882-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"answers\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de1827890882-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de1827890882-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"type\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"email\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de1827890882-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"email\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"email@example.com\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de1827890882-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"field\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de1827890882-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"type\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"email\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de1827890882-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de1827890882-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de1827890882-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de1827890882-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de1827890882-15\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de1827890882-16\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Capture the Answer\n\nBefore editing the webhook, configure some variables for the Typeform and question inside your environment file `.env`. For `FORM_FIELD_REF`, you’ll need to edit your Typeform question and find the **Question reference** inside your question settings. `FORM_URL` is the public URL to complete the form.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\"># ... port etc # typeform config FORM_URL=https://username.typeform.com/to/123456 FORM_FIELD_TYPE=email FORM_FIELD_REF=e8bafec6-5...ee-21bfe1254e81</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de2140193569-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de2140193569-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de2140193569-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de2140193569-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de2140193569-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de2140193569-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de2140193569-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de2140193569-1\"><span class=\"crayon-p\"># ... port etc</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de2140193569-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de2140193569-3\"><span class=\"crayon-p\"># typeform config</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de2140193569-4\"><span class=\"crayon-v\">FORM_URL</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">https</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//username.typeform.com/to/123456</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de2140193569-5\"><span class=\"crayon-v\">FORM_FIELD_TYPE</span><span class=\"crayon-o\">=</span><span class=\"crayon-e\">email</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de2140193569-6\"><span class=\"crayon-v\">FORM_FIELD_REF</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">e8bafec6</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">5...ee</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">21bfe1254e81</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de2140193569-7\">&nbsp;</div></div></td></tr></tbody></table>\n\nNow, going back to your webhook route at `routes/webhook.js` and edit it to include code that will extract the email address.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">//... require('dotenv').config(); /* POST webhook generates a magic link email to the provided email address */ router.post('/magiclink', (req, res, next) =&gt; { // find answers from the typeform response let { answers } = req.body.form_response; const answer = answers .find(answer =&gt; process.env.FORM_FIELD_TYPE === answer.type &amp;&amp; answer.field.ref === process.env.FORM_FIELD_REF); // it'll probably be an email const email = answer[process.env.FORM_FIELD_TYPE]; console.log(email); // always return a response... res.sendStatus(200); });</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de3528240372-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de3528240372-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de3528240372-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de3528240372-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de3528240372-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de3528240372-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de3528240372-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de3528240372-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de3528240372-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de3528240372-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de3528240372-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de3528240372-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de3528240372-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de3528240372-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de3528240372-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de3528240372-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de3528240372-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de3528240372-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de3528240372-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de3528240372-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de3528240372-21\">21</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de3528240372-1\"><span class=\"crayon-c\">//...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de3528240372-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de3528240372-3\"><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'dotenv'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">config</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de3528240372-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de3528240372-5\"><span class=\"crayon-c\">/* POST webhook generates a magic link email to the provided email address */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de3528240372-6\"><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/magiclink'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de3528240372-7\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// find answers from the typeform response</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de3528240372-8\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-e\">let</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">answers</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">body</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">form_response</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de3528240372-9\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de3528240372-10\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">answers</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de3528240372-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">find</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">answer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">FORM_FIELD_TYPE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">field</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ref</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">FORM_FIELD_REF</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de3528240372-12\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de3528240372-13\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// it'll probably be an email</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de3528240372-14\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">email</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">FORM_FIELD_TYPE</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de3528240372-15\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de3528240372-16\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">email</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de3528240372-17\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de3528240372-18\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// always return a response...</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de3528240372-19\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sendStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de3528240372-20\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de3528240372-21\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis code will find an answer of type `email` type with the matching **Question reference** (just in case you capture more than one email address in your form!) and finally returns the value of the answer. The type and reference were set in the `.env` file.\n\nThe output of this will be the string submitted to the Typeform question.\n\n## Store Users\n\nThis tutorial will continue to assume you’re only capturing a single email field from Typeform and no further user information. It will store other derived information on the user as it is created.\n\nYou’ll use [Mongoose](https://mongoosejs.com) for storing your users in the database. Mongoose provides a straight-forward, schema-based solution to model your application data. It includes built-in type casting, validation, query building, business logic hooks and more, out of the box.\n\n### Install Mongoose\n\nTo capture user creation and details, install `mongoose` to your project.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm install mongoose</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de4664434610-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de4664434610-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de4664434610-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-e\">install </span><span class=\"crayon-i\">mongoose</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de4664434610-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Configure MongoDB Connection\n\nConfigure the project so that Mongoose will be able to connect to the MongoDB database. This guide uses default _MacOS_ values, which could differ from what you need, all depending on the development environment you’re using.\n\nEdit `.env` and add the following configuration.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\"># ... port and typeform etc # mongodb config MONGO_URL=mongodb://127.0.0.1:27017/your-database-name</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de5863236565-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de5863236565-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de5863236565-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de5863236565-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de5863236565-5\">5</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de5863236565-1\"><span class=\"crayon-p\"># ... port and typeform etc</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de5863236565-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de5863236565-3\"><span class=\"crayon-p\"># mongodb config</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de5863236565-4\"><span class=\"crayon-v\">MONGO_URL</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">mongodb</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//127.0.0.1:27017/your-database-name</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de5863236565-5\">&nbsp;</div></div></td></tr></tbody></table>\n\nYou can decide `your-database-name` here, because it will create it if it doesn’t already exist.\n\n### Connect to MongoDB\n\nNow, configure your application to connect to Mongoose when it is run by editing the `bin/www` file and placing this code at the end.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">/** * Database config */ const mongoose = require('mongoose'); // Set mongoose promises to global mongoose.Promise = global.Promise // Set up default mongoose connection mongoose.connect(process.env.MONGO_URL, { useNewUrlParser: true, useUnifiedTopology: true, useFindAndModify: false }); // Get the default connection const db = mongoose.connection; // Bind connection to error event (to get notification of connection errors) db.on('error', onError);</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de6229550742-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de6229550742-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de6229550742-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de6229550742-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de6229550742-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de6229550742-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de6229550742-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de6229550742-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de6229550742-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de6229550742-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de6229550742-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de6229550742-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de6229550742-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de6229550742-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de6229550742-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de6229550742-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de6229550742-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de6229550742-18\">18</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de6229550742-1\"><span class=\"crayon-c\">/**</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de6229550742-2\"><span class=\"crayon-c\">* Database config</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de6229550742-3\"><span class=\"crayon-c\">*/</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de6229550742-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de6229550742-5\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mongoose</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'mongoose'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de6229550742-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de6229550742-7\"><span class=\"crayon-c\">// Set mongoose promises to global</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de6229550742-8\"><span class=\"crayon-v\">mongoose</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Promise</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">global</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Promise</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de6229550742-9\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de6229550742-10\"><span class=\"crayon-c\">// Set up default mongoose connection</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de6229550742-11\"><span class=\"crayon-v\">mongoose</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">connect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">MONGO_URL</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">useNewUrlParser</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">useUnifiedTopology</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">useFindAndModify</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de6229550742-12\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de6229550742-13\"><span class=\"crayon-c\">// Get the default connection</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de6229550742-14\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">db</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mongoose</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">connection</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de6229550742-15\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de6229550742-16\"><span class=\"crayon-c\">// Bind connection to error event (to get notification of connection errors)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de6229550742-17\"><span class=\"crayon-v\">db</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">on</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'error'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">onError</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"></span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de6229550742-18\">&nbsp;</div></div></td></tr></tbody></table>\n\n### User Schema and Model\n\nEverything in Mongoose starts with a Schema. Each schema maps to a MongoDB collection and defines the shape of the documents within that collection. While MongoDB is Schema-less, Mongoose uses Schema’s to formalise the standard object before modification.\n\nCreate a new file for the schema at `schemas/user.js` and add the following code.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">const mongoose = require('mongoose'); const Schema = mongoose.Schema; const UserSchema = new Schema({ name: { type: String, required: true }, display_name: { type: String, required: true }, email: { type: String, required: true }, user_id: { type: String }, member_id: { type: String } }); module.exports = UserSchema;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de7744229680-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de7744229680-26\">26</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mongoose</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'mongoose'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-2\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Schema</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mongoose</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Schema</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-4\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">UserSchema</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Schema</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-5\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">String</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">required</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-8\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-9\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">display_name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">String</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">required</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-12\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-13\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">email</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">String</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">required</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-16\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-17\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">user_id</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">String</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-19\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-20\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">member_id</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">String</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-22\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-23\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-24\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de7744229680-25\"><span class=\"crayon-v\">module</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">exports</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">UserSchema</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de7744229680-26\">&nbsp;</div></div></td></tr></tbody></table>\n\nA model is what is used to create documents that you can use to create, edit, update and delete items on a MongoDB collection. Create a new file for the model at `models/user.js` and add the following code.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">const mongoose = require('mongoose'); const UserSchema = require('../schemas/user'); const User = mongoose.model('User', UserSchema); module.exports = User;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de8063247250-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de8063247250-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de8063247250-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de8063247250-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de8063247250-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de8063247250-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de8063247250-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de8063247250-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mongoose</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'mongoose'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de8063247250-2\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">UserSchema</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'../schemas/user'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de8063247250-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de8063247250-4\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">User</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mongoose</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">model</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'User'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">UserSchema</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de8063247250-5\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de8063247250-6\"><span class=\"crayon-v\">module</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">exports</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">User</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de8063247250-7\">&nbsp;</div></div></td></tr></tbody></table>\n\nNotice how the model includes the schema to return a `User` document.\n\n### Finding and Saving Users\n\nIn this instance, you’re going to use the email as your users string identifier, or username. Their email address will eventually also become their display name. You could choose to capture both of these things individually on your Typeform if you wished.\n\nEdit `routes/webhook.js` and add the following code to find users by their username and create them if they don’t already exist.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">//... var User = require('../models/user'); /* POST webhook generates a magic link email to the provided email address */ router.post('/magiclink', (req, res, next) =&gt; { // ... User.findOne({ name: email }, (err, user) =&gt; { // error handling here // if our user is new, save it and output it if (null === user) { user = new User({ name: email, email: email, display_name: email }); user.save((err) =&gt; { // error handling here console.log(user); res.sendStatus(200); }); // otherwise, just output it } else { console.log(user); res.sendStatus(200); } }); });</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07de9078573122-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07de9078573122-35\">35</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-1\"><span class=\"crayon-c\">//...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-2\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">User</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'../models/user'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-4\"><span class=\"crayon-c\">/* POST webhook generates a magic link email to the provided email address */</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-5\"><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/magiclink'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-6\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-8\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">User</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">findOne</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">email</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// error handling here</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// if our user is new, save it and output it</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">user</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">User</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">email</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">email</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">email</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">display_name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">email</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-18\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">save</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// error handling here</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-21\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-23\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sendStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-26\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// otherwise, just output it</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-30\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sendStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-33\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07de9078573122-34\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07de9078573122-35\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis code is going to attempt to find a user by their email address, creating one if one didn’t already exist. This doesn’t support updating an existing user. If they already existed, you could error. Later, we’ll generate a magic link to login, rather than give them an error.\n\n## Generate a Magic Link\n\nYour webhook is going to email your user a magic link that can be used to authenticate them with the service.\n\nInstall `jsonwebtoken` using npm.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm install jsonwebtoken</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dea873519848-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dea873519848-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dea873519848-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-e\">install </span><span class=\"crayon-i\">jsonwebtoken</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dea873519848-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nEdit `.env` to create a secret key that can be used for token generation.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\"># ... port etc SECRET=whatever-you-want-it-be-a-b-c-1-2-3 # ... typeform and mongo etc</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07deb115688966-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07deb115688966-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07deb115688966-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07deb115688966-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07deb115688966-5\">5</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07deb115688966-1\"><span class=\"crayon-p\"># ... port etc</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07deb115688966-2\"><span class=\"crayon-v\">SECRET</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">whatever</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">you</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">want</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">it</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">be</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">a</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">b</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">c</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">2</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">3</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07deb115688966-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07deb115688966-4\"><span class=\"crayon-p\"># ... typeform and mongo etc</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07deb115688966-5\">&nbsp;</div></div></td></tr></tbody></table>\n\nSo, now edit `routes/webhook.js` to generate the magic link and output it to the server.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">//... var jwt = require('jsonwebtoken'); var createMagicLink = (req, payload) =&gt; { var token = jwt.sign(payload, process.env.SECRET); return `${req.protocol}://${req.get('host')}/auth?token=${token}`; } /* POST webhook generates a magic link email to the provided email address */ router.post('/magiclink', (req, res, next) =&gt; { // ... // ... if (null === user) { // ... user.save((err) =&gt; { // ... console.log(createMagicLink(req, user.toObject())); res.sendStatus(200); }); // otherwise, just output it } else { console.log(createMagicLink(req, user.toObject()); res.sendStatus(200); } // ... });</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dec697426427-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dec697426427-40\">40</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-1\"><span class=\"crayon-c\">//...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-3\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'jsonwebtoken'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-5\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">createMagicLink</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">payload</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-6\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">token</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sign</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">payload</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">SECRET</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-8\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">protocol</span><span class=\"crayon-sy\">}</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//${req.get('host')}/auth?token=${token}`;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-9\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-11\"><span class=\"crayon-c\">/* POST webhook generates a magic link email to the provided email address */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-12\"><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/magiclink'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-13\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-14\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-15\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-17\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-19\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-21\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">save</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-24\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">createMagicLink</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">toObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-26\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sendStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-29\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// otherwise, just output it</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">createMagicLink</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">toObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-33\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sendStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-36\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-37\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-38\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dec697426427-39\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dec697426427-40\">&nbsp;</div></div></td></tr></tbody></table>\n\nWe’re adding a JWT to a magic link URL as a method for identifying the user when they try to access the site.\n\n> It’s important to note that a JWT guarantees data ownership, not encryption. It’s a URL-safe way of representing claims by encoding them as JSON objects which can be digitally signed or encrypted. Digitally signing a JWT allows validation against modifications. Encryption, on the other hand, makes sure the content of the JWT is only readable by certain parties.\n\nIn this instance, the guide doesn’t use RSA or other asymmetric encryption, choosing only to sign the data instead using the JWT library’s default HMAC SHA256 synchronous signing.\n\nUsing a JWT in this way verifies the magic link originated from your application, signed by your `SECRET` and cannot be modified.\n\nWhen you submit data to the webhook from Typeform now, the output should be a link to the application that looks like a much longer version of this:\n\n[https://.ngrok.io/webhooks/auth?token=eyJhbCJ9.eyEflLxN.N9eq6b5o](https://your_url.ngrok.io/webhooks/auth?token=eyJhbCJ9.eyEflLxN.N9eq6b5o)\n\nClick the link for a 404 error. Let’s fix that.\n\n![Magic link 404s](https://www.nexmo.com/wp-content/uploads/2019/11/auth_url_404.png)\n\n## Authenticate with Passport.js\n\n[Passport.js](http://www.passportjs.org/) describes itself as unobtrusive authentication for Node.js. It is incredibly flexible and modular and can be unobtrusively dropped into an application like this.\n\n### Install Passport.js\n\nInstall `passport`, the `passport-jwt` strategy and `express-session` so it can be used for authentication and maintaining a session.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm install passport passport-jwt express-session</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dee364255332-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dee364255332-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dee364255332-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-e\">install </span><span class=\"crayon-e\">passport </span><span class=\"crayon-v\">passport</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">jwt </span><span class=\"crayon-v\">express</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">session</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dee364255332-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Create an Authentication Endpoint\n\nCreate a new file named `routes/auth.js` with this source code.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">var express = require('express'); var router = express.Router(); /* GET authenticate user with magic link and direct to home */ router.get('/', (req, res, next) =&gt; { res.redirect(req.protocol + '://' + req.get('host') + '/'); }); module.exports = router;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def756664783-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def756664783-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def756664783-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def756664783-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def756664783-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def756664783-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def756664783-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def756664783-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def756664783-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def756664783-10\">10</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def756664783-1\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">express</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'express'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def756664783-2\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">router</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">express</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Router</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def756664783-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def756664783-4\"><span class=\"crayon-c\">/* GET authenticate user with magic link and direct to home */</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def756664783-5\"><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def756664783-6\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">redirect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">protocol</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'://'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'host'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'/'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def756664783-7\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def756664783-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def756664783-9\"><span class=\"crayon-v\">module</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">exports</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def756664783-10\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis router is going to redirect you to the homepage. You’ll only reach this router, though, if you’re authorised by the JWT when you request the page.\n\nEdit `app.js` and add this code to add passport authentication to a new auth route.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">// ... var indexRouter = require('./routes/index'); var webhookRouter = require('./routes/webhook'); var authRouter = require('./routes/auth'); // ... var User = require('./models/user'); var session = require('express-session'); var passport = require('passport'); var jwtStrategy = require('passport-jwt').Strategy; var jwtExtractor = require('passport-jwt').ExtractJwt; app.use(session({ secret: process.env.SECRET, resave: true, saveUninitialized: true })); app.use(passport.initialize()); app.use(passport.session()); passport.serializeUser((user, done) =&gt; { done(null, user._id); }); passport.deserializeUser((id, done) =&gt; { User.findById(id, (err, user) =&gt; { done(err, user); }); }); passport.use(new jwtStrategy({ jwtFromRequest: jwtExtractor.fromUrlQueryParameter('token'), secretOrKey: process.env.SECRET }, (payload, done) =&gt; { return done(null, payload); })) app.use('/', indexRouter); app.use('/webhooks', webhookRouter); app.use('/auth', passport.authenticate('jwt', { session: true }), authRouter); // ...</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07def682592907-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07def682592907-46\">46</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-1\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-3\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">indexRouter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'./routes/index'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-4\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">webhookRouter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'./routes/webhook'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-5\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">authRouter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'./routes/auth'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-7\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-9\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">User</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'./models/user'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-10\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">session</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'express-session'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-11\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">passport</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'passport'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-12\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwtStrategy</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'passport-jwt'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Strategy</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-13\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwtExtractor</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'passport-jwt'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ExtractJwt</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-14\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-15\"><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">use</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">session</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"></span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-16\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">secret</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">SECRET</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-17\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">resave</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-18\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">saveUninitialized</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-19\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-20\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-21\"><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">use</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">passport</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">initialize</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-22\"><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">use</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">passport</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">session</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-23\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-24\"><span class=\"crayon-v\">passport</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">serializeUser</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">done</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-25\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-e\">done</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">_id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-26\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-27\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-28\"><span class=\"crayon-v\">passport</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">deserializeUser</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">done</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-29\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">User</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">findById</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">done</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-31\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-32\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-33\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-34\"><span class=\"crayon-v\">passport</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">use</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">jwtStrategy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"></span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-35\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">jwtFromRequest</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwtExtractor</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">fromUrlQueryParameter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'token'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-36\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">secretOrKey</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">SECRET</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-37\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">payload</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">done</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-38\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">done</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">payload</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-39\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-40\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-41\"><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">use</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">indexRouter</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-42\"><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">use</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/webhooks'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">webhookRouter</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-43\"><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">use</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/auth'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">passport</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">authenticate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'jwt'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">session</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">authRouter</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-44\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07def682592907-45\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07def682592907-46\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis code will authenticate any request to the `/auth` endpoint using the JWT extractor from `passport-jwt` strategy. It will try to validate the `token` from a query string parameter.\n\nOnce authenticated, the application will create a session and the user data becomes available as `req.user`.\n\nTo test this, edit `routes/index.js` and add this code before the `res.render()` line.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">console.log(req.user);</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df1065268164-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df1065268164-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df1065268164-1\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df1065268164-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nNow, restart the application and generate a magic link using your Typeform request. When you click on the link, you’re redirected back to the chat after authentication. But in your console, you’ll have output some user data that looks like this:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">{ _id: 5dd0215a03174a4d8b920952, name: 'luke.oliff@vonage.com', email: 'luke.oliff@vonage.com', display_name: 'luke.oliff@vonage.com', member_id: null, user_id: null, __v: 0 }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df2753542677-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df2753542677-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df2753542677-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df2753542677-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df2753542677-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df2753542677-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df2753542677-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df2753542677-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df2753542677-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df2753542677-10\">10</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df2753542677-1\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df2753542677-2\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">_id</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">5dd0215a03174a4d8b920952</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df2753542677-3\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'luke.oliff@vonage.com'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df2753542677-4\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">email</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'luke.oliff@vonage.com'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df2753542677-5\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">display_name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'luke.oliff@vonage.com'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df2753542677-6\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">member_id</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df2753542677-7\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">user_id</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df2753542677-8\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">__v</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df2753542677-9\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df2753542677-10\">&nbsp;</div></div></td></tr></tbody></table>\n\n![Logged in but nothing has changed](https://www.nexmo.com/wp-content/uploads/2019/11/logged_in_looks_the_same.png)\n\nMake sure no one can access the chat, unless they’re authenticated, by editing the `routes/index.js` to look exactly like this.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">var express = require('express'); var router = express.Router(); require('dotenv').config(); var isAuthenticated = (req, res, next) =&gt; { if(req.isAuthenticated()){ next(); } else{ res.redirect(process.env.FORM_URL); } } /* GET home */ router.get('/', isAuthenticated, (req, res, next) =&gt; { res.render('index', { title: 'Nexmo Typeform Chat', user: req.user.display_name }); }); module.exports = router;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df3676583112-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df3676583112-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df3676583112-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df3676583112-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df3676583112-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df3676583112-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df3676583112-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df3676583112-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df3676583112-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df3676583112-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df3676583112-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df3676583112-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df3676583112-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df3676583112-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df3676583112-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df3676583112-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df3676583112-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df3676583112-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df3676583112-19\">19</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df3676583112-1\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">express</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'express'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df3676583112-2\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">router</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">express</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Router</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df3676583112-3\"><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'dotenv'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">config</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df3676583112-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df3676583112-5\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">isAuthenticated</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df3676583112-6\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">isAuthenticated</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df3676583112-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">next</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df3676583112-8\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df3676583112-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">redirect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">FORM_URL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df3676583112-10\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df3676583112-11\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df3676583112-12\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df3676583112-13\"><span class=\"crayon-c\">/* GET home */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df3676583112-14\"><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">isAuthenticated</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df3676583112-15\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">render</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'index'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">title</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Nexmo Typeform Chat'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">display</span><span class=\"crayon-sy\">_</span>name<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df3676583112-16\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df3676583112-17\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df3676583112-18\"><span class=\"crayon-v\">module</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">exports</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df3676583112-19\">&nbsp;</div></div></td></tr></tbody></table>\n\nRemoving the console.log output you just added above; the chat will no longer log the current user data to console. Instead, the display name is added to the scope of the templates to render. This change will also redirect to the Typeform if they’re not logged in.\n\nEdit `views/layout.hbs` and output the display name. Find `username` and replace it with `{{user}}`, the surrounding code should end up looking like this.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">&lt;ul class=\"nav flex-column\"&gt; &lt;li class=\"nav-item\"&gt; &lt;a class=\"nav-link active\" href=\"#\"&gt; &lt;span data-feather=\"home\"&gt;&lt;/span&gt; {{user}} &lt;/a&gt; &lt;/li&gt; &lt;/ul&gt;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df4036947910-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df4036947910-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df4036947910-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df4036947910-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df4036947910-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df4036947910-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df4036947910-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df4036947910-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df4036947910-9\">9</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df4036947910-1\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">ul </span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"nav flex-column\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df4036947910-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">li </span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"nav-item\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df4036947910-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-i\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"nav-link active\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">href</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"#\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df4036947910-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">span </span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">feather</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"home\"</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">span</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df4036947910-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df4036947910-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">a</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df4036947910-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">li</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df4036947910-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">ul</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df4036947910-9\">&nbsp;</div></div></td></tr></tbody></table>\n\nWhen they’re logged in, let’s also show the members of chat (out of the database) on the page. Edit `routes/index.js` and wrap the `res.render` in the `User.find` which returns all the registered users.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">// ... var User = require('../models/user'); // ... /* GET home */ router.get('/', isAuthenticated, (req, res, next) =&gt; { User.find((err, users) =&gt; { res.render('index', { title: 'Nexmo Typeform Chat', members: users, user: req.user.display_name }); }) });</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df5701856752-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df5701856752-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df5701856752-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df5701856752-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df5701856752-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df5701856752-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df5701856752-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df5701856752-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df5701856752-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df5701856752-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df5701856752-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df5701856752-12\">12</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df5701856752-1\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df5701856752-2\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">User</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'../models/user'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df5701856752-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df5701856752-4\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df5701856752-5\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df5701856752-6\"><span class=\"crayon-c\">/* GET home */</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df5701856752-7\"><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">isAuthenticated</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df5701856752-8\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">User</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">find</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">users</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df5701856752-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">render</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'index'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">title</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Nexmo Typeform Chat'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">members</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">users</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">display</span><span class=\"crayon-sy\">_</span>name<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df5701856752-10\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df5701856752-11\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df5701856752-12\">&nbsp;</div></div></td></tr></tbody></table>\n\nEdit `views/layout.hbs` again and find this entire block:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">{{!-- {{#each members}} --}} &lt;li class=\"nav-item\"&gt; &lt;a class=\"nav-link text-muted\" href=\"#\"&gt; &lt;span data-feather=\"file-text\"&gt;&lt;/span&gt; other member &lt;/a&gt; &lt;/li&gt; {{!-- {{/each}} --}}</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df6306782925-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df6306782925-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df6306782925-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df6306782925-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df6306782925-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df6306782925-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df6306782925-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df6306782925-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df6306782925-9\">9</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df6306782925-1\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-o\">!</span><span class=\"crayon-o\">--</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-p\">#each members}} --}}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df6306782925-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">li </span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"nav-item\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df6306782925-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-i\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"nav-link text-muted\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">href</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"#\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df6306782925-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">span </span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">feather</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"file-text\"</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">span</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df6306782925-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">other</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">member</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df6306782925-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">a</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df6306782925-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">li</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df6306782925-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-o\">!</span><span class=\"crayon-o\">--</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-o\">/</span><span class=\"crayon-st\">each</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df6306782925-9\">&nbsp;</div></div></td></tr></tbody></table>\n\nReplace it with this functional code.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">{{#each members}} &lt;li class=\"nav-item\"&gt; &lt;a class=\"nav-link text-muted\" href=\"#\"&gt; &lt;span data-feather=\"file-text\"&gt;&lt;/span&gt; {{this.display_name}} &lt;/a&gt; &lt;/li&gt; {{/each}}</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df7134220214-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df7134220214-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df7134220214-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df7134220214-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df7134220214-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df7134220214-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df7134220214-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df7134220214-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df7134220214-9\">9</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df7134220214-1\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-p\">#each members}}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df7134220214-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">li </span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"nav-item\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df7134220214-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-i\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"nav-link text-muted\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">href</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"#\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df7134220214-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">span </span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">feather</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"file-text\"</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">span</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df7134220214-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">display_name</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df7134220214-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">a</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df7134220214-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">li</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df7134220214-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-o\">/</span><span class=\"crayon-st\">each</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df7134220214-9\">&nbsp;</div></div></td></tr></tbody></table>\n\nRestart the application and access it once again through your magic link. Now, you should see some user information on the page.\n\n![Logged in with user info](https://www.nexmo.com/wp-content/uploads/2019/11/logged_in_with_user_info.png)\n\nYou’re still accessing chat on the using the hardcoded test data. It’s time to register your users to Nexmo and let them access the conversation, too.\n\n## Get Registered Users Chatting on Nexmo\n\nAt the moment you have users signing up but only using the chat through your hardcoded user information.\n\n### Install and Configure Nexmo Node\n\nAt this point, you’re going to start interacting with the Nexmo service from within your node application for the first time.\n\nInstall `nexmo` now with this command.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm install nexmo@beta</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df8715241755-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df8715241755-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df8715241755-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-e\">install </span><span class=\"crayon-v\">nexmo</span><span class=\"crayon-sy\">@</span><span class=\"crayon-i\">beta</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df8715241755-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nConfigure some variables for Nexmo inside your environment file `.env`. You’ll need the same API key and secret you used to configure `nexmo-cli` at the very start. You’ll also need the application ID and private key path from when you ran `nexmo app:create`, as well as the conversation ID from when you ran `nexmo conversation:create`.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\"># ... app, typeform and mongodb etc # nexmo config NEXMO_API_KEY=&lt;your_api_key&gt; NEXMO_API_SECRET=&lt;your_api_secret&gt; NEXMO_APP_ID=4556dbae-bf...f6e33350d8 NEXMO_PRIVATE_KEY_PATH=./private.key NEXMO_CONVERSATION_ID=CON-a57b0...11e57f56d</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df9121956186-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df9121956186-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df9121956186-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df9121956186-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df9121956186-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df9121956186-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df9121956186-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07df9121956186-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07df9121956186-9\">9</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df9121956186-1\"><span class=\"crayon-p\"># ... app, typeform and mongodb etc</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df9121956186-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df9121956186-3\"><span class=\"crayon-p\"># nexmo config</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df9121956186-4\"><span class=\"crayon-v\">NEXMO_API_KEY</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">your_api_key</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df9121956186-5\"><span class=\"crayon-v\">NEXMO_API_SECRET</span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">your_api_secret</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df9121956186-6\"><span class=\"crayon-v\">NEXMO_APP_ID</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">4556dbae</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">bf</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">f6e33350d8</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df9121956186-7\"><span class=\"crayon-v\">NEXMO_PRIVATE_KEY_PATH</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-m\">private</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">key</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07df9121956186-8\"><span class=\"crayon-v\">NEXMO_CONVERSATION_ID</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">CON</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">a57b0</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-cn\">11e57f56d</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07df9121956186-9\">&nbsp;</div></div></td></tr></tbody></table>\n\nCreate a utility file at `util/nexmo.js` that is going to configure the `nexmo` library.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">const Nexmo = require('nexmo'); require('dotenv').config(); let options = {}; module.exports = new Nexmo({ apiKey: process.env.NEXMO_API_KEY, apiSecret: process.env.NEXMO_API_SECRET, applicationId: process.env.NEXMO_APP_ID, privateKey: process.env.NEXMO_PRIVATE_KEY_PATH }, options);</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfa468595305-12\">12</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfa468595305-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'nexmo'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfa468595305-2\"><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'dotenv'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">config</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfa468595305-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfa468595305-4\"><span class=\"crayon-e\">let </span><span class=\"crayon-v\">options</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfa468595305-5\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfa468595305-6\"><span class=\"crayon-v\">module</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">exports</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Nexmo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfa468595305-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">apiKey</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NEXMO_API_KEY</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfa468595305-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">apiSecret</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NEXMO_API_SECRET</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfa468595305-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">applicationId</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NEXMO_APP_ID</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfa468595305-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NEXMO_PRIVATE_KEY</span><span class=\"crayon-sy\">_</span>PATH</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfa468595305-11\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfa468595305-12\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Create Nexmo User\n\nFirst thing is first, you need to create a Nexmo user in parallel to your local user when they sign up.\n\nEdit `routes/webhook.js` and completely replace the file with this code:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">var express = require('express'); var router = express.Router(); var jwt = require('jsonwebtoken'); require('dotenv').config(); var User = require('../models/user'); var nexmo = require('../util/nexmo'); var createMagicLink = (req, payload) =&gt; { var token = jwt.sign(payload, process.env.SECRET); return `${req.protocol}://${req.get('host')}/auth?token=${token}`; } /* POST webhook generates a magic link email to the provided email address */ router.post('/magiclink', (req, res, next) =&gt; { // find answers from the typeform response let { answers } = req.body.form_response; const answer = answers .find(answer =&gt; process.env.FORM_FIELD_TYPE === answer.type &amp;&amp; answer.field.ref === process.env.FORM_FIELD_REF); // it'll probably be an email const email = answer[process.env.FORM_FIELD_TYPE]; User.findOne({ name: email }, (err, user) =&gt; { // error handling here // if we can't find an existing user, prepare a new user document if (null === user) { user = new User({ name: email, email: email, display_name: email }); } if (null === user.user_id) { nexmo.users.create(user.toObject(), (err, nexmoUser) =&gt; { // error handling here user.user_id = nexmoUser.id; nexmo.conversations.members.create(process.env.NEXMO_CONVERSATION_ID, { action: 'join', user_id: nexmoUser.id, channel: { type: 'app' } }, (err, member) =&gt; { // error handling here user.member_id = member.id; user.save((err) =&gt; { // error handling here console.log(createMagicLink(req, user.toObject())); res.sendStatus(200); }); }); }); } else { console.log(createMagicLink(req, user.toObject())); res.sendStatus(200); } }); }); module.exports = router;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfb269115494-71\">71</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-1\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">express</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'express'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-2\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">router</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">express</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Router</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-3\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'jsonwebtoken'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-4\"><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'dotenv'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">config</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-5\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-6\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">User</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'../models/user'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-7\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nexmo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'../util/nexmo'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-9\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">createMagicLink</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">payload</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-10\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">token</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sign</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">payload</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">SECRET</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-11\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-12\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">protocol</span><span class=\"crayon-sy\">}</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//${req.get('host')}/auth?token=${token}`;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-13\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-14\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-15\"><span class=\"crayon-c\">/* POST webhook generates a magic link email to the provided email address */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-16\"><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/magiclink'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-17\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// find answers from the typeform response</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-18\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-e\">let</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">answers</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">body</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">form_response</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-19\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-20\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">answers</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">find</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">answer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">FORM_FIELD_TYPE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">field</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ref</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">FORM_FIELD_REF</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-22\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-23\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// it'll probably be an email</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-24\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">email</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">FORM_FIELD_TYPE</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-25\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-26\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">User</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">findOne</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">email</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// error handling here</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-28\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// if we can't find an existing user, prepare a new user document</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">user</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">User</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">email</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">email</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">email</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">display_name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">email</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-36\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-37\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user_id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">nexmo</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">users</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">create</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">toObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nexmoUser</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-40\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// error handling here</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-41\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-42\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nexmoUser</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-43\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-44\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">nexmo</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">conversations</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">members</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">create</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NEXMO_CONVERSATION_ID</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-45\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">action</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'join'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-46\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">user_id</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nexmoUser</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-47\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">channel</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'app'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-48\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">member</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-49\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// error handling here</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-50\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-51\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">member_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">member</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-52\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-53\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">save</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-54\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// error handling here</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-55\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-56\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">createMagicLink</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">toObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-57\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-58\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sendStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-59\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-60\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-61\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-62\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-63\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">createMagicLink</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">toObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-64\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-65\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sendStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-66\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-67\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-68\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-69\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfb269115494-70\"><span class=\"crayon-v\">module</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">exports</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfb269115494-71\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis new webhook code is going to check for a database user and create one where it’s new, just as it had before. But now, it will create a Nexmo user and connect the user to the conversation, updating their database record with the Nexmo user ID and a member ID.\n\nRestart the application and generate a new magic link for your user. Click it to authenticate. It will now see there is no Nexmo user, create one, add it to the conversation, and save it to the user record.\n\nWhen redirected to the chat application, you’ll now see that your created user has joined the conversation. You’re still chatting as your hardcoded user, though.\n\n![New user joins the conversation](https://www.nexmo.com/wp-content/uploads/2019/11/new_user_joins_conversation.png)\n\n### Generate a Token for the Client SDK\n\nYour users can sign up, login and even join the conversation. But right now, they’ll only chat using hardcoded user data. It’s time to fix that and allow them to talk as themselves.\n\nOpen `routes/index.js` and create a new route `/jwt`, because primarily you’ll expose a new JWT specifically for the Nexmo service, usable by the Client SDK.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">// ... var nexmo = require('../util/nexmo'); /* GET home */ // ... /* GET user data and jwt */ router.get('/jwt', isAuthenticated, (req, res, next) =&gt; { const aclPaths = { \"paths\": { \"/*/users/**\": {}, \"/*/conversations/**\": {}, \"/*/sessions/**\": {}, \"/*/devices/**\": {}, \"/*/image/**\": {}, \"/*/media/**\": {}, \"/*/applications/**\": {}, \"/*/push/**\": {}, \"/*/knocking/**\": {} } }; const expires_at = new Date(); expires_at.setDate(expires_at.getDate() + 1); const jwt = nexmo.generateJwt({ application_id: process.env.NEXMO_APP_ID, sub: req.user.name, exp: Math.round(expires_at/1000), acl: aclPaths }); res.json({ user_id: req.user.user_id, name: req.user.name, member_id: req.user.member_id, display_name: req.user.display_name, client_token: jwt, conversation_id: process.env.NEXMO_CONVERSATION_ID, expires_at: expires_at }); }) // ...</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07dfc896905397-45\">45</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-1\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-2\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nexmo</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'../util/nexmo'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-4\"><span class=\"crayon-c\">/* GET home */</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-5\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-7\"><span class=\"crayon-c\">/* GET user data and jwt */</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-8\"><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/jwt'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">isAuthenticated</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-9\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">aclPaths</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"paths\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"/*/users/**\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"/*/conversations/**\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"/*/sessions/**\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"/*/devices/**\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"/*/image/**\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"/*/media/**\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"/*/applications/**\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"/*/push/**\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"/*/knocking/**\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-21\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-22\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-23\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">expires_at</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Date</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-24\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">expires_at</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">setDate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">expires_at</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">getDate</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-25\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-26\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">nexmo</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">generateJwt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">application_id</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NEXMO_APP_ID</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">sub</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">exp</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Math</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">round</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">expires_at</span><span class=\"crayon-o\">/</span><span class=\"crayon-cn\">1000</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">acl</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">aclPaths</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-31\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-32\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-33\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">json</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">user_id</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user_id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">name</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-36\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">member_id</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">member_id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">display_name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">display_name</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">client_token</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">conversation_id</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NEXMO_CONVERSATION_ID</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-40\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">expires_at</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">expires</span><span class=\"crayon-sy\">_</span>at</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-41\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-42\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-43\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07dfc896905397-44\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07dfc896905397-45\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis new route uses the users existing session to provide data to the browser. The homepage provides this as HTML, but this new endpoint returns JSON.\n\nRestart the application, follow the magic link and then browse to `https://<your_url>.ngrok.io/jwt`. You’ll see information based on your current user, including a `client_token` to use in the Client SDK.\n\n![JWT endpoint shares client token](https://www.nexmo.com/wp-content/uploads/2019/11/jwt_endpoint_shares_user_token.png)\n\n### Remove the Hardcoded Configuration\n\nIt is time to stop hardcoding config inside the application. Edit the `views/layout.hbs` file, finding the configuration you added inside the `<script>` tags. It looked something like this.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">&lt;script&gt; var userName = 'luke.oliff@vonage.com'; var displayName = 'Luke Oliff'; var conversationId = 'CON-123...y6346'; var clientToken = 'eyJhbG9.eyJzdWIiO.Sfl5c'; &lt;/script&gt;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e03610428223-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e03610428223-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e03610428223-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e03610428223-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e03610428223-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e03610428223-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e03610428223-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e03610428223-1\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-ta\">&lt;script&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e03610428223-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">userName</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'luke.oliff@vonage.com'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e03610428223-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">displayName</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Luke Oliff'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e03610428223-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">conversationId</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'CON-123...y6346'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e03610428223-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-e \">clientToken</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'eyJhbG9.eyJzdWIiO.Sfl5c'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e03610428223-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-ta\">&lt;/script&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e03610428223-7\">&nbsp;</div></div></td></tr></tbody></table>\n\nDelete the script tags and their contents, totally.\n\nIf you want to see what it’s done to your app, restart and authenticate to find that it’s almost back to the very beginning, with broken chat. At least you’re still logged in!\n\n![Logged in with broken chat](https://www.nexmo.com/wp-content/uploads/2019/11/logged_in_broken_chat_again.png)\n\n### Request User Client Token\n\nYou can access the user’s client token from a URL as JSON data. So, edit `public/javascripts/chat.js` and change the `authenticateUser` method so that it fetches this data, to use it when connecting to the conversation.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">// ... authenticateUser() { var req = new XMLHttpRequest(); req.responseType = 'json'; req.open('GET', '/jwt', true); var obj = this; req.onload = function() { obj.joinConversation(req.response); }; req.send(null); } // ...</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e04778137825-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e04778137825-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e04778137825-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e04778137825-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e04778137825-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e04778137825-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e04778137825-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e04778137825-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e04778137825-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e04778137825-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e04778137825-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e04778137825-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e04778137825-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e04778137825-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e04778137825-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e04778137825-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e04778137825-17\">17</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e04778137825-1\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e04778137825-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e04778137825-3\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-e\">authenticateUser</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e04778137825-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">req</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">XMLHttpRequest</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e04778137825-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">responseType</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'json'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e04778137825-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">open</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'GET'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'/jwt'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e04778137825-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e04778137825-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">obj</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e04778137825-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">onload</span><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e04778137825-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">joinConversation</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e04778137825-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e04778137825-12\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e04778137825-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">send</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e04778137825-14\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e04778137825-15\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e04778137825-16\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e04778137825-17\">&nbsp;</div></div></td></tr></tbody></table>\n\nRestart the application, authenticate and enjoy a quick game of spot the difference!\n\n![Logged in with Nexmo user](https://www.nexmo.com/wp-content/uploads/2019/11/logged_in_with_nexmo_user.png)\n\nYou see, now you’re logged in as a different user. Messages from other users are formatted differently. So when you join in the conversation, it’ll look like this.\n\n![Chatting with myself](https://www.nexmo.com/wp-content/uploads/2019/11/chatting_with_myself.png)\n\n## Send the Magic Link by Email\n\nYou’ve got a magic link, but it is still output in the console. It is time to send that by email instead.\n\n### Install and Configure an SMTP Library\n\nInstall `nodemailer` now with this command.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm install nodemailer</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e05759968827-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e05759968827-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e05759968827-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-e\">install </span><span class=\"crayon-i\">nodemailer</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e05759968827-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nConfigure some variables for the `nodemailer` library inside your environment file `.env`.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\"># ... app, typeform, mongodb, nexmo etc # smtp config SMTP_HOST= SMTP_PORT= SMTP_AUTH_USER= SMTP_AUTH_PASS=</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e06869146096-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e06869146096-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e06869146096-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e06869146096-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e06869146096-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e06869146096-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e06869146096-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e06869146096-8\">8</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e06869146096-1\"><span class=\"crayon-p\"># ... app, typeform, mongodb, nexmo etc</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e06869146096-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e06869146096-3\"><span class=\"crayon-p\"># smtp config</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e06869146096-4\"><span class=\"crayon-v\">SMTP_HOST</span><span class=\"crayon-o\">=</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e06869146096-5\"><span class=\"crayon-v\">SMTP_PORT</span><span class=\"crayon-o\">=</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e06869146096-6\"><span class=\"crayon-v\">SMTP_AUTH_USER</span><span class=\"crayon-o\">=</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e06869146096-7\"><span class=\"crayon-v\">SMTP_AUTH_PASS</span><span class=\"crayon-o\">=</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e06869146096-8\">&nbsp;</div></div></td></tr></tbody></table>\n\nIf you’re using Google or other well known mail host with 2-Step Verification turned on, you’ll probably need to [setup an application password](https://support.google.com/accounts/answer/185833?hl=en). It will let you authenticate from the application without a need for 2-Step Verification.\n\nCreate a new utility file that will configure `nodemailer` at `util/mailer.js` with this code:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">const mailer = require('nodemailer'); require('dotenv').config(); let options = { host: process.env.SMTP_HOST, port: process.env.SMTP_PORT, secure: true, auth: { user: process.env.SMTP_AUTH_USER, pass: process.env.SMTP_AUTH_PASS } }; module.exports = mailer.createTransport(options);</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e07065436789-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e07065436789-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e07065436789-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e07065436789-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e07065436789-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e07065436789-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e07065436789-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e07065436789-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e07065436789-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e07065436789-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e07065436789-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e07065436789-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e07065436789-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e07065436789-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e07065436789-15\">15</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e07065436789-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mailer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'nodemailer'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e07065436789-2\"><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'dotenv'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">config</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e07065436789-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e07065436789-4\"><span class=\"crayon-e\">let </span><span class=\"crayon-v\">options</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e07065436789-5\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">host</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">SMTP_HOST</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e07065436789-6\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">port</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">SMTP_PORT</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e07065436789-7\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">secure</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e07065436789-8\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">auth</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e07065436789-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">user</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">SMTP_AUTH_USER</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e07065436789-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">pass</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">process</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">env</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">SMTP_AUTH</span><span class=\"crayon-sy\">_</span>PASS</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e07065436789-11\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e07065436789-12\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e07065436789-13\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e07065436789-14\"><span class=\"crayon-v\">module</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">exports</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mailer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">createTransport</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">options</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e07065436789-15\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Send Magic Links by Email\n\nThe final edit of `routes/webhook.js` will be to add the `sendEmail` function and use it to replace the `console.log` commands completely.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">// ... var mailer = require('../util/mailer'); // ... var sendEmail = (magicLink, email) =&gt; { var mailOptions = { to: email, subject: 'Magic Link', text: 'Click to login: ' + magicLink, html: `&lt;a href=\"${magicLink}\"&gt;Click to Login&lt;/a&gt;` }; mailer.sendMail(mailOptions); } /* POST webhook generates a magic link email to the provided email address */ router.post('/magiclink', (req, res, next) =&gt; { // ... if (null === user.user_id) { // ... // ... user.save((err) =&gt; { // ... sendEmail(createMagicLink(req, user.toObject()), user.email); res.sendStatus(200); }); // ... // ... } else { sendEmail(createMagicLink(req, user.toObject()), user.email); res.sendStatus(200); } // ... }); // ...</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e07e08152811086-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e07e08152811086-52\">52</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-1\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-3\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mailer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'../util/mailer'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-5\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-7\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sendEmail</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">magicLink</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">email</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-8\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">mailOptions</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">to</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">email</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">subject</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Magic Link'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">text</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Click to login: '</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">magicLink</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">html</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">`</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-i\">a</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">href</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"${magicLink}\"</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-e\">Click </span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Login</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">a</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">`</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-13\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-14\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-15\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">mailer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sendMail</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">mailOptions</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-16\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-17\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-18\"><span class=\"crayon-c\">/* POST webhook generates a magic link email to the provided email address */</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-19\"><span class=\"crayon-v\">router</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/magiclink'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-20\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-21\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-22\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">null</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">user_id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-24\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-26\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-28\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">save</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">err</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-31\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">sendEmail</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">createMagicLink</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">toObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">email</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-33\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sendStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-36\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-38\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-40\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-41\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">else</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-42\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">sendEmail</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">createMagicLink</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">req</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">toObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">email</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-43\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-44\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">res</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">sendStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">200</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-45\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-46\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-47\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-48\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-49\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-50\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e07e08152811086-51\"><span class=\"crayon-c\">// ...</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e07e08152811086-52\">&nbsp;</div></div></td></tr></tbody></table>\n\nFor the final type, restart the application and send a webhook request using Typeform data.\n\nWith everything working as expected, you’ll receive an email to the address you submitted to Typeform with a magic link. Click the magic link to authenticate with the application and join the conversation.\n\nTime to invite some friends!\n\n![Other people can now join chat](https://www.nexmo.com/wp-content/uploads/2019/11/other_people_can_now_join_chat.png)\n\n## That’s All Folks!\n\nIf you’re interested in how the UI for this tutorial was built, check out my latest post [Create a Simple Messaging UI with Bootstrap](https://www.nexmo.com/blog/2019/12/18/create-a-simple-messaging-ui-with-bootstrap-dr).\n\nAlso, here are some things to consider if you’re building this for real-world use:\n\n*   Use a separate form to handle authentication after a user has already registed.\n*   Capture a display name and user image inside your Typeform.\n*   Use a revokable opaque string instead of a JWT inside a magic link.\n*   Allow users to update their data once authenticated.\n*   Show all currently online in the side menu.\n*   Allow users to sign out.\n*   Allow users to delete messages.\n*   Allow users to share media.\n*   Expand shared URLs as previews.\n\nIf you want to enable audio inside an existing chat application like this, you can check out my guide for [Adding Voice Functionality to an Existing Chat Application](https://www.nexmo.com/blog/2019/10/11/adding-voice-functionality-to-an-existing-chat-application-dr).\n\nThanks for reading and let me know what you think in the [Community Slack](https://developer.nexmo.com/community/slack) or in the comments section below 👇"}