{"_filedata":{"slug":"how-permissions-work-in-aws-lambda-dr"},"title":"How Permissions Work in AWS Lambda","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2020/03/E_AWS-permissions_1200x600.png","author":340,"published":true,"published_at":"2020-03-25T13:03:43","tags":[499,416,161],"body":"<p>When working with AWS Lambda, many users struggle with permissions using other AWS services. More specifically, how to access services like S3, RDS, Transcribe, or others.</p>\n<p>Many create a new <a href=\"https://aws.amazon.com/iam/\">IAM user</a>, and set <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> in <a href=\"https://docs.aws.amazon.com/sdk-for-php/v3/developer-guide/guide_credentials_environment.html\">environment variables</a>. The AWS SDK &#8220;automagically&#8221; uses those keys or values from an <a href=\"https://docs.aws.amazon.com/sdk-for-php/v3/developer-guide/guide_credentials_profiles.html\">AWS Credentials File</a>. (See the <a href=\"https://docs.aws.amazon.com/sdk-for-php/v3/developer-guide/getting-started_basic-usage.html#creating-a-client\">documentation</a> on how the SDK uses those values.) However, adding those credentials for a Lambda would be a mistake.</p>\n<h2>Mistaken Identity</h2>\n<p>Attempting the following <code>.env</code> file prevents an application from accessing AWS services from within Lambda. Connection failure is regardless of how you configured the IAM user.</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9b79924a2f5548794719\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\nAWS_ACCESS_KEY_ID={{YOUR-ACCESS-KEY-HERE}}\nAWS_SECRET_ACCESS_KEY={{YOUR-SECRET-HERE}}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9b79924a2f5548794719-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9b79924a2f5548794719-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9b79924a2f5548794719-3\">3</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9b79924a2f5548794719-1\"><span class=\"crayon-v\">AWS_ACCESS_KEY_ID</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">YOUR</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ACCESS</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">KEY</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">HERE</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9b79924a2f5548794719-2\"><span class=\"crayon-v\">AWS_SECRET_ACCESS_KEY</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">YOUR</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">SECRET</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">HERE</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9b79924a2f5548794719-3\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0001 seconds] -->\r\n<p></p>\n<p>As the Lambda function deploys, the environment variables shown above get generated by Lambda. Meaning, the values of the file <code>.env</code> do not get set as expected.</p>\n<p>To read more about deploying with Serverless, check out <a href=\"https://www.nexmo.com/blog/2020/03/16/aws-lambda-with-php-using-bref-and-serverless-framework-dr\">AWS Lambda With PHP Using Bref and Serverless Framework</a> or <a href=\"https://www.nexmo.com/blog/2020/03/20/serverless-python-with-aws-lambda-dr\">Serverless Python with AWS Lambda</a>.</p>\n<h2>Setting Permissions</h2>\n<p>With environment variables <code>AWS_ACCESS_KEY_ID</code> and <code>AWS_SECRET_ACCESS_KEY</code> set by Lambda, the role permissions also need set during deployment. All AWS services also get handled directly in the Lambda function instead of an IAM user.</p>\n<p>Below is a partial yaml example using the Serverless framework to deploy an AWS Lambda function.</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9b79924a2f9520682782\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\nprovider:\n    name: aws\n    region: us-east-1\n    runtime: provided\n    iamRoleStatements:\n        - Effect: Allow\n          Action:\n              - s3:PutObject\n              - s3:GetObject\n              - s3:DeleteObject\n          Resource: 'arn:aws:s3:::bucket-name/*'\n        - Effect: Allow\n          Action: transcribe:*\n          Resource: '*'\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9b79924a2f9520682782-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9b79924a2f9520682782-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9b79924a2f9520682782-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9b79924a2f9520682782-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9b79924a2f9520682782-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9b79924a2f9520682782-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9b79924a2f9520682782-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9b79924a2f9520682782-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9b79924a2f9520682782-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9b79924a2f9520682782-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9b79924a2f9520682782-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9b79924a2f9520682782-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9b79924a2f9520682782-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9b79924a2f9520682782-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9b79924a2f9520682782-15\">15</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9b79924a2f9520682782-1\"><span class=\"crayon-v\">provider</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9b79924a2f9520682782-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">aws</span></div><div class=\"crayon-line\" id=\"crayon-5e9b79924a2f9520682782-3\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">region</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">us</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">east</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9b79924a2f9520682782-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">runtime</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">provided</span></div><div class=\"crayon-line\" id=\"crayon-5e9b79924a2f9520682782-5\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">iamRoleStatements</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9b79924a2f9520682782-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Effect</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Allow</span></div><div class=\"crayon-line\" id=\"crayon-5e9b79924a2f9520682782-7\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Action</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9b79924a2f9520682782-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s3</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">PutObject</span></div><div class=\"crayon-line\" id=\"crayon-5e9b79924a2f9520682782-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s3</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">GetObject</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9b79924a2f9520682782-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s3</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">DeleteObject</span></div><div class=\"crayon-line\" id=\"crayon-5e9b79924a2f9520682782-11\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Resource</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'arn:aws:s3:::bucket-name/*'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9b79924a2f9520682782-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Effect</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Allow</span></div><div class=\"crayon-line\" id=\"crayon-5e9b79924a2f9520682782-13\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Action</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">transcribe</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">*</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9b79924a2f9520682782-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Resource</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'*'</span></div><div class=\"crayon-line\" id=\"crayon-5e9b79924a2f9520682782-15\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0002 seconds] -->\r\n<p></p>\n<p>Note the <code>iamRoleStatements</code> block in the example above. In it, the Lambda is granted <code>s3:PutObject</code>, <code>s3:GetObject</code>, and <code>s3:DeleteObject</code> permissions to the resource <code>bucket-name</code> and anything in it. Also, the function has access to <code>transcribe:*</code> services.</p>\n<p>The example above is very similar to how IAM permissions get set in the examples below:</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2020/03/aws_iam_s3_policy.png\" alt=\"aws_iam_s3_policy\" title=\"AWS IAM S3 Policy Example\" /></p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2020/03/amazon_iam_transcribe_policy.png\" alt=\"amazon_iam_transcribe_policy\" title=\"AWS IAM Transcribe Policy Example\" /></p>\n<h2>Examining Permissions</h2>\n<p>Upon successful deployment to AWS Lambda, the active permissions of the function can be viewed in the AWS Console. Do this by navigating to the Permissions tab of the function console.</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2020/03/lambda_function_permissions.png\" alt=\"lambda_function_permissions\" title=\"AWS Lambda Function Permissions\" /></p>\n<p>From there, you can click into the permissions of each service for a more detailed breakdown of how you set them.</p>\n<h2>What Next</h2>\n<p>Documentation about possible permissions to various AWS services are available in the <a href=\"https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html\">AWS Identity and Access Management Documentation</a>. Also, watch for future posts with examples of using these permissions in action.</p>\n"}