{"_filedata":{"slug":"building-a-real-time-net-transcription-service-dr"},"title":"Building a Real Time .NET Transcription Service","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2019/12/E-Net-Transcription_1200x600.jpg","author":349,"published":true,"published_at":"2019-12-30T14:00:13","tags":[385,1529,1237,1048],"body":"Building speech to text transcription services has never been easier. In this demo you will be building an extremely simple, yet powerful, real-time transcription service in ASP.NET using [Nexmo’s .NET SDK](https://developer.nexmo.com/tools) and [Microsoft Azure’s Speech SDK](https://docs.microsoft.com/en-us/azure/cognitive-services/speech-service/speech-sdk).\n\n## Prerequisites\n\n*   Visual Studio 2019 version 16.3 or higher\n*   A Nexmo account [Sign up here](https://dashboard.nexmo.com/sign-up)\n*   An Azure Account\n*   Optional: [Ngrok](https://ngrok.com/) for test deployment\n\n## Create Azure Cognitive Services Resource\n\n*   Go to your [Azure Dashboard](https://portal.azure.com/)\n*   Open the Hamburger menu and select “Create Resource”\n*   Search for Speech and Create a Speech Resource:  \n      \n    ![Speech Resource page](https://www.nexmo.com/wp-content/uploads/2019/12/Speech_Resource.png)\n*   Fill out the create form. For demonstrative purposes, you can use the following inputs\n    *   Name: TranscriptionTest\n    *   Subscription: pay-as-you-go\n    *   Location: East US\n    *   Pricing Tier: F0\n    *   Resource Group: Transcription\n\nThis will take some time to spin up. Once it’s deployed you are going to navigate to the Quick Start Section to gather your access keys. You are looking for the `Key1` value, so search for the highlighted section:\n\n![Quick Start Section](https://www.nexmo.com/wp-content/uploads/2019/12/Speech_Resource_quickStart.png)\n\nSave this key value offline somewhere for the moment.\n\n## Building the Real Time Transcription Service\n\n### Project Setup\n\nOpen Visual Studio and create a new project ASP.NET Core WebApplication. For example, “TranscriptionBlogPostDemo”\n\nNow, you’ll create an MVC web application for this demonstration in ASP.NET Core 3.0.\n\n![Web Application Type Selection](https://www.nexmo.com/wp-content/uploads/2019/12/web_application_type_select.png)\n\nWith this created, add the following nuget packages to the project:\n\n*   Nexmo.Csharp.Client\n*   Newtonsoft.Json\n*   Microsoft.CognitiveServices.Speech\n\n### Transcription Engine\n\nWith these projects imported, create a new class called TranscriptionEngine.\n\nFirst, define some constants for the benefit of both the speech SDK and for managing the WebSocket buffer.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">const int SAMPLES_PER_SECOND = 8000; const int BITS_PER_SAMPLE = 16; const int NUMBER_OF_CHANNELS = 1; const int BUFFER_SIZE = 160 * 2;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054c5987335441-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054c5987335441-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054c5987335441-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054c5987335441-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054c5987335441-5\">5</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054c5987335441-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SAMPLES_PER_SECOND</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">8000</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054c5987335441-2\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BITS_PER_SAMPLE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">16</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054c5987335441-3\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NUMBER_OF_CHANNELS</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054c5987335441-4\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BUFFER_SIZE</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">160</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">*</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054c5987335441-5\">&nbsp;</div></div></td></tr></tbody></table>\n\nNext, add the following field to the class:\n\n*   \\_config – this will hold the subscription/regional info of the speech analyzer. The region in the demo is eastus – derived from the region you configured your speech service for. For a mapping of region to input string see the Microsoft [Azure Speech Service Supported Regions Documentation](https://docs.microsoft.com/en-us/azure/cognitive-services/speech-service/regions)\n*   \\_inputStream – this is going to be a push Stream that will serve as the buffer that will be streamed over to the Azure Speech-to-text service\n*   \\_audioInput – this will be the input for the speech recognizer\n*   \\_recognizer – this will be the recognizer that will perform the speech recognition task\n\nThese can be defined like so:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">SpeechConfig _config = SpeechConfig.FromSubscription(\"your_subscription_key\", \"your_azure_region\"); // e.g. eastus PushAudioInputStream _inputStream = AudioInputStream.CreatePushStream(AudioStreamFormat.GetWaveFormatPCM(SAMPLES_PER_SECOND, BITS_PER_SAMPLE, NUMBER_OF_CHANNELS)); AudioConfig _audioInput; SpeechRecognizer _recognizer;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054c8811458338-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054c8811458338-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054c8811458338-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054c8811458338-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054c8811458338-5\">5</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054c8811458338-1\"><span class=\"crayon-e\">SpeechConfig </span><span class=\"crayon-v\">_config</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SpeechConfig</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">FromSubscription</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"your_subscription_key\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"your_azure_region\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// e.g. eastus</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054c8811458338-2\"><span class=\"crayon-e\">PushAudioInputStream </span><span class=\"crayon-v\">_inputStream</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AudioInputStream</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">CreatePushStream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">AudioStreamFormat</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetWaveFormatPCM</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">SAMPLES_PER_SECOND</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BITS_PER_SAMPLE</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NUMBER_OF_CHANNELS</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054c8811458338-3\"><span class=\"crayon-e\">AudioConfig </span><span class=\"crayon-v\">_audioInput</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054c8811458338-4\"><span class=\"crayon-e\">SpeechRecognizer </span><span class=\"crayon-v\">_recognizer</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054c8811458338-5\">&nbsp;</div></div></td></tr></tbody></table>\n\nGiven several of the fields are IDisposable’s, have this class implement IDisposable and simply dispose of all the disposable fields on its way down\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public void Dispose() { _inputStream.Dispose(); _audioInput.Dispose(); _recognizer.Dispose(); }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054c9229013719-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054c9229013719-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054c9229013719-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054c9229013719-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054c9229013719-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054c9229013719-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054c9229013719-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054c9229013719-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Dispose</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054c9229013719-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054c9229013719-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_inputStream</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Dispose</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054c9229013719-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_audioInput</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Dispose</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054c9229013719-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_recognizer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Dispose</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054c9229013719-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054c9229013719-7\">&nbsp;</div></div></td></tr></tbody></table>\n\nThen add a constructor that will initialize the \\_audioInput with the push input stream defined above:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public TranscriptionEngine() { _audioInput = AudioConfig.FromStreamInput(_inputStream); }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054ca901583828-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054ca901583828-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054ca901583828-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054ca901583828-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054ca901583828-5\">5</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054ca901583828-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TranscriptionEngine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054ca901583828-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054ca901583828-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_audioInput</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AudioConfig</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">FromStreamInput</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_inputStream</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054ca901583828-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054ca901583828-5\">&nbsp;</div></div></td></tr></tbody></table>\n\nNext, add the method that will listen for speech recognition events from the recognizer\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">private void RecognizerRecognized(object sender, SpeechRecognitionEventArgs e) { Trace.WriteLine(\"Recognized: \" + e.Result.Text); }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cb364267375-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cb364267375-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cb364267375-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cb364267375-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cb364267375-5\">5</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cb364267375-1\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RecognizerRecognized</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">object</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sender</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">SpeechRecognitionEventArgs</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cb364267375-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cb364267375-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Trace</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"Recognized: \"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Result</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Text</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cb364267375-4\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cb364267375-5\">&nbsp;</div></div></td></tr></tbody></table>\n\nFrom here, you can add a function to stop and start the speech recognizer.\n\nThe `start` method accepts a language string, sets the language of the SpeechConfig, initializes the recognizer with the config and audio input source, registers the RecognizerRecognized event you created earlier, and starts a Continuous Recognition.\n\nYour `stop` method will unregister the RecognizerRecognized event and stop the recognizer.\n\n> NOTE: The StopContinuousRecognitionAsync can take upwards of 20 seconds as there isn’t a mechanism to cancel the currently running input stream as of this writing. This demo explicitly mitigates this issue by not reusing the recognizer between calls, and not blocking the shutdown of the socket for this to complete.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public async Task StartSpeechTranscriptionEngine(string language) { _config.SpeechRecognitionLanguage = language; _recognizer = new SpeechRecognizer(_config, _audioInput); _recognizer.Recognized += RecognizerRecognized; await _recognizer.StartContinuousRecognitionAsync(); } private async Task StopTranscriptionEngine() { if(_recognizer != null) { _recognizer.Recognized -= RecognizerRecognized; await _recognizer.StopContinuousRecognitionAsync(); } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cd975254973-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cd975254973-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cd975254973-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cd975254973-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cd975254973-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cd975254973-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cd975254973-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cd975254973-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cd975254973-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cd975254973-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cd975254973-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cd975254973-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cd975254973-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cd975254973-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cd975254973-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cd975254973-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cd975254973-17\">17</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cd975254973-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">async </span><span class=\"crayon-e\">Task </span><span class=\"crayon-e\">StartSpeechTranscriptionEngine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">language</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cd975254973-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cd975254973-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_config</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">SpeechRecognitionLanguage</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">language</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cd975254973-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_recognizer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SpeechRecognizer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_config</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_audioInput</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cd975254973-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_recognizer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Recognized</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RecognizerRecognized</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cd975254973-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">await </span><span class=\"crayon-v\">_recognizer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">StartContinuousRecognitionAsync</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cd975254973-7\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cd975254973-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cd975254973-9\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">async </span><span class=\"crayon-e\">Task </span><span class=\"crayon-e\">StopTranscriptionEngine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cd975254973-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cd975254973-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_recognizer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cd975254973-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cd975254973-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_recognizer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Recognized</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RecognizerRecognized</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cd975254973-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">await </span><span class=\"crayon-v\">_recognizer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">StopContinuousRecognitionAsync</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cd975254973-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cd975254973-16\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cd975254973-17\">&nbsp;</div></div></td></tr></tbody></table>\n\nThe final task this class is going to take on is going to be to receive audio on the websocket you will be setting up, and pushing it through to the PushAudioStream you created earlier. This will be awaited after the websocket is established and will continue to be until the websocket is closed.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public async Task ReceiveAudioOnWebSocket(HttpContext context, WebSocket webSocket) { var buffer = new byte[BUFFER_SIZE]; try { var language = \"en-US\"; await StartSpeechTranscriptionEngine(language); WebSocketReceiveResult result = await webSocket.ReceiveAsync(new ArraySegment&lt;byte&gt;(buffer), CancellationToken.None); while (!result.CloseStatus.HasValue) { await webSocket.SendAsync(new ArraySegment&lt;byte&gt;(buffer, 0, result.Count), result.MessageType, result.EndOfMessage, CancellationToken.None); result = await webSocket.ReceiveAsync(new ArraySegment&lt;byte&gt;(buffer), CancellationToken.None); _inputStream.Write(buffer); } await webSocket.CloseAsync(result.CloseStatus.Value, result.CloseStatusDescription, CancellationToken.None); } catch (Exception e) { Trace.WriteLine(e.ToString()); } finally { await StopTranscriptionEngine(); } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054cf551440107-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054cf551440107-29\">29</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">async </span><span class=\"crayon-e\">Task </span><span class=\"crayon-e\">ReceiveAudioOnWebSocket</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">HttpContext </span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebSocket </span><span class=\"crayon-v\">webSocket</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">buffer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">byte</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">BUFFER_SIZE</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">language</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"en-US\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">await </span><span class=\"crayon-e\">StartSpeechTranscriptionEngine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">language</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">WebSocketReceiveResult </span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">await </span><span class=\"crayon-v\">webSocket</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReceiveAsync</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ArraySegment</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">byte</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">buffer</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CancellationToken</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">None</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">while</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">CloseStatus</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">HasValue</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">await </span><span class=\"crayon-v\">webSocket</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SendAsync</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ArraySegment</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">byte</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">buffer</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Count</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">MessageType</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">EndOfMessage</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CancellationToken</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">None</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-13\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">await </span><span class=\"crayon-v\">webSocket</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReceiveAsync</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ArraySegment</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">byte</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">buffer</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CancellationToken</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">None</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-15\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_inputStream</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">buffer</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">await </span><span class=\"crayon-v\">webSocket</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">CloseAsync</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">CloseStatus</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Value</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">CloseStatusDescription</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">CancellationToken</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">None</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Exception</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Trace</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">finally</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">await </span><span class=\"crayon-e\">StopTranscriptionEngine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054cf551440107-28\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054cf551440107-29\">&nbsp;</div></div></td></tr></tbody></table>\n\n> NOTE: The initial buffer you get back from the websocket will contain metadata for the call—and should you wish, you may extract this data from the first ReceiveAsync—for the sake of the demo, this is not done, as the buffer and Recognizer are robust enough to manage.\n\n### Setting up WebSockets in Your App\n\nOpen `Startup.cs`.\n\nIn the Configure method, you will enable websockets on the server and provide a piece of websocket middleware to use websockets, and to connect an inbound websocket and use the TranscriptionEngine to receive audio over said socket.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">var webSocketOptions = new WebSocketOptions() { KeepAliveInterval = TimeSpan.FromSeconds(120), ReceiveBufferSize = 320 }; app.UseWebSockets(webSocketOptions); app.Use(async (context, next) =&gt; { if (context.Request.Path == \"/ws\") { if (context.WebSockets.IsWebSocketRequest) { WebSocket webSocket = await context.WebSockets.AcceptWebSocketAsync(); using (var engine = new TranscriptionEngine()) { await engine.ReceiveAudioOnWebSocket(context, webSocket); } } else { context.Response.StatusCode = 400; } } else { await next(); } });</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d0966496419-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d0966496419-31\">31</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-1\"><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">webSocketOptions</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebSocketOptions</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">KeepAliveInterval</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TimeSpan</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">FromSeconds</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">120</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">ReceiveBufferSize</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">320</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-5\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-7\"><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">UseWebSockets</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">webSocketOptions</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-9\"><span class=\"crayon-v\">app</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">Use</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">async</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">next</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-10\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Path</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"/ws\"</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">WebSockets</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">IsWebSocketRequest</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">WebSocket </span><span class=\"crayon-v\">webSocket</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">await </span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">WebSockets</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AcceptWebSocketAsync</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">engine</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TranscriptionEngine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">await </span><span class=\"crayon-v\">engine</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReceiveAudioOnWebSocket</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">webSocket</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">context</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Response</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">StatusCode</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">400</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">await </span><span class=\"crayon-e\">next</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d0966496419-30\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d0966496419-31\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Setting up the Voice Controller\n\nThe last piece of code that needs to be implemented is to add a Voice Controller. Add a new controller under the Controller file and name it `VoiceController`. Add a constant string for the BASE\\_URL of your service.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">const string BASE_URL = \"BASE_URL\";</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d1229055809-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d1229055809-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d1229055809-1\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">BASE_URL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"BASE_URL\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d1229055809-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nYour Voice Controller will have two HTTP requests. A POST request for the event webhook, and a GET request the answer webhook. This GET request is going to construct an NCCO with a single connect action which will instruct the Voice API to open a WebSocket to your server and push the audio stream back over that socket. Set the Content type to a 16 bit linear PCM running at 8kHz. See below:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">[HttpPost] public HttpStatusCode Events() { return HttpStatusCode.OK; } [HttpGet] public string Answer() { var webSocketAction = new ConnectAction() { Endpoint = new[] { new WebsocketEndpoint() { Uri = $\"wss://{BASE_URL}/ws\", ContentType=\"audio/l16;rate=8000\", } } }; var ncco = new Ncco(webSocketAction); return ncco.ToString(); }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e054d2237039878-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e054d2237039878-27\">27</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-1\"><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">HttpPost</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HttpStatusCode </span><span class=\"crayon-e\">Events</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpStatusCode</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">OK</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-7\"><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">HttpGet</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-8\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Answer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-9\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">webSocketAction</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ConnectAction</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Endpoint</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebsocketEndpoint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Uri</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"wss://{BASE_URL}/ws\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">ContentType</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"audio/l16;rate=8000\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-18\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-22\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ncco</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Ncco</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">webSocketAction</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ncco</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-25\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e054d2237039878-26\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e054d2237039878-27\">&nbsp;</div></div></td></tr></tbody></table>\n\n## Getting Up and Running\n\n### Setting up IIS Express\n\nOpen the properties dialog for your project, under debug take note of the port number – for the demo, disable SSL, which will make setting up ngrok easier.\n\n### Setting up the Ngrok Tunnel\n\nFor the Voice API to forward the the Event/Answer webhooks you need to expose the site to the internet – for testing purposes, you can use [ngrok](https://ngrok.com) to expose our IIS express port. Open up your command line and use this command, replace `PORT_NUMBER` with your IIS Express instance’s port number.\n\n`ngrok http --host-header=\"localhost:PORT_NUMBER\" http://localhost:PORT_NUMBER`\n\nThis command produces an output like this:\n\n![ngrok config](https://www.nexmo.com/wp-content/uploads/2019/12/ngrok.png)\n\n### Setting up the Nexmo Voice Application\n\nThe next step is going to be setting up a Nexmo Voice Application.\n\n*   Navigate to your [Nexmo Dashboard](https://dashboard.nexmo.com/)\n*   In the left-hand pane open Voice, and click on ‘Create an application’\n*   Name the application, e.g. ‘TranscriptionTest’\n*   Under Capabilities enable Voice\n*   For Event URL add base\\_url\\_of\\_ngrok\\_tunnel/voice/events\n*   For Answer URL add base\\_url\\_of\\_ngrok\\_tunnel/voice/answer\n*   For Fallback answer URL add base\\_url\\_of\\_ngrok\\_tunnel/voice/answer\n\n### Final Touches\n\nNow that you have the ngrok URL, change the BASE\\_URL in the VoiceController file to that url (excluding the ‘http://’)\n\nWith this, you are up and running. Call the Nexmo Number linked to your application, and the App will transcribe your speech to the debug console.\n\n## Additional Links Resources\n\n*   [More Resources for Nexmo](https://developer.nexmo.com/)\n*   [Nexmo .NET Server SDK](https://github.com/nexmo/nexmo-dotnet)\n*   [Azure Cognitive Services Speech SDK](https://docs.microsoft.com/en-us/azure/cognitive-services/speech-service/speech-sdk)\n*   [Using WebSockets with the Nexmo Voice API](https://developer.nexmo.com/voice/voice-api/guides/websockets)\n*   [.NET Speech to Text Demo Application](https://github.com/nexmo-community/DotNetSTTSample)"}