{"_filedata":{"slug":"sentiment-analysis-using-ibm-watson-tone-analyzer-in-php-dr"},"title":"Sentiment Analysis using IBM Watson Tone Analyzer in PHP","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2020/01/sentiment-analysis-php.png","author":340,"published":true,"published_at":"2020-01-13T20:40:39","tags":[360,1664,1550,200,1376,92,1663,455],"body":"In a world where data and text often take a front-row seat, it is increasingly important to understand the sentiment of communications we receive. It is also important to understand how words we use can convey a mistaken sentiment.\n\nIt is common to read an SMS text message and “think” they are angry, disappointed, or being sarcastic. Black and white text makes it hard to “feel” what is being shared, especially in political work environments or where passionate or opinionated ideas and visions may be shared.\n\nSentiment analysis is a great tool to help us bridge the gap between what we say and what we mean. And, though it may not be able to fix everything, it can help drive a more positive direction.\n\nLet’s take a look at how sentiment analysis could be used with Nexmo SMS text messaging by leveraging the IBM Watson service with a simple PHP callback script.\n\n## Project Setup\n\nTo start with, in this example, we will run a PHP application locally with the [PHP built-in web server](https://www.php.net/manual/en/features.commandline.webserver.php). Though the built-in web server should not be used in a production environment, it is fine for sample scripts like this.\n\nThen we will use [ngrok](https://ngrok.io) to make the local application available on the Internet as a callback endpoint for the Nexmo SMS service. Take a look at [this page](https://www.nexmo.com/blog/2017/07/04/local-development-nexmo-ngrok-tunnel-dr) if you need help getting ngrok setup, but the basics are: Create an account at ngrok, download the executable, kick off a tunnel via CLI, and then use the URLs provided in the CLI after it is running.\n\n### IBM Watson Account\n\nOne requirement is to have an account, and API credentials, with a service providing sentiment analysis. As of this post, there are few available, and you can check out [this post](https://www.nexmo.com/blog/2019/10/17/sentiment-api-analysis-comparison-dr) to see a basic breakdown. However, for this example, we will use the [IBM Watson Tone Analyzer](https://www.ibm.com/cloud/watson-tone-analyzer) service.\n\nThis will require an IBM Cloud account, creating a resource, and setting up credentials, which is all free until you reach a certain level of usage.\n\n### IBM Cloud\n\nAfter setting up an account at IBM Cloud, and getting logged in, you will be presented with the Dashboard. From there you will click the Create resource button.\n\n![Create resource at IBM Cloud](/wp-content/uploads/2020/01/create_resource.png \"Create resource at IBM Cloud\")\n\nFollowing that, scroll down to click the Tone Analyzer box.\n\n![Tone Analyzer service at IBM Cloud](/wp-content/uploads/2020/01/tone_analyzer_service.png \"Tone Analyzer service at IBM Cloud\")\n\nComplete the form with the required information, selecting a region nearby. After which an API Key and URL will be provided. Make a note of them, because they will be needed later.\n\n### Application Base\n\nAt this point, we need to start organizing the application. We will assume an empty directory, and begin building the example callback app from there. We will also assume a local system with PHP already set up and running, and able to be used via CLI (Command Line Interface).\n\nIn this empty directory, create a new PHP file and name it `index.php`. At the moment, just type the word “test” in the file. This will create some output and allow us to test in the next step.\n\n### PHP Built-in Webserver and ngrok\n\nTo begin with, we will start up the built-in PHP-webserver and get ngrok running. This will ensure the environment is running and ready from the start.\n\nUsing the system’s terminal, navigate to the location of our directory. Once there, issue the command to start the PHP built-in web server, like so:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">php -S localhost:8080</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d7f012145120-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d7f012145120-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d7f012145120-1\"><span class=\"crayon-v\">php</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">S</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">8080</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d7f012145120-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nAt this point, by entering “http://localhost:8080” we should see “test” as a response if that is what was entered in the `index.php` previously created.\n\nNext, we get ngrok running to make the results of the webserver available over the Internet. In a terminal, navigate to the location where ngrok was installed previously, and enter the following command:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">./ngrok http 8080</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d83449891931-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d83449891931-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d83449891931-1\"><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ngrok </span><span class=\"crayon-i\">http</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">8080</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d83449891931-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nIn return, ngrok will provide us with some important information, as in the screenshot below.\n\n![ngrok information returned](/wp-content/uploads/2020/01/ngrok_output.png \"ngrok information returned\")\n\nThis lets us know the service information, including the tunnel URLs to use for hitting our locally running script. We can enter the information provided in a web browser and should get the same results as when requesting via localhost above.\n\n> Note: It’s recommended using https URLs to protect any credentials being shared between the services.\n\nWe will let the ngrok instance run throughout this example. When you are ready to shut it down, simply hit “Ctrl+c” in the terminal and it will close ngrok.\n\n## Nexmo Setup\n\nWith the URLs provided by ngrok, we can update the Nexmo provided SMS number. In the Nexmo Dashboard expand the Numbers menu item to expose “Your numbers”.\n\n![nexmo_dashboard](/wp-content/uploads/2020/01/nexmo_dashboard.png \"Nexmo Dashboard\")\n\nThen click the Settings button to edit the Inbound Webhook URL for SMS.\n\n![nexmo_hooks](/wp-content/uploads/2020/01/nexmo_hooks.png \"Nexmo Hooks\")\n\n### Composer\n\nFor expedience sake, we will use Composer to install some packages and make life easier for us with its autoloader and dependency management.\n\nWe will assume Composer is already installed [globally](https://getcomposer.org/doc/00-intro.md#globally) on our system, so it can be used easily whenever we need it, and to make it easier to keep it up to date.\n\nIn the project folder, we need to init Composer, enabling us to include a few packages/dependencies. So, navigate to the project directory, via CLI, and issue the following command.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">composer init</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d85895747345-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d85895747345-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d85895747345-1\"><span class=\"crayon-e\">composer </span><span class=\"crayon-i\">init</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d85895747345-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nThe latest versions of Composer now perform a step-by-step process to help set up a project. Follow through the prompts and fill out as desired. Please use the packages in the following section of what should be required.\n\n### Required Dependencies\n\nTo complete the wizard in the previous section, or to manually set up a `composer.json` file, include the following dependencies for this example:\n\n*   [vlucas/phpdotenv](https://github.com/vlucas/phpdotenv) – stores credentials in the superglobal $\\_ENV\n*   [slim/slim](http://www.slimframework.com/) – light microframework that makes handling HTTP calls and callbacks easy\n*   [slim/psr7](http://www.slimframework.com/docs/v4/concepts/value-objects.html) – facilitates HTTP interoperability between libraries\n*   [guzzlehttp/guzzle](http://docs.guzzlephp.org/en/stable/overview.html) – for handling HTTP calls rather than using cUrl\n\n### Composer Install\n\nWith all dependencies added to Composer, we are now ready to install them using the following command in the CLI.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">composer install</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d86565874827-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d86565874827-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d86565874827-1\"><span class=\"crayon-e\">composer </span><span class=\"crayon-i\">install</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d86565874827-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n## Create Credentials\n\nCredentials for this sample app will be housed in an ENV file and parsed by phpdotenv.\n\n### ENV setup\n\nCreating an `.env` file allows us to store credentials we will need when connecting to the outside service. In this case, it will be the IBM Watson API. Add the following content in the newly created file named `.env` in the project root:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">TONE_ANALYZER_IAM_APIKEY={YOUR-WATSON-KEY-HERE} TONE_ANALYZER_URL=https://gateway-wdc.watsonplatform.net/tone-analyzer/api/v3/tone/</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d88964115192-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d88964115192-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d88964115192-3\">3</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d88964115192-1\"><span class=\"crayon-v\">TONE_ANALYZER_IAM_APIKEY</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">YOUR</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">WATSON</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">KEY</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">HERE</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d88964115192-2\"><span class=\"crayon-v\">TONE_ANALYZER_URL</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">https</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//gateway-wdc.watsonplatform.net/tone-analyzer/api/v3/tone/</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d88964115192-3\">&nbsp;</div></div></td></tr></tbody></table>\n\nNOTE: The URL may change, so ensure it is similar to what is provided by IBM Cloud. Be sure to swap out the values with what was received from the IBM Watson service.\n\n### PHPDotEnv Usage\n\nIn the `index.php` file created earlier, we start adding code to leverage the Composer autoloader, and the phpdotenv PHP package to inject the contents of the `.env` file into the $\\_ENV superglobal.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">&lt;?php require('vendor/autoload.php'); Dotenv\\Dotenv::create(__DIR__)-&gt;load();</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d89522266779-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d89522266779-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d89522266779-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d89522266779-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d89522266779-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d89522266779-6\">6</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d89522266779-1\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-sy\">?</span><span class=\"crayon-e\">php</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d89522266779-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d89522266779-3\"><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'vendor/autoload.php'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d89522266779-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d89522266779-5\"><span class=\"crayon-v\">Dotenv</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Dotenv</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">create</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">__DIR__</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">load</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d89522266779-6\">&nbsp;</div></div></td></tr></tbody></table>\n\nNOTE: By convention, the above code will load the `.env` file from the current directory. If another location is desired, an additional method to open it will be necessary. (not shown)\n\n### Guzzle for HTTP\n\nWe will also include Guzzle, a PHP package for handling HTTP requests instead of using cURL, for any calls to the outside IBM Watson service. We will import it with a `use` statement after the requirement of Composer above.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">use GuzzleHttp\\Client;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8b130331030-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8b130331030-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8b130331030-1\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">GuzzleHttp</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Client</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8b130331030-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n## Using Slim PHP\n\nTo set up slim in our sample callback script, we will import with a `use` statement, immediately following the Composer autoload require. Then we will call the create() function of Slim to create a Slim app and a function call to app->run at the end of the file to kick things off.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">use Psr\\Http\\Message\\ServerRequestInterface as Request; use Psr\\Http\\Message\\ResponseInterface as Response; use Slim\\Factory\\AppFactory; $app = AppFactory::create(); //... call to Dotenv $app-&gt;run();</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8c044043622-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8c044043622-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8c044043622-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8c044043622-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8c044043622-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8c044043622-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8c044043622-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8c044043622-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8c044043622-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8c044043622-10\">10</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8c044043622-1\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Psr</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Http</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Message</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">ServerRequestInterface </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Request</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8c044043622-2\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Psr</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Http</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Message</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">ResponseInterface </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Response</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8c044043622-3\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Slim</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Factory</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">AppFactory</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8c044043622-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8c044043622-5\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">app</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AppFactory</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">create</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8c044043622-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8c044043622-7\"><span class=\"crayon-c\">//... call to Dotenv</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8c044043622-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8c044043622-9\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">app</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">run</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8c044043622-10\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Catch an HTTP Call\n\nThe desire is to use Slim functionality to catch HTTP requests and respond with JSON. We will be including the PSR compliant Request and Response interfaces to help us stay interoperable with HTTP communications, thus we import them with `use` statements along with the Slim import shown above.\n\nAfter injecting the environment variables and the creation of the Slim app, we will add an `any()` method call to handle the HTTP endpoint routing, like so.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">$app-&gt;any('/message[/]', function (Request $request, Response $response) { // {{body of the app here}} });</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8d549687616-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8d549687616-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8d549687616-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8d549687616-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8d549687616-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8d549687616-6\">6</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8d549687616-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">app</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">any</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/message[/]'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Request</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Response</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8d549687616-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8d549687616-3\"><span class=\"crayon-c\">// {{body of the app here}}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8d549687616-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8d549687616-5\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8d549687616-6\">&nbsp;</div></div></td></tr></tbody></table>\n\nNotice we are allowing the ability to make `any` HTTP call to this script. (GET, POST, PUT, DELETE, etc.) I like to do this on purpose and allow me to return valid HTTP status codes as needed. Which will be the first thing we add into the body of the anonymous function above.\n\nBasically, if any type of HTTP request other than a POST request comes in, the script should respond with a 405 status code. We only want POST requests.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">if ($request-&gt;getMethod() != 'POST') { return $response-&gt;withStatus(405); }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8e296535896-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8e296535896-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8e296535896-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8e296535896-4\">4</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8e296535896-1\"><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getMethod</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'POST'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8e296535896-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">withStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">405</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8e296535896-3\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8e296535896-4\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Parse Request JSON\n\nThe Nexmo service will send a JSON payload within the POST request. We will parse the JSON to an object we can use in future calls to IBM Watson Sentiment service.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">$body = json_decode($request-&gt;getBody());</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d8f871661925-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d8f871661925-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d8f871661925-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">body</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">json_decode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getBody</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d8f871661925-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n### HTTP Call to Watson\n\nUsing the `$body` object, we make a request to IBM Watson to analyze the sentiment of the message. We do this with a new Guzzle Client instance to handle the request.\n\n> Note: This is where $\\_ENV, created from the `.env` file comes into play.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">$client = new Client(); $result = $client-&gt;request( 'GET', $_ENV['TONE_ANALYZER_URL'] . '?version=2017-09-21&amp;text=' . urlencode($body-&gt;text), ['auth' =&gt; ['apikey', $_ENV['TONE_ANALYZER_IAM_APIKEY']]] );</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d90088207714-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d90088207714-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d90088207714-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d90088207714-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d90088207714-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d90088207714-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d90088207714-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d90088207714-8\">8</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d90088207714-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">client</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Client</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d90088207714-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d90088207714-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">client</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">request</span><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d90088207714-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'GET'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d90088207714-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_ENV</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'TONE_ANALYZER_URL'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'?version=2017-09-21&amp;text='</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">urlencode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">body</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d90088207714-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'auth'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'apikey'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_ENV</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'TONE_ANALYZER_IAM_APIKEY'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d90088207714-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d90088207714-8\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Return a Response\n\nAnd finally, we use the Content-Type returned from IBM, or set it manually. Following this, we return the sentiment analysis provided by the service as a new JSON object.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">$contentType = $result-&gt;getHeaderLine('Content-Type') ?: 'application/json'; $response = $response-&gt;withHeader('Content-Type', $contentType); return $response-&gt;withBody($result-&gt;getBody());</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d91035577236-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d91035577236-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d91035577236-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d91035577236-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e03d91035577236-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e03d91035577236-6\">6</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d91035577236-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">contentType</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getHeaderLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Content-Type'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'application/json'</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d91035577236-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d91035577236-3\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">withHeader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Content-Type'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">contentType</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d91035577236-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e03d91035577236-5\"><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">withBody</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getBody</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e03d91035577236-6\">&nbsp;</div></div></td></tr></tbody></table>\n\n## Conclusion\n\nAs shown in this example, it is straightforward to include sentiment analysis in applications to clarify communication intent. Understanding the sentiment of what others are sharing can be a huge factor in reducing politics and stress in our daily lives. More and more services are starting to incorporate this level of functionality in their apps, and I hope you find this example of using it with SMS handy.\n\nFor a completed code example go to [https://github.com/nexmo-community/sms-ibm-sentiment-php](https://github.com/nexmo-community/sms-ibm-sentiment-php)."}