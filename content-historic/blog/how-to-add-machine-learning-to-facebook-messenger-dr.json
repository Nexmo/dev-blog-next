{"_filedata":{"slug":"how-to-add-machine-learning-to-facebook-messenger-dr"},"title":"&#8220;Hey Facebook, What Type of Dog Is That?&#8221; &#8211; Adding Machine Learning to Messenger","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2019/10/What-Kind-of-Dog-Is-That.png","author":349,"published":true,"published_at":"2019-10-31T14:39:44","tags":[385,1643,1640,1639,1641,1237,1638,1642,1240],"body":"Convolutional Neural Networks (CNNs) provide a powerful and scalable mechanism for preforming image classification. They can be relatively difficult to build, train, and tune from scratch, which is what makes tools like TensorFlow and the inception models so indispensable to improving our ML workflows.\n\nThat said for us .NET folks running python scripts out of an in-app shell is less than an ideal solution which is what makes the release of the ML.NET TensorFlow library so exciting.\n\nWhat if I told you that with just a couple hundred lines of C# code and a little configuration you could build an ASP.NET core app that will house a powerful CNN that you can interact with as simple as sending a picture message to a Facebook page?\n\nWith training as simple as:  \n  \n[![](https://www.nexmo.com/wp-content/uploads/2019/10/sampleTrain.jpg)](https://www.nexmo.com/wp-content/uploads/2019/10/sampleTrain.jpg)\n\nAnd a classification request as simple as:  \n  \n[![](https://www.nexmo.com/wp-content/uploads/2019/10/sampleClassify.jpg)](https://www.nexmo.com/wp-content/uploads/2019/10/sampleClassify.jpg)\n\nWell, that’s precisely what we’re going to do – using ML.NET, we’re going to build a powerful classifier and then using Nexmo’s Messages API and Messenger we’re going to create a powerful, easy to use, vector for training and classification.\n\n## Learning Objectives\n\nIn this tutorial, we will:\n\n*   Create an ML.NET TensorFlow Neural Network\n*   Train that Neural Network to recognize different types of dogs\n*   Create a Messaging vector to ask the Neural Network to classify dogs it’s never seen before\n*   Create a Learning vector to allow the Neural Network to learn new types of dogs dynamically.\n\n## Prerequisites\n\n*   Visual Studio 2019 version 16.3 or higher\n*   A Nexmo account [Sign up here](https://dashboard.nexmo.com/sign-up)\n*   A linked Facebook Page to your Nexmo account [See here for setup](https://developer.nexmo.com/messages/concepts/facebook)\n*   Optional: [Ngrok](https://ngrok.com/) for test deployment\n\n## Project Setup\n\nFirst thing’s first – let’s open Visual Studio, Create a new ASP.NET Core 3.0 API application and call it MessagesTensorFlow. Now let’s add the following NuGet packages to the solution:\n\n*   BouncyCastle\n*   jose-jwt\n*   Microsoft.ML\n*   Microsoft.ML.ImageAnalytics\n*   Microsoft.ML.TensorFlow\n*   Newtonsoft.Json\n\nWe’re going to be starting off our neural net with the Inception V1 model and then seeding it with images / labels off disk. Create a folder under the MessagesTensorFlow directory called `assets`.\n\nIn assets download and unzip the [Inception V1 Model](https://storage.googleapis.com/download.tensorflow.org/models/inception5h.zip)\n\nAlso, under assets, create a folder called train and predict. Under each of those directories, add a tags.tsv file. Your directory structure should look something like this now:\n\n[![](https://www.nexmo.com/wp-content/uploads/2019/10/assetsStruct-1.png)](https://www.nexmo.com/wp-content/uploads/2019/10/assetsStruct-1.png)\n\nNow go to each file and in the advanced properties section set the Copy to Output Directory to Copy if newer  \n  \n[![](https://www.nexmo.com/wp-content/uploads/2019/10/advancedProperties-1.png)](https://www.nexmo.com/wp-content/uploads/2019/10/advancedProperties-1.png)\n\n## Creating the Learner\n\nLet’s now create the class that’s going to actually hold our neural network. Create a file called TFEngine.cs.\n\n### Imports\n\nAdd the following imports to the top of the file:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">using Microsoft.ML; using Microsoft.ML.Data; using System; using System.Collections.Generic; using System.IO; using System.Linq; using System.Net;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a2c371817175-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a2c371817175-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a2c371817175-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a2c371817175-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a2c371817175-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a2c371817175-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a2c371817175-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a2c371817175-8\">8</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a2c371817175-1\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">Microsoft</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ML</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a2c371817175-2\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">Microsoft</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ML</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Data</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a2c371817175-3\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a2c371817175-4\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Collections</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Generic</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a2c371817175-5\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">IO</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a2c371817175-6\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Linq</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a2c371817175-7\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Net</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a2c371817175-8\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Class Setup\n\nThen inside the TFEngine class let’s add some paths so we can access everything all the files we’ll be ingesting into our model. As well as some settings for managing the inception data.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">static readonly string _assetsPath = Path.Combine(Environment.CurrentDirectory, \"assets\"); static readonly string _imagesFolder = Path.Combine(_assetsPath, \"train\"); static readonly string _savePath = Path.Combine(_assetsPath, \"predict\"); static readonly string _trainTagsTsv = Path.Combine(_imagesFolder, \"tags.tsv\"); static readonly string _inceptionTensorFlowModel = Path.Combine(_assetsPath, \"inception5h\", \"tensorflow_inception_graph.pb\"); const int ImageHeight = 224; const int ImageWidth = 224; const float Mean = 117; const bool ChannelsLast = true;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a2f921490780-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a2f921490780-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a2f921490780-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a2f921490780-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a2f921490780-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a2f921490780-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a2f921490780-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a2f921490780-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a2f921490780-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a2f921490780-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a2f921490780-11\">11</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a2f921490780-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_assetsPath</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Environment</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">CurrentDirectory</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"assets\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a2f921490780-2\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_imagesFolder</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_assetsPath</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"train\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a2f921490780-3\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_savePath</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_assetsPath</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"predict\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a2f921490780-4\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_trainTagsTsv</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_imagesFolder</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"tags.tsv\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a2f921490780-5\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_inceptionTensorFlowModel</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_assetsPath</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"inception5h\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"tensorflow_inception_graph.pb\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a2f921490780-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a2f921490780-7\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImageHeight</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">224</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a2f921490780-8\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImageWidth</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">224</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a2f921490780-9\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Mean</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">117</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a2f921490780-10\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ChannelsLast</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a2f921490780-11\">&nbsp;</div></div></td></tr></tbody></table>\n\nLet’s also set this class up as a singleton and allow only one access to it at a time. We’re also going to add a webClient for downloading the image URLs.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">static readonly object _lock = new object(); private static WebClient _client = new WebClient(); private static TFEngine _instance; public static TFEngine Instance { get { lock (_lock) { if (_instance == null) { _instance = new TFEngine(); } return _instance; } } } private TFEngine() { _mlContext = new MLContext(); GenerateModel(); }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a31718684095-26\">26</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">object</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_lock</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">object</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-3\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebClient </span><span class=\"crayon-v\">_client</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebClient</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-4\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TFEngine </span><span class=\"crayon-v\">_instance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-5\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TFEngine</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Instance</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-6\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">get</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">lock</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_lock</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_instance</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_instance</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TFEngine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_instance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-17\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-19\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-20\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-21\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TFEngine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-22\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MLContext</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">GenerateModel</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a31718684095-25\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a31718684095-26\">&nbsp;</div></div></td></tr></tbody></table>\n\nWe’re also going to create some fields to hold our pipeline that will be used to create our model, the model that will be used to perform the prediction, and the MLContext.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">private IEstimator&lt;ITransformer&gt; _pipeline; private ITransformer _model; private MLContext _mlContext;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a32541091174-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a32541091174-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a32541091174-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a32541091174-4\">4</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a32541091174-1\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">IEstimator</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">ITransformer</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_pipeline</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a32541091174-2\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ITransformer </span><span class=\"crayon-v\">_model</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a32541091174-3\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MLContext </span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a32541091174-4\">&nbsp;</div></div></td></tr></tbody></table>\n\nNext add a class ImageData which will hold the image data as it passes through the model\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public class ImageData { [LoadColumn(0)] public string ImagePath; [LoadColumn(1)] public string Label; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a33100619176-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a33100619176-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a33100619176-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a33100619176-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a33100619176-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a33100619176-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a33100619176-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a33100619176-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a33100619176-9\">9</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a33100619176-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ImageData</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a33100619176-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a33100619176-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">[</span><span class=\"crayon-e\">LoadColumn</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a33100619176-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImagePath</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a33100619176-5\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a33100619176-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">[</span><span class=\"crayon-e\">LoadColumn</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a33100619176-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Label</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a33100619176-8\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a33100619176-9\">&nbsp;</div></div></td></tr></tbody></table>\n\nThen create a structure to house the prediction data as it flows out of the model:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public class ImagePrediction : ImageData { public float[] Score; public string PredictedLabelValue; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a34297915332-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a34297915332-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a34297915332-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a34297915332-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a34297915332-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a34297915332-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a34297915332-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a34297915332-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImagePrediction</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ImageData</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a34297915332-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a34297915332-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Score</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a34297915332-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a34297915332-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PredictedLabelValue</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a34297915332-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a34297915332-7\">&nbsp;</div></div></td></tr></tbody></table>\n\nThe score will be an array containing the probabilities the neural net assigns to each possible label, and the PredictedLabelValue will, of course, be prediction from the network (the item with the highest score)\n\n## Model Training\n\nNow it’s time to train our model!\n\nAdd a method called GenerateModel\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public void GenerateModel() { _pipeline = _mlContext.Transforms.LoadImages(outputColumnName: \"input\", imageFolder: _imagesFolder, inputColumnName: nameof(ImageData.ImagePath))//Loads the images from the image folder .Append(_mlContext.Transforms.ResizeImages(outputColumnName: \"input\", imageWidth: ImageWidth, imageHeight: ImageHeight, inputColumnName: \"input\"))//Resizes all of the images to a size the inception model can work with it .Append(_mlContext.Transforms.ExtractPixels(outputColumnName: \"input\", interleavePixelColors: ChannelsLast, offsetImage: Mean))//Extract pixels from the images for use .Append(_mlContext.Model.LoadTensorFlowModel(_inceptionTensorFlowModel)// Loads the tensorflow model from the inception .pb file .ScoreTensorFlowModel(outputColumnNames: new[] { \"softmax2_pre_activation\" }, inputColumnNames: new[] { \"input\" }, addBatchDimensionInput: true))// scores input images against the tensorflow models softmax2_pre_activation layer - a vector of features that might describe an input image .Append(_mlContext.Transforms.Conversion.MapValueToKey(outputColumnName: \"LabelKey\", inputColumnName: \"Label\"))// maps the ImageData's label to the output column labelKey .Append(_mlContext.MulticlassClassification.Trainers.LbfgsMaximumEntropy(labelColumnName: \"LabelKey\", featureColumnName: \"softmax2_pre_activation\"))// creates the multiclass classifier from the tensorflow model .Append(_mlContext.Transforms.Conversion.MapKeyToValue(\"PredictedLabelValue\", \"PredictedLabel\")) // for the predictor - maps the predictedlabelValue to the PredictedLabel Key .AppendCacheCheckpoint(_mlContext);// fits the training data to the model - et voila - we have our classifier IDataView trainingData = _mlContext.Data.LoadFromTextFile&lt;ImageData&gt;(path: _trainTagsTsv, hasHeader: false); _model = _pipeline.Fit(trainingData); }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a36433925067-15\">15</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a36433925067-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">GenerateModel</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a36433925067-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a36433925067-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_pipeline</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Transforms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">LoadImages</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">outputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"input\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageFolder</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_imagesFolder</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">nameof</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ImageData</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ImagePath</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//Loads the images from the image folder</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a36433925067-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Transforms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ResizeImages</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">outputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"input\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageWidth</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImageWidth</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageHeight</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImageHeight</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"input\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//Resizes all of the images to a size the inception model can work with it</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a36433925067-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Transforms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ExtractPixels</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">outputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"input\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">interleavePixelColors</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ChannelsLast</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">offsetImage</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Mean</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//Extract pixels from the images for use</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a36433925067-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Model</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">LoadTensorFlowModel</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_inceptionTensorFlowModel</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">// Loads the tensorflow model from the inception .pb file</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a36433925067-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ScoreTensorFlowModel</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">outputColumnNames</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"softmax2_pre_activation\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inputColumnNames</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"input\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">addBatchDimensionInput</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">// scores input images against the tensorflow models softmax2_pre_activation layer - a vector of features that might describe an input image</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a36433925067-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Transforms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Conversion</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">MapValueToKey</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">outputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"LabelKey\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Label\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">// maps the ImageData's label to the output column labelKey</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a36433925067-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">MulticlassClassification</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Trainers</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">LbfgsMaximumEntropy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">labelColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"LabelKey\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">featureColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"softmax2_pre_activation\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">// creates the multiclass classifier from the tensorflow model</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a36433925067-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Transforms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Conversion</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">MapKeyToValue</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"PredictedLabelValue\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"PredictedLabel\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// for the predictor - maps the predictedlabelValue to the PredictedLabel Key</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a36433925067-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AppendCacheCheckpoint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">// fits the training data to the model - et voila - we have our classifier</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a36433925067-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">IDataView </span><span class=\"crayon-v\">trainingData</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Data</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">LoadFromTextFile</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">ImageData</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">path</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_trainTagsTsv</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hasHeader</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a36433925067-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_model</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_pipeline</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Fit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">trainingData</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a36433925067-14\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a36433925067-15\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis is really the heart of what’s going to make our predictor work. The ‘\\_pipeline =’ section is a chain of commands that will:\n\n*   Load the images off of the disk\n*   Resize the images for ingestion\n*   Extract and vectorize the pixels in the images\n*   Load the inception TensorFlow model (essentially our pre-made neural net)\n*   Create a training model and run the training data through it to create a prediction model for us to use\n\n### Classifying a Single Image\n\nWith our model trained we can now go about creating a method that will take in a file name and return a string containing a prediction and the networks confidence in the prediction. This function takes an imageUrl, saves the file to the disk, classifies the image and returns a string containing the classifiers guess with its confidence.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public string ClassifySingleImage(string imageUrl) { try { var filename = Path.Combine(_savePath, $\"{Guid.NewGuid()}.jpg\"); _client.DownloadFile(imageUrl, filename); var imageData = new ImageData() { ImagePath = filename }; var predictor = _mlContext.Model.CreatePredictionEngine&lt;ImageData, ImagePrediction&gt;(_model); var prediction = predictor.Predict(imageData); var response = $\"I'm about {prediction.Score.Max() * 100}% sure that the image you sent me is a {prediction.PredictedLabelValue}\"; Console.WriteLine($\"Image: {Path.GetFileName(imageData.ImagePath)} predicted as: {prediction.PredictedLabelValue} with score: {prediction.Score.Max() * 100} \"); return response; } catch (Exception) { return \"Something went wrong when trying to classify image\"; } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a37042925743-23\">23</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ClassifySingleImage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a37042925743-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a37042925743-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">filename</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_savePath</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"{Guid.NewGuid()}.jpg\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a37042925743-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_client</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">DownloadFile</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">filename</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageData</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ImageData</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a37042925743-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">ImagePath</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">filename</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a37042925743-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-11\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a37042925743-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">predictor</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Model</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">CreatePredictionEngine</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">ImageData</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImagePrediction</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_model</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">prediction</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">predictor</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Predict</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">imageData</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a37042925743-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">response</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"I'm about {prediction.Score.Max() * 100}% sure that the image you sent me is a {prediction.PredictedLabelValue}\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"Image: {Path.GetFileName(imageData.ImagePath)} predicted as: {prediction.PredictedLabelValue} with score: {prediction.Score.Max() * 100} \"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a37042925743-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a37042925743-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Exception</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a37042925743-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Something went wrong when trying to classify image\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a37042925743-22\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a37042925743-23\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Adding Training Data\n\nThe final operation we’re going to ask of the Tensor Flow Engine is essentially the reverse of prediction, we’ll ask it to accept an image URL and label and update itself to better recognize images of that label. The AddTrainingImage saves the provided image to disk, appends information about that images to the tags.tsv file, and regenerates the model.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public string AddTrainingImage(string imageUrl, string label) { try { var id = Guid.NewGuid(); var fileName = Path.Combine(_imagesFolder, $\"{id}.jpg\"); _client.DownloadFile(imageUrl, fileName); File.AppendAllText(_trainTagsTsv, $\"{id}.jpg\\t{label}\" + Environment.NewLine); IDataView trainingData = _mlContext.Data.LoadFromTextFile&lt;ImageData&gt;(path: _trainTagsTsv, hasHeader: false); _model = _pipeline.Fit(trainingData); return $\"I have trained myself to recognize the image you sent me as a {label}. Your teaching is appreciated\"; } catch (Exception) { return \"something went wrong when trying to train on image\"; } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3a444913328-18\">18</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3a444913328-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AddTrainingImage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">label</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3a444913328-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3a444913328-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3a444913328-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3a444913328-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Guid</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">NewGuid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3a444913328-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fileName</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_imagesFolder</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"{id}.jpg\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3a444913328-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_client</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">DownloadFile</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fileName</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3a444913328-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">File</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AppendAllText</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_trainTagsTsv</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"{id}.jpg\\t{label}\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Environment</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NewLine</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3a444913328-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">IDataView </span><span class=\"crayon-v\">trainingData</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Data</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">LoadFromTextFile</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">ImageData</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">path</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_trainTagsTsv</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hasHeader</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3a444913328-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_model</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_pipeline</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Fit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">trainingData</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3a444913328-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"I have trained myself to recognize the image you sent me as a {label}. Your teaching is appreciated\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3a444913328-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3a444913328-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Exception</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3a444913328-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3a444913328-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"something went wrong when trying to train on image\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3a444913328-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3a444913328-17\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3a444913328-18\">&nbsp;</div></div></td></tr></tbody></table>\n\n## Using the Messages API to Drive Classification and Training\n\n### Messages Objects\n\nNext we’re going to add some POCOs to hold our messaging data as it comes in and goes out to the Messages API – these objects are fairly verbose and don’t do anything particularly interesting aside from allowing the serialization / deserialization of JSON so, for the sake of brevity feel free to simply use the following structures:\n\n*   [StatusMessage.cs](https://github.com/slorello89/MessagesTensorFlow/blob/master/MessagesTensorFlow/StatusMessage.cs)\n*   [InboundMessage.cs](https://github.com/slorello89/MessagesTensorFlow/blob/master/MessagesTensorFlow/InboundMessage.cs)\n*   [MessageRequest.cs](https://github.com/slorello89/MessagesTensorFlow/blob/master/MessagesTensorFlow/MessageRequest.cs)\n\n### Interacting With the API\n\nCreating these structures frees us up to manage the data we are getting from and sending out to the Messages API. However we need one more step to enable us to actually use the API – we’ll need to generate a JWT to authenticate our application with the Messages API. To this end, let’s create the following files.\n\n*   TokenGenerator.cs\n*   MessageSender.cs\n\n#### Generate JWT\n\nTokenGenerator is going to have one static method GenerateToken which will accept a list of Claims and the privateKey for your application\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">using Org.BouncyCastle.Crypto.Parameters; using Org.BouncyCastle.OpenSsl; using Org.BouncyCastle.Security; using System.Collections.Generic; using System.IO; using System.Linq; using System.Security.Claims; using System.Security.Cryptography; namespace MessagesTensorFlow { public class TokenGenerator { public static string GenerateToken(List&lt;Claim&gt; claims, string privateKey) { RSAParameters rsaParams; using (var tr = new StringReader(privateKey)) { var pemReader = new PemReader(tr); var kp = pemReader.ReadObject(); var privateRsaParams = kp as RsaPrivateCrtKeyParameters; rsaParams = DotNetUtilities.ToRSAParameters(privateRsaParams); } using (RSACryptoServiceProvider rsa = new RSACryptoServiceProvider()) { rsa.ImportParameters(rsaParams); Dictionary&lt;string, object&gt; payload = claims.ToDictionary(k =&gt; k.Type, v =&gt; (object)v.Value); return Jose.JWT.Encode(payload, rsa, Jose.JwsAlgorithm.RS256); } } } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3c294309624-33\">33</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-1\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">Org</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">BouncyCastle</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Crypto</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Parameters</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-2\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">Org</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">BouncyCastle</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">OpenSsl</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-3\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">Org</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">BouncyCastle</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Security</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-4\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Collections</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Generic</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-5\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">IO</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-6\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Linq</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-7\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Security</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Claims</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-8\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Security</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Cryptography</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-9\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-10\"><span class=\"crayon-t\">namespace</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MessagesTensorFlow</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-11\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TokenGenerator</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">GenerateToken</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">List</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">Claim</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">claims</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">RSAParameters </span><span class=\"crayon-v\">rsaParams</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tr</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StringReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pemReader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">PemReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tr</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">kp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pemReader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReadObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">privateRsaParams</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">kp </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RsaPrivateCrtKeyParameters</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">rsaParams</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DotNetUtilities</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToRSAParameters</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">privateRsaParams</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">RSACryptoServiceProvider </span><span class=\"crayon-v\">rsa</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RSACryptoServiceProvider</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">rsa</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ImportParameters</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">rsaParams</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Dictionary</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">object</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">payload</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">claims</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToDictionary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Type</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">v</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">object</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">v</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Jose</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">JWT</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Encode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">payload</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">rsa</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Jose</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">JwsAlgorithm</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">RS256</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3c294309624-32\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3c294309624-33\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis will generate a JWT for your usage with the Messages API.\n\n#### Generate a Claims List for JWT\n\nIn the MessageSender.cs we’ll have a method to generate the claims for the JWT from your appId:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">private static List&lt;Claim&gt; GetClaimsList(string appId) { const int SECONDS_EXPIRY = 3600; var t = DateTime.UtcNow - new DateTime(1970, 1, 1); var iat = new Claim(\"iat\", ((Int32)t.TotalSeconds).ToString(), ClaimValueTypes.Integer32); // Unix Timestamp for right now var application_id = new Claim(\"application_id\", appId); // Current app ID var exp = new Claim(\"exp\", ((Int32)(t.TotalSeconds + SECONDS_EXPIRY)).ToString(), ClaimValueTypes.Integer32); // Unix timestamp for when the token expires var jti = new Claim(\"jti\", Guid.NewGuid().ToString()); // Unique Token ID var claims = new List&lt;Claim&gt;() { iat, application_id, exp, jti }; return claims; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3d430178431-13\">13</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3d430178431-1\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">List</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">Claim</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">GetClaimsList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">appId</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3d430178431-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3d430178431-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SECONDS_EXPIRY</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3600</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3d430178431-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DateTime</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">UtcNow</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DateTime</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1970</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3d430178431-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"iat\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Int32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">TotalSeconds</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClaimValueTypes</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Integer32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Unix Timestamp for right now</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3d430178431-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">application_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"application_id\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">appId</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Current app ID</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3d430178431-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">exp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"exp\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Int32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">TotalSeconds</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SECONDS_EXPIRY</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClaimValueTypes</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Integer32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Unix timestamp for when the token expires</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3d430178431-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jti</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"jti\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Guid</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">NewGuid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Unique Token ID</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3d430178431-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">claims</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">List</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">Claim</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iat</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">application_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">exp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">jti</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3d430178431-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3d430178431-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">claims</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3d430178431-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3d430178431-13\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Read App Settings and Create JWT\n\nThen we’ll have another method to read the relevant items out of your configuration, which the controller will hand us through Dependency Injection, retrieve the claims list, and build the JWT\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">private static string BuildJwt(IConfiguration config) { var appId = config[\"Authentication:appId\"]; var priavteKeyPath = config[\"Authentication:privateKey\"]; string privateKey = \"\"; using (var reader = File.OpenText(priavteKeyPath)) // file containing RSA PKCS1 private key privateKey = reader.ReadToEnd(); var jwt = TokenGenerator.GenerateToken(GetClaimsList(appId), privateKey); return jwt; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a3f579443499-12\">12</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3f579443499-1\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BuildJwt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3f579443499-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3f579443499-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">appId</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">\"Authentication:appId\"</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3f579443499-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">priavteKeyPath</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">\"Authentication:privateKey\"</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3f579443499-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3f579443499-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">reader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">File</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">OpenText</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">priavteKeyPath</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// file containing RSA PKCS1 private key</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3f579443499-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">reader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReadToEnd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3f579443499-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3f579443499-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TokenGenerator</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GenerateToken</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">GetClaimsList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">appId</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3f579443499-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a3f579443499-11\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a3f579443499-12\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis will of course require a couple of items in your appsettings.json file Add the following object to your appsettings.json file and fill in with the appropriate values:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\"Authentication\": { \"appId\": \"app_id\", \"privateKey\": \"path_to_key_file\" }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a40541339888-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a40541339888-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a40541339888-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a40541339888-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a40541339888-5\">5</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a40541339888-1\"><span class=\"crayon-s\">\"Authentication\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a40541339888-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"appId\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"app_id\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a40541339888-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"privateKey\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"path_to_key_file\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a40541339888-4\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a40541339888-5\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Send a Message\n\nNow we’re going to tie this all together with our SendMessage method, which will take our message, toId, fromId, and config. This method will generate a JWT and send along a request to the Messages API to send a message containing the feedback from our classifier to our end user.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public static void SendMessage(string message, string fromId, string toId, IConfiguration config) { const string MESSAGING_URL = @\"https://api.nexmo.com/v0.1/messages\"; try { var jwt = BuildJwt(config); var requestObject = new MessageRequest() { to = new MessageRequest.To() { id = toId, type = \"messenger\" }, from = new MessageRequest.From() { id = fromId, type = \"messenger\" }, message = new MessageRequest.Message() { content = new MessageRequest.Message.Content() { type = \"text\", text = message }, messenger = new MessageRequest.Message.Messenger() { category = \"RESPONSE\" } } }; var requestPayload = JsonConvert.SerializeObject(requestObject, new JsonSerializerSettings() { NullValueHandling = NullValueHandling.Ignore, DefaultValueHandling = DefaultValueHandling.Ignore }); var httpWebRequest = (HttpWebRequest)WebRequest.Create(MESSAGING_URL); httpWebRequest.ContentType = \"application/json\"; httpWebRequest.Accept = \"application/json\"; httpWebRequest.Method = \"POST\"; httpWebRequest.PreAuthenticate = true; httpWebRequest.Headers.Add(\"Authorization\", \"Bearer \" + jwt); using (var streamWriter = new StreamWriter(httpWebRequest.GetRequestStream())) { streamWriter.Write(requestPayload); } using (var httpResponse = (HttpWebResponse)httpWebRequest.GetResponse()) { using (var streamReader = new StreamReader(httpResponse.GetResponseStream())) { var result = streamReader.ReadToEnd(); Console.WriteLine(result); Console.WriteLine(\"Message Sent\"); } } } catch (Exception e) { Debug.WriteLine(e.ToString()); } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a41514114987-59\">59</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SendMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fromId</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">toId</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MESSAGING_URL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-s\">\"https://api.nexmo.com/v0.1/messages\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BuildJwt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">requestObject</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MessageRequest</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">To</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">toId</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"messenger\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">From</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fromId</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"messenger\"</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">message</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Message</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">content</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Content</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"text\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">text</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">message</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">messenger</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Messenger</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">category</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"RESPONSE\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">requestPayload</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">JsonConvert</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SerializeObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">requestObject</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">JsonSerializerSettings</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NullValueHandling</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NullValueHandling</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Ignore</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DefaultValueHandling</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DefaultValueHandling</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">Ignore</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">HttpWebRequest</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">WebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Create</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">MESSAGING_URL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ContentType</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"application/json\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-36\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Accept</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"application/json\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Method</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"POST\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">PreAuthenticate</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Headers</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"Authorization\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Bearer \"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-40\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">streamWriter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StreamWriter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetRequestStream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-41\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-42\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">streamWriter</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">requestPayload</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-43\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-44\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">httpResponse</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">HttpWebResponse</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetResponse</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-45\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-46\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">streamReader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StreamReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">httpResponse</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetResponseStream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-47\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-48\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">streamReader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReadToEnd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-49\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-50\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"Message Sent\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-51\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-52\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-53\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-54\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Exception</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-55\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-56\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Debug</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-57\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a41514114987-58\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a41514114987-59\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Classification Handler\n\nWe’re going to want the handling of inbound webhooks to be asynchronous and respond immediately, so we’re going to create a ClassificationHandler.cs file to actually handle the classify / reply operations. This file will contain a couple of small structures to allow us to unpack, classify or train, and reply to inbound messages.\n\nIn ClassificationHandler.cs add the following code:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public static void ClassifyAndRespond(object state) { var request = state as ClassifyRequest; var response = TFEngine.Instance.ClassifySingleImage(request.imageUrl); MessageSender.SendMessage(response, request.toId, request.fromid, request.Configuration); } public static void AddTrainingData(object state) { var request = state as TrainRequest; var response = TFEngine.Instance.AddTrainingImage(request.imageUrl, request.Label); MessageSender.SendMessage(response, request.toId, request.fromid, request.Configuration); } public class TrainRequest : Request { public string Label { get; set; } } public class ClassifyRequest : Request{} public abstract class Request { public string imageUrl { get; set; } public string toId { get; set; } public string fromid { get; set; } public IConfiguration Configuration { get; set; } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a43528780859-27\">27</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ClassifyAndRespond</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">object</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">state</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">state </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClassifyRequest</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">response</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TFEngine</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Instance</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ClassifySingleImage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">MessageSender</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SendMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">toId</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">fromid</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-8\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AddTrainingData</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">object</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">state</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-9\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">state </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TrainRequest</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">response</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TFEngine</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Instance</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddTrainingImage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Label</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">MessageSender</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SendMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">toId</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">fromid</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-13\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-14\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TrainRequest</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Request</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-15\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Label</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-17\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-18\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClassifyRequest</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Request</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-19\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">abstract</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Request</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-20\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">imageUrl</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">toId</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">fromid</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-24\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IConfiguration</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a43528780859-26\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a43528780859-27\">&nbsp;</div></div></td></tr></tbody></table>\n\n## Handle Incoming Messages Webhooks\n\nFrom our code’s perspective the final thing we’re going to need to do is to create a couple of controllers to handle the incoming messages and status from the Messages API.\n\nIn the Controllers folder, add 2 “API controller – Empty” called InboundController and StatusController.\n\n### Status Controller\n\nThe Status controller is going to provide status to our application’s messages as they flow through the API, to keep track of what’s going on, let’s add a post method to the Status controller to write the status contents out to the debug console:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">[HttpPost] public HttpStatusCode Post([FromBody]StatusMessage message) { Debug.WriteLine(JsonConvert.SerializeObject(message)); return HttpStatusCode.NoContent; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a44383532650-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a44383532650-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a44383532650-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a44383532650-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a44383532650-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a44383532650-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a44383532650-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a44383532650-1\"><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">HttpPost</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a44383532650-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HttpStatusCode </span><span class=\"crayon-e\">Post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">FromBody</span><span class=\"crayon-sy\">]</span><span class=\"crayon-e\">StatusMessage </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a44383532650-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a44383532650-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Debug</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">JsonConvert</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SerializeObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a44383532650-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpStatusCode</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NoContent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a44383532650-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a44383532650-7\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Inbound Controller\n\nThe Inbound Controller is going to be managing the Inbound Messages from our webhook.\n\n#### Class Setup\n\nLet’s first set it up by creating a dictionary for the pending training labels, a Configuration object for the controller to access the configuration, and by Dependency Injecting the Configuration into the Inbound Controller constructor:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public static Dictionary&lt;string, string&gt; _pendingTrainLabels = new Dictionary&lt;string, string&gt;(); public IConfiguration Configuration { get; set; } public InboundController(IConfiguration configuration) { Configuration = configuration; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a46106025349-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a46106025349-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a46106025349-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a46106025349-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a46106025349-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a46106025349-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a46106025349-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a46106025349-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Dictionary</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Dictionary</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a46106025349-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IConfiguration</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a46106025349-3\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">InboundController</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">configuration</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a46106025349-4\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a46106025349-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">configuration</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a46106025349-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a46106025349-7\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Handling Inbound Messages\n\nNext, we’ll write the actual InboundMessage handler. This handler will be a POST request. It will check to see if there’s any text in the message. If there is, it will see if the first word in that message is ‘train.’ If so it will save the rest of the message as a training label, and the next time that user sends a message with a picture, the classifier will be trained with that image and label.\n\nOn any other image message it will simply classify the image and send the output of the classification back to the message sender.\n\nIn both cases it starts a WorkItem in the ThreadPool, passing in one of those handy ClassificationHandler request objects we generated earlier – this unblocks the controller to send a status back to the messages api (in this case a 204 to inform it that it received the message)\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">[HttpPost] public HttpStatusCode Post([FromBody]InboundMessage message) { const string TRAIN = \"train\"; try { Debug.WriteLine(JsonConvert.SerializeObject(message)); if (!string.IsNullOrEmpty(message.message.content.text)) { var split = message.message.content.text.Split(new[] { ' ' }, 2); if (split.Length &gt; 1) { if (split[0].ToLower() == TRAIN) { var label = split[1]; var requestor = message.from.id; if (!_pendingTrainLabels.ContainsKey(requestor)) { _pendingTrainLabels.Add(requestor, label); } else { _pendingTrainLabels[requestor] = label; } } } } if (_pendingTrainLabels.ContainsKey(message.from.id) &amp;&amp; message.message.content?.image?.url != null) { ThreadPool.QueueUserWorkItem(ClassificationHandler.AddTrainingData, new ClassificationHandler.TrainRequest() { toId = message.to.id, fromid = message.from.id, imageUrl = message.message.content.image.url, Label = _pendingTrainLabels[message.from.id], Configuration = Configuration }); _pendingTrainLabels.Remove(message.from.id); } else { ThreadPool.QueueUserWorkItem(ClassificationHandler.ClassifyAndRespond, new ClassificationHandler.ClassifyRequest() { toId = message.to.id, fromid = message.from.id, imageUrl = message.message.content.image.url, Configuration = Configuration }); } return HttpStatusCode.NoContent; } catch (Exception ex) { return HttpStatusCode.NoContent; } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a47339601747-59\">59</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-1\"><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">HttpPost</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HttpStatusCode </span><span class=\"crayon-e\">Post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">FromBody</span><span class=\"crayon-sy\">]</span><span class=\"crayon-e\">InboundMessage </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TRAIN</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"train\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Debug</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">JsonConvert</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SerializeObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">IsNullOrEmpty</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">split</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Split</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">' '</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">split</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Length</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">split</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToLower</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TRAIN</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">label</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">split</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">requestor</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ContainsKey</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">requestor</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">requestor</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">label</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">requestor</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">label</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ContainsKey</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">?</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">image</span><span class=\"crayon-sy\">?</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">url</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">ThreadPool</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">QueueUserWorkItem</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ClassificationHandler</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">AddTrainingData</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClassificationHandler</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">TrainRequest</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">toId</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">to</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">fromid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">image</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">url</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Label</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-36\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Configuration</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Remove</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-40\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-41\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-42\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">ThreadPool</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">QueueUserWorkItem</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ClassificationHandler</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ClassifyAndRespond</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-43\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClassificationHandler</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ClassifyRequest</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-44\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-45\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">toId</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">to</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-46\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">fromid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-47\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">image</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">url</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-48\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Configuration</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-49\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-50\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-51\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-52\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpStatusCode</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NoContent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-53\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-54\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Exception </span><span class=\"crayon-v\">ex</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-55\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-56\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpStatusCode</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NoContent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-57\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a47339601747-58\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a47339601747-59\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Seeding With a Little Data.\n\nYou can add whatever images and tags you want to get yourself started. For the sake of simplicity I’m only going to start with one image – an image of my dog (aptly named Zero).\n\n![Zero](https://www.nexmo.com/wp-content/uploads/2019/10/zero.png)\n\nI’m going to put that image in the assets/train directory.\n\nNow since Zero is a whippet, I’m going to, in the tags.tsv file in the assets/train folder, add the file name ‘zero.jpg’ followed by a tab, followed by the label ‘whippet’ followed by a new line\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">zero.jpg whippet</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff0a48693758894-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff0a48693758894-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff0a48693758894-1\"><span class=\"crayon-v\">zero</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">jpg&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-i\">whippet</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff0a48693758894-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n## Testing\n\nWith this done, all that’s left to do is fire it up, expose it to the internet, and test it out. I use ngrok and IIS express to test it.\n\n### IIS Express Config\n\nFirst go into the project properties debug tab and look for the App Url – specifically which port it’s going to be using – I uncheck the Enable SSL box for testing.\n\n[![](https://www.nexmo.com/wp-content/uploads/2019/10/IIS_Config.png)](https://www.nexmo.com/wp-content/uploads/2019/10/IIS_Config.png)\n\nThen launch the site from visual studio using IIS Express – you’ll see the port in the address bar of the browser which pops up – in my sample I cleaned out all the weather controller stuff that comes out of the box so I get a 404 when I fire it up – which is fine as this is really only acting as a web service to listen for and reply to webhooks. There isn’t any get requests to propagate a page back to your web browser.\n\n### Using Ngrok to Expose the Port to the Internet\n\nFor the Messages API to forward the messages we’ll need to expose the site to the internet – for testing purposes, we’ll use [ngrok](https://ngrok.com) to expose our IIS express port. Open up your command line and use this command, replace with your port number.\n\n`ngrok http --host-header=\"localhost:\" http://localhost:`\n\nThis command produces an output like this:\n\n[![](https://www.nexmo.com/wp-content/uploads/2019/10/ngrok.png)](https://www.nexmo.com/wp-content/uploads/2019/10/ngrok.png)\n\n### Configuring the Webhooks\n\nUsing the http link we just got from ngrok you can create the url that the webhook will be calling back on – you can see in the Route of the controllers we just made what the route will look like:  \n[![](https://www.nexmo.com/wp-content/uploads/2019/10/controllerExample.png)](https://www.nexmo.com/wp-content/uploads/2019/10/controllerExample.png)  \nIt’s going to work out to be  \n`http://dc0feb1d.ngrok.io/api/Status` for status messages  \nand  \n`http://dc0feb1d.ngrok.io/api/Inbound` for inbound messages\n\nNOTE: The first part of the url (dc0feb1d) will change whenever you restart ngrok on the free tier.\n\nWe’ll use those callback URLs to register our webhooks with Nexmo.\n\nGo To https://dashboard.nexmo.com and login to your Nexmo account\n\nGo to messages and dispatch -> Your applications and select the edit button for your application\n\nOn the edit screen change the Status URL and Inbound URL fields to the noted values above and click the blue save button in the lower right hand corner.\n\nAnd that’s it. Now you have a classifier / learner that you can feed images over messenger.\n\n## Helpful Links\n\n*   [The full overview of the Messages API](https://developer.nexmo.com/messages/overview)\n*   [All the code from this tutorial](https://github.com/slorello89/MessagesTensorFlow)\n*   [ML.NET Tensor Flow documentation](https://docs.microsoft.com/en-us/dotnet/machine-learning/tutorials/image-classification) for more information about ML.NET Tensor Flow – in fact, the TFEngine’s GenerateModel function is derived from this tutorial."}