{"_filedata":{"slug":"aws-transcribe-with-nexmo-voice-using-php-dr"},"title":"AWS Transcribe With Nexmo Voice Using PHP","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2020/02/E_Voice-Transcription-PHP_1200x600.png","author":340,"published":true,"published_at":"2020-02-14T18:13:59","tags":[499,416,360,1550,200,949,455,1312,203,595],"body":"Use cases for voice transcription are becoming more and more prevalent—from IoT devices, which often only have an audio interface, to voice messaging services, which are expected to provide realtime text previews of message contents, speech-to-text capabilities are becoming essential for a wide variety of applications.\n\nIn this tutorial, we’ll use a [Nexmo Voice](https://www.nexmo.com/products/voice) number to create a callback script that interacts with a caller to prompt for a voice message. Then, after retrieving the contents of the recording, we’ll request a voice transcription from [Amazon Transcribe](https://aws.amazon.com/transcribe/).\n\n### Prerequisites\n\nIn this example the following are needed:\n\n*   [PHP](https://www.php.net/) installed locally (version 7.3+ preferred)\n*   Composer installed [globally](https://getcomposer.org/doc/00-intro.md#globally) (more details later)\n*   [Nexmo](https://www.nexmo.com/) account\n*   [AWS](https://aws.amazon.com/) account\n*   [ngrok](https://ngrok.io) installed locally (more details later)\n\nFor a completed code example go to [https://github.com/nexmo-community/voice-aws-speechtotext-php](https://github.com/nexmo-community/voice-aws-speechtotext-php).\n\n### AWS Setup\n\nYou’ll need an AWS account, as well as [IAM credentials](https://aws.amazon.com/iam/) associated with a user who has access to [Amazon Transcribe](https://aws.amazon.com/transcribe/) and [AWS S3](https://aws.amazon.com/s3/).\n\n#### Create An S3 Bucket\n\nCreate an S3 Bucket to store the voice recording MP3 files retrieved from Nexmo. This will allow Amazon Transcribe to easily access the files to be transcribed later.\n\nAfter creating it, make sure to check the box beside the bucket name. This will cause a panel to shift in from the right. Click the button “Copy Bucket ARN” and save it for later usage.\n\n#### Creating An IAM User\n\nSelect the IAM Management Console from the Services panel:\n\n![Select IAM Management Console](/wp-content/uploads/2020/02/select_iam_management.png \"Select IAM Management Console\")\n\nFrom the IAM Management Console, add a new IAM user by clicking the blue Add User button:\n\n![AWS new IAM user](/wp-content/uploads/2020/02/aws_new_iam_user.png \"Add a new IAM user\")\n\nBelow is a JSON snippet to assign the permissions needed for the new user to utilize S3 and the Transcribe services. Make sure to replace `{bucket_name}` with the actual bucket name. The `Resource` in the JSON should match the ARN you saved from S3 after creating the bucket:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"VisualEditor0\", \"Effect\": \"Allow\", \"Action\": \"transcribe:*\", \"Resource\": \"*\" }, { \"Sid\": \"VisualEditor1\", \"Effect\": \"Allow\", \"Action\": [ \"s3:PutObject\", \"s3:GetObject\", \"s3:DeleteObject\" ], \"Resource\": \"arn:aws:s3:::{bucket_name}/*\" } ] }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde068737081630-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde068737081630-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde068737081630-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde068737081630-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde068737081630-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde068737081630-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde068737081630-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde068737081630-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde068737081630-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde068737081630-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde068737081630-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde068737081630-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde068737081630-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde068737081630-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde068737081630-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde068737081630-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde068737081630-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde068737081630-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde068737081630-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde068737081630-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde068737081630-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde068737081630-22\">22</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde068737081630-1\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde068737081630-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Version\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"2012-10-17\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde068737081630-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Statement\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde068737081630-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde068737081630-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Sid\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"VisualEditor0\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde068737081630-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Effect\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Allow\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde068737081630-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Action\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"transcribe:*\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde068737081630-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Resource\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"*\"</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde068737081630-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde068737081630-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde068737081630-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Sid\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"VisualEditor1\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde068737081630-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Effect\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Allow\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde068737081630-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Action\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde068737081630-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"s3:PutObject\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde068737081630-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"s3:GetObject\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde068737081630-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"s3:DeleteObject\"</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde068737081630-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde068737081630-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Resource\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"arn:aws:s3:::{bucket_name}/*\"</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde068737081630-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde068737081630-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde068737081630-21\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde068737081630-22\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Application Base\n\nAt this point, we need to start organizing the application itself. We will assume an empty directory, and begin building the example callback app from there. We will also assume a local system with PHP already set up and running, and able to be used via CLI (Command Line Interface).\n\nIn this empty directory, create a new PHP file and name it `index.php`. At the moment, just type the word “test” in the file. This will create some output and allow us to test in the next step.\n\n### PHP Built-in Webserver And ngrok\n\nIn this example, we will run a PHP application locally with the [PHP built-in webserver](https://www.php.net/manual/en/features.commandline.webserver.php). Though the built-in web server should not be used in a production environment, it is fine for sample scripts like this.\n\nUsing a terminal, navigate to the project directory. Once there, issue the command to start the PHP built-in web server, like so:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">php -S localhost:8080</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde06c154935609-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde06c154935609-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde06c154935609-1\"><span class=\"crayon-v\">php</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">S</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">localhost</span><span class=\"crayon-o\">:</span><span class=\"crayon-cn\">8080</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde06c154935609-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nAt this point, entering “http://localhost:8080” in a browser should produce a “test” response, if that is what you entered in the `index.php` file.\n\nWe’ll also use [ngrok](https://ngrok.io) to make the local application available on the internet as a callback endpoint for the Nexmo Voice service. Take a look at [this page](https://www.nexmo.com/blog/2017/07/04/local-development-nexmo-ngrok-tunnel-dr) if you need help getting ngrok set up, but the basics are: create an account at ngrok, download the executable, kick off a tunnel via CLI, and then use the forwarding URLs provided by the CLI.\n\nNext, get ngrok running to make the results of the webserver available over the internet. In a terminal, navigate to the location where ngrok was installed previously, and enter the following command:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">./ngrok http 8080</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde06e669906126-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde06e669906126-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde06e669906126-1\"><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">ngrok </span><span class=\"crayon-i\">http</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">8080</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde06e669906126-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nIn return, ngrok will provide us with some important information, as in the screenshot below:\n\n![ngrok information returned](/wp-content/uploads/2020/01/ngrok_output.png \"ngrok information returned\")\n\nThis lets us know the service information, including the tunnel URLs to use for hitting our locally running script. We can enter the information provided in a web browser and should get the same results as when requesting via localhost above.\n\n> Note: It’s recommended using https URLs to protect any credentials being shared between the services.\n\nWe will let the ngrok instance run throughout this example. When you are ready to shut it down, simply hit “Ctrl+c” in the terminal and it will close ngrok.\n\n### Nexmo Setup\n\nWith the URLs provided by ngrok, we can add an Application in Nexmo and link it to a number. In the Nexmo Dashboard, expand the Numbers menu item to expose “Your numbers” (and add a new one if needed):\n\n![nexmo_dashboard](/wp-content/uploads/2020/01/nexmo_dashboard.png \"Nexmo Dashboard\")\n\nNow that we’re sure there is a number to be used in an application, in the left-hand menu, click “Your applications” followed by “Create a new application”:\n\n![create_application](/wp-content/uploads/2020/02/create_application.png \"Create Application\")\n\nGive the application a good name, then click the button to generate a public and private key in the Authentication area, saving the `private.key` in the app newly created app directory above:\n\n![authentication_keys](/wp-content/uploads/2020/02/authentication_keys.png \"Authentication Keys\")\n\nToggle the Voice Capability and add the URL given by ngrok above in the fields:\n\n![voice_urls](/wp-content/uploads/2020/02/voice_urls.png \"Voice URLs\")\n\nThis instructs Nexmo to make callbacks when specific events happen, and we want those callbacks to point to the new app we will be creating.\n\nThe Event URL will be used when any event changes the status of a call, while the Answer URL is requested for any inbound calls to retrieve an NCCO object ([Nexmo Call Control Object](https://developer.nexmo.com/voice/voice-api/ncco-reference)).\n\nFinally, click the button at the bottom to “Generate new application”.\n\nJust one more step to ensure this new application works as expected. From the Your Applications board, click into the newly created application. Toward the bottom of the page, there will be a list of available numbers in the account. Click the button to “Link” the application with the desired number:\n\n![link_the_app](/wp-content/uploads/2020/02/link_the_app.png \"Link the app\")\n\nNow we are finished with the Nexmo setup. Time to start building the app!\n\n### Composer\n\nIn the project folder, we need to init Composer, enabling us to include a few packages/dependencies. Navigate to the project directory and issue the following command.:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">composer init</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde06f014290794-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde06f014290794-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde06f014290794-1\"><span class=\"crayon-e\">composer </span><span class=\"crayon-i\">init</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde06f014290794-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nThe latest versions of Composer now perform a step-by-step process to help set up a project. Follow through the prompts and fill out as desired. Make sure to include these packages:\n\n#### Required Dependencies\n\nTo complete the wizard in the previous section, or to manually set up a `composer.json` file, include the following dependencies for this example:\n\n*   [vlucas/phpdotenv](https://github.com/vlucas/phpdotenv) – stores credentials in the superglobal $\\_ENV\n*   [slim/slim](http://www.slimframework.com/) – light microframework that makes handling HTTP calls and callbacks easy\n*   [slim/psr7](http://www.slimframework.com/docs/v4/concepts/value-objects.html) – facilitates HTTP interoperability between libraries\n*   [nexmo/client](https://developer.nexmo.com/tools) – for all things Nexmo, which will also bring in Guzzle as a dependency\n*   [league/flysystem-aws-s3-v3](https://flysystem.thephpleague.com/v1/docs/adapter/aws-s3-v2/) – to abstract the usage of S3, which will also bring in the AWS SDK as a dependency\n\nCompleted `composer.json` example:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">{ \"require\": { \"ext-json\": \"used for JSON handling\", \"slim/slim\": \"4.2.0\", \"slim/psr7\": \"0.5\", \"vlucas/phpdotenv\": \"3.5.x-dev\", \"nexmo/client\": \"2.0.0\", \"league/flysystem-aws-s3-v3\": \"1.0.23\" } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde071679097633-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde071679097633-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde071679097633-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde071679097633-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde071679097633-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde071679097633-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde071679097633-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde071679097633-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde071679097633-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde071679097633-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde071679097633-11\">11</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde071679097633-1\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde071679097633-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"require\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde071679097633-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"ext-json\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-s\">\"used for JSON handling\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde071679097633-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"slim/slim\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"4.2.0\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde071679097633-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"slim/psr7\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"0.5\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde071679097633-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"vlucas/phpdotenv\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"3.5.x-dev\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde071679097633-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"nexmo/client\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"2.0.0\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde071679097633-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"league/flysystem-aws-s3-v3\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"1.0.23\"</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde071679097633-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde071679097633-10\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde071679097633-11\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Composer Install\n\nWith all dependencies added to Composer, we are now ready to install them using the following command in the CLI:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">composer install</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde072697648976-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde072697648976-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde072697648976-1\"><span class=\"crayon-e\">composer </span><span class=\"crayon-i\">install</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde072697648976-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Adding Credentials\n\nCredentials for this sample app will be housed in an ENV file and parsed by phpdotenv.\n\n#### ENV Setup\n\nCreating a `.env` file allows us to store credentials needed when connecting to outside services, such as Nexmo and AWS. Add the following content to a newly created `.env` file in the project root:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">APP_ID=voice-aws-transcribe-php LANG_CODE=en-US SAMPLE_RATE=8000 AWS_REGION= AWS_ACCESS_KEY_ID= AWS_SECRET_ACCESS_KEY= AWS_S3_BUCKET_NAME= AWS_S3_RECORDING_FOLDER_NAME= NEXMO_APPLICATION_PRIVATE_KEY_PATH='./private.key' NEXMO_APPLICATION_ID=</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde074669164098-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde074669164098-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde074669164098-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde074669164098-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde074669164098-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde074669164098-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde074669164098-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde074669164098-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde074669164098-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde074669164098-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde074669164098-11\">11</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde074669164098-1\"><span class=\"crayon-v\">APP_ID</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">voice</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">aws</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">transcribe</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">php</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde074669164098-2\"><span class=\"crayon-v\">LANG_CODE</span><span class=\"crayon-o\">=</span><span class=\"crayon-v\">en</span><span class=\"crayon-o\">-</span><span class=\"crayon-e\">US</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde074669164098-3\"><span class=\"crayon-v\">SAMPLE_RATE</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">8000</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde074669164098-4\"><span class=\"crayon-v\">AWS_REGION</span><span class=\"crayon-o\">=</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde074669164098-5\"><span class=\"crayon-v\">AWS_ACCESS_KEY_ID</span><span class=\"crayon-o\">=</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde074669164098-6\"><span class=\"crayon-v\">AWS_SECRET_ACCESS_KEY</span><span class=\"crayon-o\">=</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde074669164098-7\"><span class=\"crayon-v\">AWS_S3_BUCKET_NAME</span><span class=\"crayon-o\">=</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde074669164098-8\"><span class=\"crayon-v\">AWS_S3_RECORDING_FOLDER_NAME</span><span class=\"crayon-o\">=</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde074669164098-9\"><span class=\"crayon-v\">NEXMO_APPLICATION_PRIVATE_KEY_PATH</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">'./private.key'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde074669164098-10\"><span class=\"crayon-v\">NEXMO_APPLICATION_ID</span><span class=\"crayon-o\">=</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde074669164098-11\">&nbsp;</div></div></td></tr></tbody></table>\n\nNOTE: The information above may change, so ensure you check the settings at AWS and Nexmo respectively.\n\n#### PHPDotEnv Usage\n\nIn the `index.php` file created earlier, add the following code to leverage the Composer autoloader and to use the phpdotenv PHP package to inject the contents of the `.env` file into the $\\_ENV superglobal:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">&lt;?php require('vendor/autoload.php'); Dotenv\\Dotenv::create(__DIR__)-&gt;load();</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde075123838132-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde075123838132-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde075123838132-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde075123838132-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde075123838132-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde075123838132-6\">6</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde075123838132-1\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-sy\">?</span><span class=\"crayon-e\">php</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde075123838132-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde075123838132-3\"><span class=\"crayon-e\">require</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'vendor/autoload.php'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde075123838132-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde075123838132-5\"><span class=\"crayon-v\">Dotenv</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Dotenv</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">create</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">__DIR__</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">load</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde075123838132-6\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Using Slim PHP\n\nTo set up slim in our sample callback script, we will import with a `use` statement, immediately following the Composer autoload `require`. Then we will call the `create()` function of Slim to create a Slim app and a function call to `app->run` at the end of the file to kick things off:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">use Psr\\Http\\Message\\ServerRequestInterface as Request; use Psr\\Http\\Message\\ResponseInterface as Response; use Slim\\Factory\\AppFactory; $app = AppFactory::create(); //... call to Dotenv::create() shown earlier //... we will create additional route-based middleware here $app-&gt;run();</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde076456763949-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde076456763949-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde076456763949-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde076456763949-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde076456763949-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde076456763949-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde076456763949-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde076456763949-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde076456763949-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde076456763949-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde076456763949-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde076456763949-12\">12</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde076456763949-1\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Psr</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Http</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Message</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">ServerRequestInterface </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Request</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde076456763949-2\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Psr</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Http</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Message</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">ResponseInterface </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Response</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde076456763949-3\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Slim</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Factory</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">AppFactory</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde076456763949-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde076456763949-5\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">app</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AppFactory</span><span class=\"crayon-o\">::</span><span class=\"crayon-e\">create</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde076456763949-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde076456763949-7\"><span class=\"crayon-c\">//... call to Dotenv::create() shown earlier</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde076456763949-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde076456763949-9\"><span class=\"crayon-c\">//... we will create additional route-based middleware here</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde076456763949-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde076456763949-11\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">app</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">run</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde076456763949-12\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Adding Dependencies\n\nThere are a few more dependencies required to make our job easier, so let’s add the following imports to our script. These will ensure we have the classes we need available to the Composer autoloader:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">use Nexmo\\Client; use Nexmo\\Client\\Credentials\\Keypair; use Aws\\S3\\S3Client; use League\\Flysystem\\AwsS3v3\\AwsS3Adapter; use League\\Flysystem\\Filesystem; use Aws\\TranscribeService\\TranscribeServiceClient;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde077988905222-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde077988905222-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde077988905222-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde077988905222-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde077988905222-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde077988905222-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde077988905222-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde077988905222-1\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Client</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde077988905222-2\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Client</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Credentials</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Keypair</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde077988905222-3\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Aws</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">S3</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">S3Client</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde077988905222-4\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">League</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Flysystem</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">AwsS3v3</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">AwsS3Adapter</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde077988905222-5\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">League</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Flysystem</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Filesystem</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde077988905222-6\"><span class=\"crayon-st\">use</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Aws</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">TranscribeService</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">TranscribeServiceClient</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde077988905222-7\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Status Updates\n\nAs shared earlier, Nexmo will be sending status updates on pretty much every event. So, let’s build that route-based middleware first to get it out of our way:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">$app-&gt;post('/webhooks/event', function (Request $request, Response $response) { $params = $request-&gt;getParsedBody(); error_log($params['recording_url']); return $response -&gt;withStatus(204); });</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde078042388258-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde078042388258-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde078042388258-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde078042388258-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde078042388258-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde078042388258-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde078042388258-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde078042388258-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde078042388258-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde078042388258-10\">10</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde078042388258-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">app</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/webhooks/event'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Request</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Response</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde078042388258-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde078042388258-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">params</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getParsedBody</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde078042388258-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde078042388258-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">error_log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">params</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'recording_url'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde078042388258-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde078042388258-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde078042388258-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">withStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">204</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde078042388258-9\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde078042388258-10\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis route-based middleware simply receives a request to `/webhooks/event` and logs it. Nothing more is needed for this example.\n\n### Answering A Call\n\nWe want to use Slim functionality to catch HTTP requests to our `/webhooks/answer` endpoint using a route-based middleware, so that when Nexmo receives a call to our number (configured earlier) we can provide a JSON response. Specifically, we want to provide Nexmo an NCCO payload.\n\nHere is what that middleware looks like:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">$app-&gt;any('/webhooks/answer', function (Request $request, Response $response) { $uri = $request-&gt;getUri(); if ($request-&gt;getMethod() != 'GET') { return $response-&gt;withStatus(403); } $ncco = [ [ 'action' =&gt; 'talk', 'text' =&gt; 'Please leave a message after the tone, then press #.' ], [ 'action' =&gt; 'record', 'eventUrl' =&gt; [ $uri-&gt;getScheme().'://'.$uri-&gt;getHost().'/webhooks/fetch' ], 'endOnSilence' =&gt; '3', 'endOnKey' =&gt; '#', 'beepOnStart' =&gt; true ], [ 'action' =&gt; 'talk', 'text' =&gt; 'Thank you for your message. Goodbye.' ], [ 'action' =&gt; 'notify', 'payload' =&gt; ['followup' =&gt; true], 'eventUrl' =&gt; [ $uri-&gt;getScheme().'://'.$uri-&gt;getHost().'/webhooks/transcribe' ], 'eventMethod' =&gt; \"POST\" ], ]; $response-&gt;getBody()-&gt;write(json_encode($ncco)); return $response -&gt;withHeader('Content-Type', 'application/json'); });</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde079969790056-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde079969790056-41\">41</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">app</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">any</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/webhooks/answer'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Request</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Response</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">uri</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getUri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getMethod</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'GET'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">withStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">403</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">ncco</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'action'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'talk'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'text'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Please leave a message after the tone, then press #.'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'action'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'record'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'eventUrl'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">uri</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getScheme</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-s\">'://'</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">uri</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getHost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-s\">'/webhooks/fetch'</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'endOnSilence'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'3'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'endOnKey'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'#'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'beepOnStart'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'action'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'talk'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'text'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Thank you for your message. Goodbye.'</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'action'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'notify'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'payload'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'followup'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'eventUrl'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">uri</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getScheme</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-s\">'://'</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">uri</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getHost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-s\">'/webhooks/transcribe'</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'eventMethod'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"POST\"</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-34\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-36\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getBody</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">json_encode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">ncco</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">withHeader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Content-Type'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'application/json'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde079969790056-40\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde079969790056-41\">&nbsp;</div></div></td></tr></tbody></table>\n\nWith this route-based middleware, the app will respond to a GET HTTP request to `/webhooks/answer` with an NCCO object telling Nexmo to answer the call by asking for a message and requesting the caller hit the # key to end the call.\n\nFollowing the recording, which is ended by either a 3-second silence or the caller hitting the # key, Nexmo should then make a callback to the `/webhooks/fetch` endpoint, which kicks off the MP3 retrieval of the recording and thanks the caller for the message.\n\nAnd finally, once the callback in the recording is completed, Nexmo will make a notify callback to the `/webhooks/transcribe` endpoint to kick off the Amazon Transcribe.\n\n### Fetch Recordings\n\nWhen a voice recording is made, it is stored with Nexmo for retrieval. Therefore, we need to create a route-based middleware to be called by Nexmo to initiate the download. It will look like this:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">$app-&gt;post('/webhooks/fetch', function (Request $request, Response $response) { $params = json_decode($request-&gt;getBody(), true); // Create Nexmo Client $keypair = new Keypair( file_get_contents($_ENV['NEXMO_APPLICATION_PRIVATE_KEY_PATH']), $_ENV['NEXMO_APPLICATION_ID'] ); $nexmoClient = new Client($keypair); $data = $nexmoClient-&gt;get($params['recording_url']); // Create AWS S3 Client $S3Client = new S3Client([ 'region' =&gt; $_ENV['AWS_REGION'], 'version' =&gt; 'latest', ]); $adapter = new AwsS3Adapter($S3Client, $_ENV['AWS_S3_BUCKET_NAME']); $filesystem = new Filesystem($adapter); $filesystem-&gt;put('/' . $_ENV['AWS_S3_RECORDING_FOLDER_NAME'] .'/'.$params['conversation_uuid'].'.mp3', $data-&gt;getBody()); return $response -&gt;withStatus(204); });</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07b008773605-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07b008773605-30\">30</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">app</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/webhooks/fetch'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Request</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Response</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">params</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">json_decode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getBody</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// Create Nexmo Client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">keypair</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Keypair</span><span class=\"crayon-sy\">(</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">file_get_contents</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_ENV</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'NEXMO_APPLICATION_PRIVATE_KEY_PATH'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_ENV</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'NEXMO_APPLICATION_ID'</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nexmoClient</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Client</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">keypair</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-12\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">data</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nexmoClient</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">get</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">params</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'recording_url'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-14\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// Create AWS S3 Client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">S3Client</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">S3Client</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'region'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_ENV</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'AWS_REGION'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'version'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'latest'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-20\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">adapter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AwsS3Adapter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">S3Client</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_ENV</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'AWS_S3_BUCKET_NAME'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-22\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">filesystem</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Filesystem</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">adapter</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-24\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">filesystem</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">put</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_ENV</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'AWS_S3_RECORDING_FOLDER_NAME'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-s\">'/'</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">params</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'conversation_uuid'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-s\">'.mp3'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getBody</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-26\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">withStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">204</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07b008773605-29\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07b008773605-30\">&nbsp;</div></div></td></tr></tbody></table>\n\nIn the example code, we decode the JSON from the request body to gain the URL of the recording. Then, we create a Client of the [Nexmo SDK](https://developer.nexmo.com/tools) (using a key pair for credentials) and retrieve the recording.\n\nWe then forward the recording to AWS S3 using [FlySystem](https://flysystem.thephpleague.com/v1/docs/), leveraging the [AWS SDK](https://aws.amazon.com/tools/) for connectivity.\n\n### Transcribe\n\nThe final step is to create the route-based middleware to request transcription by the [Amazon Transcribe](https://aws.amazon.com/transcribe/) service. Here is how to do that:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">$app-&gt;post('/webhooks/transcribe', function (Request $request, Response $response) { $params = json_decode($request-&gt;getBody(), true); // Create Amazon Transcribe Client $awsTranscribeClient = new TranscribeServiceClient([ 'region' =&gt; $_ENV['AWS_REGION'], 'version' =&gt; 'latest', ]); $transcriptionResult = $awsTranscribeClient-&gt;startTranscriptionJob([ 'LanguageCode' =&gt; 'en-US', 'Media' =&gt; [ 'MediaFileUri' =&gt; 'https://' . $_ENV['AWS_S3_BUCKET_NAME'] . '.s3.amazonaws.com/' . $_ENV['AWS_S3_RECORDING_FOLDER_NAME'] . '/' . $params['conversation_uuid'] . '.mp3', ], 'MediaFormat' =&gt; 'mp3', 'TranscriptionJobName' =&gt; 'nexmo_voice_' . $params['conversation_uuid'], ]); $response-&gt;getBody()-&gt;write(json_encode($transcriptionResult-&gt;toArray())); return $response -&gt;withHeader('Content-Type', 'application/json') -&gt;withStatus(204); });</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1bde07d156156793-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1bde07d156156793-26\">26</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">app</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'/webhooks/transcribe'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Request</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Response</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">params</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">json_decode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getBody</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// Create Amazon Transcribe Client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">awsTranscribeClient</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TranscribeServiceClient</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'region'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_ENV</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'AWS_REGION'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'version'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'latest'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">transcriptionResult</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">awsTranscribeClient</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">startTranscriptionJob</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'LanguageCode'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'en-US'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'Media'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'MediaFileUri'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'https://'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_ENV</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'AWS_S3_BUCKET_NAME'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'.s3.amazonaws.com/'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_ENV</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'AWS_S3_RECORDING_FOLDER_NAME'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'/'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">params</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'conversation_uuid'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'.mp3'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'MediaFormat'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'mp3'</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">'TranscriptionJobName'</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'nexmo_voice_'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">params</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'conversation_uuid'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-19\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getBody</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">json_encode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">transcriptionResult</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">toArray</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-21\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">withHeader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Content-Type'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'application/json'</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">withStatus</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">204</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1bde07d156156793-25\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1bde07d156156793-26\">&nbsp;</div></div></td></tr></tbody></table>\n\nNote: The AWS SDK gains the login and key from the environment.\n\nIn this middleware, we parse the JSON payload in the Request so we can gain the `conversation_uuid`.\n\nThen, an Amazon Transcribe Client is used to create a transcription job using the MP3 file stored on S3.\n\n## Conclusion\n\nUsing this example we were able to receive a call to a Nexmo number, prompt the caller to leave a message, retrieve the message in MP3 format and store on AWS S3, and then request Amazon Transcribe to convert the speech to text.\n\nFrom there, the text can be retrieved from AWS Transcribe via the AWS Console, or perhaps we could build some sort of scheduled task to check periodically before downloading for other uses.\n\nFor a completed code example go to [https://github.com/nexmo-community/voice-aws-speechtotext-php](https://github.com/nexmo-community/voice-aws-speechtotext-php)."}