{"_filedata":{"slug":"conference-call-node-red-dr"},"title":"Build a Conference Call with Node-RED","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2019/10/conference-call-node-red-featured.png","author":256,"published":true,"published_at":"2019-10-07T21:52:57","tags":[679,1631,1632,1540,1557,1625,1630,1629,1634,1633,595],"body":"<p>In <a href=\"https://www.nexmo.com/blog/tag/node-red\">previous tutorials</a> you&#8217;ve had a chance to get your feet wet in the world of Nexmo APIs, making and receiving phone calls using the <a href=\"https://developer.nexmo.com/voice/voice-api/overview\">Voice API</a>, and hopefully also customizing these experiences.</p>\n<p>In today&#8217;s tutorial, we&#8217;ll take it a step further and build a voice-based conferencing service.</p>\n<p>The user calls a predefined virtual number and inputs a meeting ID using the dial pad, then they get placed in the same conference call with everyone else who has provided the same ID.</p>\n<p>Steps:<br />\n1. Prerequisites<br />\n2. Expose Your Local Server to the Internet<br />\n3. Define the Webhook Endpoint for Inbound Calls<br />\n4. Define the Webhook Endpoint for the Input Event<br />\n5. Create a Nexmo Voice Application<br />\n6. Set Up a Number to Call<br />\n7. Handle Your Call Events<br />\n8. Try it out!</p>\n<h2>Prerequisites</h2>\n<p>Before getting started, you’ll need a few things:</p>\n<ul>\n<li><a href=\"https://nodejs.org/en/\">Node.js</a> and <a href=\"https://nodered.org/docs/getting-started/installation\">Node-RED</a> installed on your machine</li>\n<li>A Nexmo account—<a href=\"https://dashboard.nexmo.com/sign-up\">create one for free</a> if you haven&#8217;t already</li>\n<li>A way to expose your server to the internet. This either means you&#8217;re running a hosted version of Node-RED, or in case you&#8217;re developing locally, using a tunneling service like <a href=\"https://ngrok.com/download\">ngrok</a>—get up to speed with this <a href=\"https://www.nexmo.com/blog/2019/07/03/ngrok-in-node-red-dr/\">Getting Started with Ngrok in Node-RED</a> tutorial</li>\n</ul>\n<h3>Getting Your Credentials</h3>\n<p>To interact with the Voice API, you&#8217;ll need to make note of a couple of things. Once you&#8217;ve created a Nexmo account, go to the <a href=\"https://dashboard.nexmo.com\">dashboard</a> to find your API key and secret.</p>\n<p>Next, you&#8217;ll need a <em>Voice-enabled</em> virtual number. Go to Numbers > <a href=\"https://dashboard.nexmo.com/buy-numbers\">Buy numbers</a> to get one.</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/04/buy-number-nexmo-dashboard.gif\" alt=\"\" width=\"100%\" height=\"100%\" class=\"alignnone gif-player size-full wp-image-28897\" /></p>\n<h3>Setting Up Your Node-RED Editor</h3>\n<p>First, you’ll need to <a href=\"https://nodered.org/docs/getting-started/installation\">install</a> the runtime and editor. This could be done either on your local machine, on a Single Board Computer (eg. Raspberry Pi), or through several cloud-hosted options. This example will be using your local machine, so once you&#8217;ve installed Node-RED globally, type the command below in your terminal to get started.</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55fbeb123615749\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\n$ node-red\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55fbeb123615749-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55fbeb123615749-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55fbeb123615749-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">node</span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">red</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55fbeb123615749-2\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0001 seconds] -->\r\n<p></p>\n<p>You can then access the Node-RED editor by pointing your browser at <a href=\"http://localhost:1880\">http://localhost:1880</a>.</p>\n<p>Once you have your editor open, you&#8217;ll need to install the Nexmo nodes. You can do so under the <em>Manage palette</em> menu, by searching for the <code>node-red-contrib-nexmo</code> package and clicking install.</p>\n<p>Now you should see all of the Nexmo nodes appear on the left side of your screen—in your node palette, among other default nodes.</p>\n<h2>Expose Your Local Server to the Internet</h2>\n<p>The Nexmo API will need access to your webhooks to make calls against them, so let&#8217;s <a href=\"https://www.nexmo.com/blog/2019/07/03/ngrok-in-node-red-dr/\">make them accessible over the public internet</a>. If you’re running Node-RED on a public web server instead of your local machine, you&#8217;re all set and ready to move on to the <a href=\"link_me\"><em>Create a Nexmo Voice Application</em></a> step.</p>\n<p>Otherwise, a convenient way to do this is by using a tunneling service like <a href=\"https://ngrok.com\">ngrok</a>.</p>\n<p>First, you&#8217;ll need to install the ngrok node. To do so, open up <em>Manage palette</em> from the hamburger menu in your Node-RED editor, search for the <code>node-red-contrib-ngrok</code> package, and click install. After restarting your editor, the <em><code>ngrok</code></em> node should appear in the node palette.</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/ngrok-manage-palette.png\" alt=\"\" width=\"\" height=\"\" class=\"alignnone size-full wp-image-30421\" /></p>\n<p>The <code>ngrok</code> node takes the strings <em>on</em> or <em>off</em> as input to start/stop the tunnel, and outputs the ngrok host address as the <code>msg.payload</code>.</p>\n<p>The easiest way to set this up is to wire two <code>inject</code> nodes as the <code>ngrok</code> node&#8217;s input, one with the payload of the string <em>on</em> and the other with <em>off</em>. For easier use, you could also set the <code>Name</code> of these nodes accordingly in the node properties, so that it&#8217;s clear what functionality they have. Next, to display the host address in the debug sidebar, connect a <code>debug</code> node after <code>ngrok</code>.</p>\n<p>As the last step before hitting <em>Deploy</em>, open up the <code>ngrok</code> node properties and specify the port number. In case of Node-RED, the default value is <code>1880</code>. The default ngrok Region is US but you can also set it to Europe or Asia. You can also add your authtoken for your ngrok account if you have one. Don&#8217;t worry if you don&#8217;t, just skip this step for now. The node will warn that it is not fully configured but this is not an issue.</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/ngrok-node-properties.png\" alt=\"\" width=\"\" height=\"\" class=\"alignnone size-full wp-image-30422\" /></p>\n<p>And you&#8217;re all set! Once you hit <strong>Deploy</strong> and click on the <strong>on</strong> <code>inject</code> node&#8217;s button, navigate to the URL displayed in the debug area (YOUR_URL for future reference) to find your Node-RED editor at a public address.</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/ngrok-nodered.png\" alt=\"\" width=\"\" height=\"\" class=\"alignnone size-full wp-image-30423\" /></p>\n<h2>Define the Webhook Endpoint for Inbound Calls</h2>\n<p>Nexmo calls are controlled using <em>Nexmo Call Control Objects</em>, also known as NCCOs. An NCCO defines a list of actions to be followed when a call is handled. There are lots of different actions available; find the corresponding nodes under the Nexmo palette in your Node-RED editor or check out the <a href=\"https://developer.nexmo.com/api/voice/ncco\">NCCO Reference</a> to find out more about them.</p>\n<p>When handling inbound calls, you need your NCCO hosted at an <em>Answer URL</em>. In this case, we&#8217;ll be using a <code>talk</code> action to ask tor the meeting ID, then an <code>input</code> action to collect it.</p>\n<p>Add a <em><code>voice webhook</code></em> input node to your canvas, followed by a <em><code>talk</code></em> node, an <em><code>input</code></em> node and a <em><code>return NCCO</code></em> output node.</p>\n<p>Next, in the <em><code>voice webhook</code></em> node, select <code>GET</code> as a <code>Method</code> and type <code>/answer</code> in the answer URL field.</p>\n<p>In the <em><code>talk</code></em> node properties set the <code>Text{}</code> field to the message you&#8217;d like to be read out when the call is answered. E.g. &#8220;Please enter the meeting ID&#8221;. You can also select a <code>Voice Name</code>, see the <a href=\"https://developer.nexmo.com/voice/voice-api/guides/text-to-speech#voice-names\">Text to Speech Guide</a> for the full list of options.</p>\n<p>Finally open the <em><code>input</code></em> node editor, set <code>YOUR_URL/input</code> as the <code>URL {}</code> and <code>POST</code> as a <code>Method</code>.</p>\n<p>At this time you could also set a couple of other parameters to further customize the experience:</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>Submit On Hash</code>:</td>\n<td>Set to true so the caller&#8217;s activity is sent to your webhook endpoint at <code>YOUR_URL/input</code> after they press <code>#</code>. If <code>#</code> is not pressed the result is submitted after <code>Time Out</code> seconds. The default value is false.</td>\n</tr>\n<tr>\n<td><code>Time Out</code>:</td>\n<td>The result of the caller&#8217;s activity is sent to the <code>YOUR_URL/input</code> webhook endpoint <code>Time Out</code> seconds after the last action. The default value is 3. Max is 10.</td>\n</tr>\n<tr>\n<td><code>Max Digits</code>:</td>\n<td>The number of digits the user can press. The maximum value is 20, the default is 4 digits.</td>\n</tr>\n</tbody>\n</table>\n<p>Find out more about these in the <a href=\"https://developer.nexmo.com/voice/voice-api/ncco-reference#input\">NCCO Reference</a>.</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/conference-answer-url.gif\" alt=\"\" width=\"\" height=\"\" class=\"alignnone size-full gif-player wp-image-30414\" /></p>\n<h2>Define the Webhook Endpoint for the Input Event</h2>\n<p>You&#8217;ll also need a second endpoint to capture the DTMF input from the user, and based on the code they have submitted, place them into a <em>conversation</em>.</p>\n<p>Add another <em><code>voice webhook</code></em> input node to your canvas, followed by a <em><code>talk</code></em> node, a <em><code>conversation</code></em> node and a <em><code>return NCCO</code></em> output node.</p>\n<h4><code>voice webhook</code></h4>\n<p>In the <em><code>voice webhook</code></em> node properties, select <code>POST</code> as a method and type <code>/input</code> in the answer URL field.</p>\n<p>If you were to connect a <code>debug</code> node after it, after finishing and running the flow, you would see the parameters returned to the <code>/input</code> URL:</p>\n<table>\n<thead>\n<tr>\n<th>Name</th>\n<th>Description</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>uuid</code></td>\n<td>The unique ID of the Call leg for the user initiating the input.</td>\n</tr>\n<tr>\n<td><code>conversation_uuid</code></td>\n<td>The unique ID for this conversation.</td>\n</tr>\n<tr>\n<td><code>timed_out</code></td>\n<td>Returns true if this input timed out based on the value of <code>Time Out</code>.</td>\n</tr>\n<tr>\n<td><code>dtmf</code></td>\n<td>The numbers input by your caller, in order.</td>\n</tr>\n</tbody>\n</table>\n<p>In our use case, we are trying to get the <code>dtmf</code> value, as this is the meeting ID provided by the caller.</p>\n<p>Having a closer look at the debug sidebar on completions, we can see that it&#8217;s going to be in the <code>dtmf</code> property of the <code>call</code> object nested inside the <code>msg</code> object, so we can reference it as <code>{{msg.call.dtmf}}</code> in the other nodes of this path.</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/dtmf-debug.png\" alt=\"\" width=\"\" height=\"\" class=\"alignnone size-full wp-image-30420\" /></p>\n<h4><code>talk</code></h4>\n<p>Next, open up the <em><code>talk</code></em> node editor and set the <code>Text{}</code> field to the message you&#8217;d like to be read out once the caller inputs the meeting ID.</p>\n<p>Note the <code>{}</code> sign next to the <code>Text</code> label, showing that this value can be set dynamically, using <a href=\"https://mustache.github.io/\">Mustache templating</a>, so you could go with something like <code>Joining meeting {{msg.call.dtmf}}</code>.</p>\n<p>Feel free to further personalize the experience by selecting a <a href=\"https://developer.nexmo.com/voice/voice-api/guides/text-to-speech#voice-names\"><code>Voice Name</code></a> or by making use of <a href=\"https://developer.nexmo.com/voice/voice-api/guides/customizing-tts\">SSML tags</a></p>\n<h4><code>conversation</code></h4>\n<p>We&#8217;re using the <em><code>conversation</code></em> action to create a standard conference, so the only parameter we have to set is <code>Name {}</code>. Using the conversation action with the same name reuses the same persisted Conversation, so it&#8217;s handy to name it after the meeting ID, referencing <code>{{msg.call.dtmf}}</code> The first person to call the virtual number assigned to the conversation creates it.</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/conference-conversation-node.png\" alt=\"\" width=\"\" height=\"\" class=\"alignnone size-full wp-image-30415\" /></p>\n<p>In the future, you might want to take this a step further and create a moderated Conversation with selective audio controls. Check out the <a href=\"https://developer.nexmo.com/voice/voice-api/ncco-reference#conversation\">NCCO reference</a> to find out more.</p>\n<p>Once you&#8217;re done with this path, it should look similar to this:</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/conference-input-url.gif\" alt=\"\" width=\"\" height=\"\" class=\"alignnone size-full gif-player wp-image-30418\" /></p>\n<h2>Create a Nexmo Voice Application</h2>\n<p>Some of Nexmo’s APIs, including the Voice API, use Nexmo Applications to hold security and config information needed to connect to Nexmo endpoints.</p>\n<p>In the Nexmo Node-RED palette, several nodes have the capability to create these applications: <em><code>getrecording</code></em>, <em><code>earmuff</code></em>, <em><code>mute</code></em>, <em><code>hangup</code></em>, <em><code>transfer</code></em>, <em><code>createcall</code></em>, <em><code>playaudio</code></em>, <em><code>playtts</code></em> and <em><code>playdtmf</code></em>.</p>\n<p>Drag any of these nodes into your workspace, then double-click on it to open up the node properties.</p>\n<p>Next to the <code>Nexmo Credentials</code>, select &#8220;Add new nexmovoiceapp&#8230;&#8221; from the drop-down menu and click the edit button. Fill in the details below and click <code>Create New Application</code>.</p>\n<table>\n<thead>\n<tr>\n<th>KEY</th>\n<th>DESCRIPTION</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><code>Name</code></td>\n<td>Choose a name for your Voice Application, for example <code>Conference Call</code>.</td>\n</tr>\n<tr>\n<td><code>API Key</code></td>\n<td>Your Nexmo API key, shown in your <a href=\"https://dashboard.nexmo.com/getting-started-guide\">account overview</a>.</td>\n</tr>\n<tr>\n<td><code>API Secret</code></td>\n<td>Your Nexmo API secret, shown in your <a href=\"https://dashboard.nexmo.com/getting-started-guide\">account overview</a>.</td>\n</tr>\n<tr>\n<td><code>Answer URL</code></td>\n<td>YOUR_URL/answer, you&#8217;ll be hosting a Nexmo Call Control Object (NCCO) here. &#8211; more about this later on.</td>\n</tr>\n<tr>\n<td><code>Event URL</code></td>\n<td>YOUR_URL/event, you&#8217;ll need to reference this when setting up the event handler.</td>\n</tr>\n</tbody>\n</table>\n<p>Node-RED will then create a new Nexmo Application on your account and fill in the App ID and Private Key fields for you to save. After this step, feel free to delete the Nexmo node you used, as a <code>nexmovoiceapp</code> config node has been created, and that contains all the Nexmo credentials this flow needs.</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/conference-create-voiceapp.png\" alt=\"\" width=\"\" height=\"\" class=\"alignnone size-full wp-image-30416\" /></p>\n<h2>Set Up a Number to Call</h2>\n<p>Next, you&#8217;ll have to link your virtual number to this application.</p>\n<p>Find the Voice Application you&#8217;ve just created in your Nexmo Dashboard by navigating to <em>Voice</em> > <em><a href=\"https://dashboard.nexmo.com/voice/your-applications\">Your Applications</a></em>.</p>\n<p>Click on the name of this application, then under the <em>Numbers</em> tab click on the <strong>Link</strong> button next to the virtual number you&#8217;ve rented earlier.</p>\n<p>In case the number you&#8217;d like to use is already linked to another app, click on <strong>Manage number</strong> and configure it to forward incoming calls to your app.</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/congerence-link-number.png\" alt=\"\" width=\"\" height=\"\" class=\"alignnone size-full wp-image-30419\" /></p>\n<p><em>Bonus tip:</em> Use a <em><code>comment</code></em> node to take note of the Nexmo number linked to your application, this way you always have it handy.</p>\n<h2>Handle Your Call Events</h2>\n<p>If you&#8217;d like to receive events about the progress of your call, you can also set up an event webhook.</p>\n<p>Connect an <code>http</code> input node to an <code>http response</code> node, as well as to a <code>debug</code> node, so that you can view your call events in the debug area.</p>\n<p>In the <code>http</code> input node, select <code>POST</code> as a <code>Method</code> and fill in the <code>URL</code> field with <code>/event</code>.</p>\n<p>The <code>http response</code> node should have <code>200</code> set as <code>Status code</code>, but don&#8217;t worry about it; this is the default value as well.</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/conference-final-flow.png\" alt=\"\" width=\"\" height=\"\" class=\"alignnone size-full wp-image-30417\" /></p>\n<h2>Try it Out!</h2>\n<p>And that&#8217;s a wrap! Get a friend or more and take it for a spin! Don&#8217;t forget to take a peek in the debug area to follow your call events. Enjoy!</p>\n<h2>Where Next?</h2>\n<h3>Resources:</h3>\n<ul>\n<li><a href=\"https://developer.nexmo.com/voice/voice-api/ncco-reference#conversation\">Conversation NCCO Reference</a></li>\n<li><a href=\"https://developer.nexmo.com/voice/voice-api/ncco-reference#input\">Input NCCO Reference</a></li>\n<li><a href=\"https://www.nexmo.com/blog/2019/07/03/ngrok-in-node-red-dr/\">Get Started with ngrok in Node-RED</a></li>\n<li><a href=\"https://developer.nexmo.com/voice/voice-api/overview\">Voice API Reference</a></li>\n</ul>\n<h3>Try another tutorial:</h3>\n<ul>\n<li><a href=\"https://www.nexmo.com/blog/2019/09/25/verify-phone-numbers-with-node-red-dr\">Verify Phone Numbers with Node-RED</a></li>\n<li><a href=\"https://www.nexmo.com/blog/2019/07/15/stream-audio-node-red-dr\">How to Stream Audio into a Call with Node-RED</a></li>\n<li><a href=\"https://www.nexmo.com/blog/2019/06/14/make-text-to-speech-phone-calls-node-red-dr/\">How to Make Text-to-Speech Phone Calls with Node-RED</a></li>\n<li><a href=\"https://www.nexmo.com/blog/2019/05/09/receive-phone-calls-node-red-dr/\">How to Receive Phone Calls with Node-RED</a></li>\n<li><a href=\"https://www.nexmo.com/blog/2019/04/17/send-sms-messages-node-red-dr/\">How to Send SMS Messages with Node-RED</a></li>\n<li><a href=\"https://www.nexmo.com/blog/2019/04/24/receive-sms-messages-node-red-dr/\">How to Receive SMS Messages with Node-RED</a></li>\n</ul>\n<p><script>\nwindow.addEventListener('DOMContentLoaded', (event) => {\n    document.querySelectorAll(\".gif-player\").forEach(image => {\n        image.src = image.src.replace(/\\.gif$/g, \".png\")\n        image.addEventListener(\"click\", (event) => {\n            if (event.target.src.indexOf(\".gif\") > 0) {\n                image.src = image.src.replace(/\\.gif$/g, \".png\")\n            } else {\n                image.src = image.src.replace(/\\.png$/g, \".gif\")\n            }\n        })\n    })\n});\n</script></p>\n<style>\n.gif-player {\n  cursor: pointer;\n}\nimg.alignnone {\n  border-width: 0px !important;\n}\n</style>\n"}