{"_filedata":{"slug":"how-to-add-machine-learning-to-facebook-messenger-dr"},"title":"&#8220;Hey Facebook, What Type of Dog Is That?&#8221; &#8211; Adding Machine Learning to Messenger","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2019/10/What-Kind-of-Dog-Is-That.png","author":349,"published":true,"published_at":"2019-10-31T14:39:44","tags":[385,1643,1640,1639,1641,1237,1638,1642,1240],"body":"<p>Convolutional Neural Networks (CNNs) provide a powerful and scalable mechanism for preforming image classification. They can be relatively difficult to build, train, and tune from scratch, which is what makes tools like TensorFlow and the inception models so indispensable to improving our ML workflows.</p>\n<p>That said for us .NET folks running python scripts out of an in-app shell is less than an ideal solution which is what makes the release of the ML.NET TensorFlow library so exciting.</p>\n<p>What if I told you that with just a couple hundred lines of C# code and a little configuration you could build an ASP.NET core app that will house a powerful CNN that you can interact with as simple as sending a picture message to a Facebook page?</p>\n<p>With training as simple as:</br><br />\n<a href=\"https://www.nexmo.com/wp-content/uploads/2019/10/sampleTrain.jpg\"><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/sampleTrain.jpg\" alt=\"\" width=\"408\" height=\"400\" class=\"alignnone size-full wp-image-30591\" /></a></p>\n<p>And a classification request as simple as:</br><br />\n<a href=\"https://www.nexmo.com/wp-content/uploads/2019/10/sampleClassify.jpg\"><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/sampleClassify.jpg\" alt=\"\" width=\"247\" height=\"300\" class=\"alignnone size-medium wp-image-30590\" /></a></p>\n<p>Well, that&#8217;s precisely what we&#8217;re going to do &#8211; using ML.NET, we&#8217;re going to build a powerful classifier and then using Nexmo&#8217;s Messages API and Messenger we&#8217;re going to create a powerful, easy to use, vector for training and classification.</p>\n<h2>Learning Objectives</h2>\n<p>In this tutorial, we will:</p>\n<ul>\n<li>Create an ML.NET TensorFlow Neural Network</li>\n<li>Train that Neural Network to recognize different types of dogs</li>\n<li>Create a Messaging vector to ask the Neural Network to classify dogs it&#8217;s never seen before</li>\n<li>Create a Learning vector to allow the Neural Network to learn new types of dogs dynamically.</li>\n</ul>\n<h2>Prerequisites</h2>\n<ul>\n<li>Visual Studio 2019 version 16.3 or higher</li>\n<li>A Nexmo account <a href=\"https://dashboard.nexmo.com/sign-up\">Sign up here</a></li>\n<li>A linked Facebook Page to your Nexmo account <a href=\"https://developer.nexmo.com/messages/concepts/facebook\">See here for setup</a></li>\n<li>Optional: <a href=\"https://ngrok.com/\">Ngrok</a> for test deployment</li>\n</ul>\n<h2>Project Setup</h2>\n<p>First thing&#8217;s first &#8211; let&#8217;s open Visual Studio, Create a new ASP.NET Core 3.0 API application and call it MessagesTensorFlow. Now let&#8217;s add the following NuGet packages to the solution:</p>\n<ul>\n<li>BouncyCastle</li>\n<li>jose-jwt</li>\n<li>Microsoft.ML</li>\n<li>Microsoft.ML.ImageAnalytics</li>\n<li>Microsoft.ML.TensorFlow</li>\n<li>Newtonsoft.Json</li>\n</ul>\n<p>We&#8217;re going to be starting off our neural net with the Inception V1 model and then seeding it with images / labels off disk. Create a folder under the MessagesTensorFlow directory called <code>assets</code>.</p>\n<p>In assets download and unzip the <a href=\"https://storage.googleapis.com/download.tensorflow.org/models/inception5h.zip\">Inception V1 Model</a></p>\n<p>Also, under assets, create a folder called train and predict. Under each of those directories, add a tags.tsv file. Your directory structure should look something like this now:</p>\n<p><a href=\"https://www.nexmo.com/wp-content/uploads/2019/10/assetsStruct-1.png\"><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/assetsStruct-1.png\" alt=\"\" width=\"380\" height=\"173\" class=\"alignnone size-full wp-image-30585\" /></a></p>\n<p>Now go to each file and in the advanced properties section set the Copy to Output Directory to Copy if newer</br><br />\n<a href=\"https://www.nexmo.com/wp-content/uploads/2019/10/advancedProperties-1.png\"><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/advancedProperties-1.png\" alt=\"\" width=\"459\" height=\"155\" class=\"alignnone size-full wp-image-30593\" /></a></p>\n<h2>Creating the Learner</h2>\n<p>Let&#8217;s now create the class that&#8217;s going to actually hold our neural network. Create a file called TFEngine.cs.</p>\n<h3>Imports</h3>\n<p>Add the following imports to the top of the file:</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0e8295980985\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\nusing Microsoft.ML;\nusing Microsoft.ML.Data;\nusing System;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Linq;\nusing System.Net;\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0e8295980985-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0e8295980985-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0e8295980985-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0e8295980985-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0e8295980985-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0e8295980985-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0e8295980985-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0e8295980985-8\">8</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0e8295980985-1\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">Microsoft</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ML</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0e8295980985-2\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">Microsoft</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ML</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Data</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0e8295980985-3\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0e8295980985-4\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Collections</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Generic</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0e8295980985-5\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">IO</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0e8295980985-6\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Linq</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0e8295980985-7\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Net</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0e8295980985-8\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0002 seconds] -->\r\n<p></p>\n<h3>Class Setup</h3>\n<p>Then inside the TFEngine class let&#8217;s add some paths so we can access everything all the files we&#8217;ll be ingesting into our model. As well as some settings for managing the inception data.</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0ec053211974\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\nstatic readonly string _assetsPath = Path.Combine(Environment.CurrentDirectory, \"assets\");\nstatic readonly string _imagesFolder = Path.Combine(_assetsPath, \"train\");\nstatic readonly string _savePath = Path.Combine(_assetsPath, \"predict\");\nstatic readonly string _trainTagsTsv = Path.Combine(_imagesFolder, \"tags.tsv\");\nstatic readonly string _inceptionTensorFlowModel = Path.Combine(_assetsPath, \"inception5h\", \"tensorflow_inception_graph.pb\");\n\nconst int ImageHeight = 224;\nconst int ImageWidth = 224;\nconst float Mean = 117;\nconst bool ChannelsLast = true;\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ec053211974-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ec053211974-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ec053211974-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ec053211974-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ec053211974-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ec053211974-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ec053211974-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ec053211974-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ec053211974-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ec053211974-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ec053211974-11\">11</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ec053211974-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_assetsPath</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Environment</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">CurrentDirectory</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"assets\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ec053211974-2\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_imagesFolder</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_assetsPath</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"train\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ec053211974-3\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_savePath</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_assetsPath</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"predict\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ec053211974-4\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_trainTagsTsv</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_imagesFolder</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"tags.tsv\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ec053211974-5\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_inceptionTensorFlowModel</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_assetsPath</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"inception5h\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"tensorflow_inception_graph.pb\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ec053211974-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ec053211974-7\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImageHeight</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">224</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ec053211974-8\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImageWidth</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">224</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ec053211974-9\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Mean</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">117</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ec053211974-10\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">bool</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ChannelsLast</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ec053211974-11\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p>\n<p>Let&#8217;s also set this class up as a singleton and allow only one access to it at a time. We&#8217;re also going to add a webClient for downloading the image URLs.</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0ed767568430\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\nstatic readonly object _lock = new object();\n\nprivate static WebClient _client = new WebClient();\nprivate static TFEngine _instance;\npublic static TFEngine Instance\n{\n    get\n    {\n        lock (_lock)\n        {\n            if (_instance == null)\n            {\n                _instance = new TFEngine();\n            }\n            return _instance;\n        }\n\n    }\n}\n\nprivate TFEngine()\n{\n    _mlContext = new MLContext();\n    GenerateModel();\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ed767568430-26\">26</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-1\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">object</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_lock</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">object</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-3\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebClient </span><span class=\"crayon-v\">_client</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">WebClient</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-4\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TFEngine </span><span class=\"crayon-v\">_instance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-5\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TFEngine</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Instance</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-6\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">get</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">lock</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_lock</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_instance</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_instance</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TFEngine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_instance</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-17\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-19\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-20\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-21\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TFEngine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-22\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MLContext</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">GenerateModel</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ed767568430-25\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ed767568430-26\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0004 seconds] -->\r\n<p></p>\n<p>We&#8217;re also going to create some fields to hold our pipeline that will be used to create our model, the model that will be used to perform the prediction, and the MLContext.</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0ef734527811\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\nprivate IEstimator&lt;ITransformer&gt; _pipeline;\nprivate ITransformer _model;\nprivate MLContext _mlContext;\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ef734527811-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ef734527811-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ef734527811-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ef734527811-4\">4</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ef734527811-1\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">IEstimator</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">ITransformer</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_pipeline</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ef734527811-2\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ITransformer </span><span class=\"crayon-v\">_model</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ef734527811-3\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MLContext </span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ef734527811-4\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0001 seconds] -->\r\n<p></p>\n<p>Next add a class ImageData which will hold the image data as it passes through the model</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0f0344441335\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\npublic class ImageData\n{\n    [LoadColumn(0)]\n    public string ImagePath;\n\n    [LoadColumn(1)]\n    public string Label;\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f0344441335-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f0344441335-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f0344441335-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f0344441335-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f0344441335-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f0344441335-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f0344441335-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f0344441335-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f0344441335-9\">9</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f0344441335-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ImageData</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f0344441335-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f0344441335-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">[</span><span class=\"crayon-e\">LoadColumn</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f0344441335-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImagePath</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f0344441335-5\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f0344441335-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">[</span><span class=\"crayon-e\">LoadColumn</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f0344441335-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Label</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f0344441335-8\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f0344441335-9\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0001 seconds] -->\r\n<p></p>\n<p>Then create a structure to house the prediction data as it flows out of the model:</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0f1407932664\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\npublic class ImagePrediction : ImageData\n{\n    public float[] Score;\n\n    public string PredictedLabelValue;\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f1407932664-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f1407932664-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f1407932664-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f1407932664-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f1407932664-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f1407932664-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f1407932664-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f1407932664-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImagePrediction</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ImageData</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f1407932664-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f1407932664-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">float</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Score</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f1407932664-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f1407932664-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">PredictedLabelValue</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f1407932664-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f1407932664-7\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0001 seconds] -->\r\n<p></p>\n<p>The score will be an array containing the probabilities the neural net assigns to each possible label, and the PredictedLabelValue will, of course, be prediction from the network (the item with the highest score)</p>\n<h2>Model Training</h2>\n<p>Now it&#8217;s time to train our model!</p>\n<p>Add a method called GenerateModel</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0f2621911623\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\npublic void GenerateModel()\n{\n    _pipeline = _mlContext.Transforms.LoadImages(outputColumnName: \"input\", imageFolder: _imagesFolder, inputColumnName: nameof(ImageData.ImagePath))//Loads the images from the image folder\n        .Append(_mlContext.Transforms.ResizeImages(outputColumnName: \"input\", imageWidth: ImageWidth, imageHeight: ImageHeight, inputColumnName: \"input\"))//Resizes all of the images to a size the inception model can work with it\n        .Append(_mlContext.Transforms.ExtractPixels(outputColumnName: \"input\", interleavePixelColors: ChannelsLast, offsetImage: Mean))//Extract pixels from the images for use\n        .Append(_mlContext.Model.LoadTensorFlowModel(_inceptionTensorFlowModel)// Loads the tensorflow model from the inception .pb file\n        .ScoreTensorFlowModel(outputColumnNames: new[] { \"softmax2_pre_activation\" }, inputColumnNames: new[] { \"input\" }, addBatchDimensionInput: true))// scores input images against the tensorflow models softmax2_pre_activation layer - a vector of features that might describe an input image\n        .Append(_mlContext.Transforms.Conversion.MapValueToKey(outputColumnName: \"LabelKey\", inputColumnName: \"Label\"))// maps the ImageData's label to the output column labelKey\n        .Append(_mlContext.MulticlassClassification.Trainers.LbfgsMaximumEntropy(labelColumnName: \"LabelKey\", featureColumnName: \"softmax2_pre_activation\"))// creates the multiclass classifier from the tensorflow model\n        .Append(_mlContext.Transforms.Conversion.MapKeyToValue(\"PredictedLabelValue\", \"PredictedLabel\")) // for the predictor - maps the predictedlabelValue to the PredictedLabel Key\n        .AppendCacheCheckpoint(_mlContext);// fits the training data to the model - et voila - we have our classifier\n    IDataView trainingData = _mlContext.Data.LoadFromTextFile&lt;ImageData&gt;(path: _trainTagsTsv, hasHeader: false);\n    _model = _pipeline.Fit(trainingData);\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f2621911623-15\">15</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f2621911623-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">GenerateModel</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f2621911623-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f2621911623-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_pipeline</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Transforms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">LoadImages</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">outputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"input\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageFolder</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_imagesFolder</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">nameof</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ImageData</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ImagePath</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//Loads the images from the image folder</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f2621911623-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Transforms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ResizeImages</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">outputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"input\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageWidth</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImageWidth</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageHeight</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImageHeight</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"input\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//Resizes all of the images to a size the inception model can work with it</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f2621911623-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Transforms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ExtractPixels</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">outputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"input\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">interleavePixelColors</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ChannelsLast</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">offsetImage</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Mean</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">//Extract pixels from the images for use</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f2621911623-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Model</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">LoadTensorFlowModel</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_inceptionTensorFlowModel</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">// Loads the tensorflow model from the inception .pb file</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f2621911623-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ScoreTensorFlowModel</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">outputColumnNames</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"softmax2_pre_activation\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inputColumnNames</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"input\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">addBatchDimensionInput</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">// scores input images against the tensorflow models softmax2_pre_activation layer - a vector of features that might describe an input image</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f2621911623-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Transforms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Conversion</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">MapValueToKey</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">outputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"LabelKey\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inputColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Label\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">// maps the ImageData's label to the output column labelKey</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f2621911623-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">MulticlassClassification</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Trainers</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">LbfgsMaximumEntropy</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">labelColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"LabelKey\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">featureColumnName</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"softmax2_pre_activation\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-c\">// creates the multiclass classifier from the tensorflow model</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f2621911623-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Append</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Transforms</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Conversion</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">MapKeyToValue</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"PredictedLabelValue\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"PredictedLabel\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// for the predictor - maps the predictedlabelValue to the PredictedLabel Key</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f2621911623-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AppendCacheCheckpoint</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">// fits the training data to the model - et voila - we have our classifier</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f2621911623-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">IDataView </span><span class=\"crayon-v\">trainingData</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Data</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">LoadFromTextFile</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">ImageData</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">path</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_trainTagsTsv</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hasHeader</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f2621911623-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_model</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_pipeline</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Fit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">trainingData</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f2621911623-14\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f2621911623-15\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p></p>\n<p>This is really the heart of what&#8217;s going to make our predictor work. The &#8216;_pipeline =&#8217; section is a chain of commands that will:</p>\n<ul>\n<li>Load the images off of the disk</li>\n<li>Resize the images for ingestion</li>\n<li>Extract and vectorize the pixels in the images</li>\n<li>Load the inception TensorFlow model (essentially our pre-made neural net)</li>\n<li>Create a training model and run the training data through it to create a prediction model for us to use</li>\n</ul>\n<h3>Classifying a Single Image</h3>\n<p>With our model trained we can now go about creating a method that will take in a file name and return a string containing a prediction and the networks confidence in the prediction. This function takes an imageUrl, saves the file to the disk, classifies the image and returns a string containing the classifiers guess with its confidence.</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0f3575076428\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\npublic string ClassifySingleImage(string imageUrl)\n{\n    try\n    {\n        var filename = Path.Combine(_savePath, $\"{Guid.NewGuid()}.jpg\");\n        _client.DownloadFile(imageUrl, filename);\n        var imageData = new ImageData()\n        {\n            ImagePath = filename\n        };\n\n        var predictor = _mlContext.Model.CreatePredictionEngine&lt;ImageData, ImagePrediction&gt;(_model);\n        var prediction = predictor.Predict(imageData);\n        var response = $\"I'm about {prediction.Score.Max() * 100}% sure that the image you sent me is a {prediction.PredictedLabelValue}\";\n        Console.WriteLine($\"Image: {Path.GetFileName(imageData.ImagePath)} predicted as: {prediction.PredictedLabelValue} with score: {prediction.Score.Max() * 100} \");\n        return response;\n    }\n    catch (Exception)\n    {\n        return \"Something went wrong when trying to classify image\";\n    }\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f3575076428-23\">23</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ClassifySingleImage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f3575076428-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f3575076428-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">filename</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_savePath</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"{Guid.NewGuid()}.jpg\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f3575076428-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_client</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">DownloadFile</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">filename</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageData</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ImageData</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f3575076428-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">ImagePath</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">filename</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f3575076428-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-11\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f3575076428-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">predictor</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Model</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">CreatePredictionEngine</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">ImageData</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ImagePrediction</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_model</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">prediction</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">predictor</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Predict</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">imageData</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f3575076428-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">response</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"I'm about {prediction.Score.Max() * 100}% sure that the image you sent me is a {prediction.PredictedLabelValue}\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"Image: {Path.GetFileName(imageData.ImagePath)} predicted as: {prediction.PredictedLabelValue} with score: {prediction.Score.Max() * 100} \"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f3575076428-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f3575076428-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Exception</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f3575076428-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Something went wrong when trying to classify image\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f3575076428-22\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f3575076428-23\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p></p>\n<h3>Adding Training Data</h3>\n<p>The final operation we&#8217;re going to ask of the Tensor Flow Engine is essentially the reverse of prediction, we&#8217;ll ask it to accept an image URL and label and update itself to better recognize images of that label. The AddTrainingImage saves the provided image to disk, appends information about that images to the tags.tsv file, and regenerates the model.</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0f4529990128\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\npublic string AddTrainingImage(string imageUrl, string label)\n{\n    try\n    {\n        var id = Guid.NewGuid();\n        var fileName = Path.Combine(_imagesFolder, $\"{id}.jpg\");\n        _client.DownloadFile(imageUrl, fileName);\n        File.AppendAllText(_trainTagsTsv, $\"{id}.jpg\\t{label}\" + Environment.NewLine);\n        IDataView trainingData = _mlContext.Data.LoadFromTextFile&lt;ImageData&gt;(path: _trainTagsTsv, hasHeader: false);\n        _model = _pipeline.Fit(trainingData);\n        return $\"I have trained myself to recognize the image you sent me as a {label}. Your teaching is appreciated\";\n    }\n    catch (Exception)\n    {\n        return \"something went wrong when trying to train on image\";\n    }\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f4529990128-18\">18</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f4529990128-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AddTrainingImage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">label</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f4529990128-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f4529990128-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f4529990128-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f4529990128-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Guid</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">NewGuid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f4529990128-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fileName</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Path</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Combine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_imagesFolder</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"{id}.jpg\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f4529990128-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_client</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">DownloadFile</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fileName</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f4529990128-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">File</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AppendAllText</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_trainTagsTsv</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"{id}.jpg\\t{label}\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Environment</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NewLine</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f4529990128-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">IDataView </span><span class=\"crayon-v\">trainingData</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_mlContext</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Data</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">LoadFromTextFile</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">ImageData</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">path</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_trainTagsTsv</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">hasHeader</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f4529990128-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_model</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_pipeline</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Fit</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">trainingData</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f4529990128-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"I have trained myself to recognize the image you sent me as a {label}. Your teaching is appreciated\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f4529990128-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f4529990128-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Exception</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f4529990128-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f4529990128-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"something went wrong when trying to train on image\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f4529990128-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f4529990128-17\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f4529990128-18\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0005 seconds] -->\r\n<p></p>\n<h2>Using the Messages API to Drive Classification and Training</h2>\n<h3>Messages Objects</h3>\n<p>Next we&#8217;re going to add some POCOs to hold our messaging data as it comes in and goes out to the Messages API &#8211; these objects are fairly verbose and don&#8217;t do anything particularly interesting aside from allowing the serialization / deserialization of JSON so, for the sake of brevity feel free to simply use the following structures:</p>\n<ul>\n<li><a href=\"https://github.com/slorello89/MessagesTensorFlow/blob/master/MessagesTensorFlow/StatusMessage.cs\">StatusMessage.cs</a></li>\n<li><a href=\"https://github.com/slorello89/MessagesTensorFlow/blob/master/MessagesTensorFlow/InboundMessage.cs\">InboundMessage.cs</a></li>\n<li><a href=\"https://github.com/slorello89/MessagesTensorFlow/blob/master/MessagesTensorFlow/MessageRequest.cs\">MessageRequest.cs</a></li>\n</ul>\n<h3>Interacting With the API</h3>\n<p>Creating these structures frees us up to manage the data we are getting from and sending out to the Messages API. However we need one more step to enable us to actually use the API &#8211; we&#8217;ll need to generate a JWT to authenticate our application with the Messages API. To this end, let&#8217;s create the following files.</p>\n<ul>\n<li>TokenGenerator.cs</li>\n<li>MessageSender.cs</li>\n</ul>\n<h4>Generate JWT</h4>\n<p>TokenGenerator is going to have one static method GenerateToken which will accept a list of Claims and the privateKey for your application</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0f6558019289\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\nusing Org.BouncyCastle.Crypto.Parameters;\nusing Org.BouncyCastle.OpenSsl;\nusing Org.BouncyCastle.Security;\nusing System.Collections.Generic;\nusing System.IO;\nusing System.Linq;\nusing System.Security.Claims;\nusing System.Security.Cryptography;\n\nnamespace MessagesTensorFlow\n{\n    public class TokenGenerator\n    {\n        public static string GenerateToken(List&lt;Claim&gt; claims, string privateKey)\n        {\n            RSAParameters rsaParams;\n            using (var tr = new StringReader(privateKey))\n            {\n                var pemReader = new PemReader(tr);\n                var kp = pemReader.ReadObject();\n                var privateRsaParams = kp as RsaPrivateCrtKeyParameters;\n                rsaParams = DotNetUtilities.ToRSAParameters(privateRsaParams);\n            }\n            using (RSACryptoServiceProvider rsa = new RSACryptoServiceProvider())\n            {\n                rsa.ImportParameters(rsaParams);\n                Dictionary&lt;string, object&gt; payload = claims.ToDictionary(k =&gt; k.Type, v =&gt; (object)v.Value);\n                return Jose.JWT.Encode(payload, rsa, Jose.JwsAlgorithm.RS256);\n            }\n        }\n    }\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f6558019289-33\">33</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-1\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">Org</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">BouncyCastle</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Crypto</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Parameters</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-2\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">Org</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">BouncyCastle</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">OpenSsl</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-3\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">Org</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">BouncyCastle</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Security</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-4\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Collections</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Generic</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-5\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">IO</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-6\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Linq</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-7\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Security</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Claims</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-8\"><span class=\"crayon-e\">using </span><span class=\"crayon-v\">System</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Security</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Cryptography</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-9\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-10\"><span class=\"crayon-t\">namespace</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MessagesTensorFlow</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-11\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">TokenGenerator</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">GenerateToken</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">List</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">Claim</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">claims</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">RSAParameters </span><span class=\"crayon-v\">rsaParams</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tr</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StringReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pemReader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">PemReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tr</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">kp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pemReader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReadObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">privateRsaParams</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">kp </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RsaPrivateCrtKeyParameters</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">rsaParams</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DotNetUtilities</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToRSAParameters</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">privateRsaParams</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">RSACryptoServiceProvider </span><span class=\"crayon-v\">rsa</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RSACryptoServiceProvider</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">rsa</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ImportParameters</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">rsaParams</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Dictionary</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">object</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">payload</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">claims</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToDictionary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Type</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">v</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">object</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">v</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Jose</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">JWT</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Encode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">payload</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">rsa</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Jose</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">JwsAlgorithm</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">RS256</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f6558019289-32\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f6558019289-33\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0008 seconds] -->\r\n<p></p>\n<p>This will generate a JWT for your usage with the Messages API.</p>\n<h4>Generate a Claims List for JWT</h4>\n<p>In the MessageSender.cs we&#8217;ll have a method to generate the claims for the JWT from your appId:</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0f7809375707\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\nprivate static List&lt;Claim&gt; GetClaimsList(string appId)\n{\n    const int SECONDS_EXPIRY = 3600;\n    var t = DateTime.UtcNow - new DateTime(1970, 1, 1);\n    var iat = new Claim(\"iat\", ((Int32)t.TotalSeconds).ToString(), ClaimValueTypes.Integer32); // Unix Timestamp for right now\n    var application_id = new Claim(\"application_id\", appId); // Current app ID\n    var exp = new Claim(\"exp\", ((Int32)(t.TotalSeconds + SECONDS_EXPIRY)).ToString(), ClaimValueTypes.Integer32); // Unix timestamp for when the token expires\n    var jti = new Claim(\"jti\", Guid.NewGuid().ToString()); // Unique Token ID\n    var claims = new List&lt;Claim&gt;() { iat, application_id, exp, jti };\n\n    return claims;\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f7809375707-13\">13</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f7809375707-1\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">List</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">Claim</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">GetClaimsList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">appId</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f7809375707-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f7809375707-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SECONDS_EXPIRY</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3600</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f7809375707-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DateTime</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">UtcNow</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DateTime</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1970</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f7809375707-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"iat\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Int32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">TotalSeconds</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClaimValueTypes</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Integer32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Unix Timestamp for right now</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f7809375707-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">application_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"application_id\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">appId</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Current app ID</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f7809375707-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">exp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"exp\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Int32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">TotalSeconds</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SECONDS_EXPIRY</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClaimValueTypes</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Integer32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Unix timestamp for when the token expires</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f7809375707-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jti</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"jti\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Guid</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">NewGuid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Unique Token ID</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f7809375707-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">claims</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">List</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">Claim</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iat</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">application_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">exp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">jti</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f7809375707-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f7809375707-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">claims</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f7809375707-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f7809375707-13\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0006 seconds] -->\r\n<p></p>\n<h4>Read App Settings and Create JWT</h4>\n<p>Then we&#8217;ll have another method to read the relevant items out of your configuration, which the controller will hand us through Dependency Injection, retrieve the claims list, and build the JWT</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0f9326838845\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\nprivate static string BuildJwt(IConfiguration config)\n{\n    var appId = config[\"Authentication:appId\"];\n    var priavteKeyPath = config[\"Authentication:privateKey\"];\n    string privateKey = \"\";\n    using (var reader = File.OpenText(priavteKeyPath)) // file containing RSA PKCS1 private key\n        privateKey = reader.ReadToEnd();\n\n    var jwt = TokenGenerator.GenerateToken(GetClaimsList(appId), privateKey);\n    return jwt;\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0f9326838845-12\">12</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f9326838845-1\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BuildJwt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f9326838845-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f9326838845-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">appId</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">\"Authentication:appId\"</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f9326838845-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">priavteKeyPath</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">\"Authentication:privateKey\"</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f9326838845-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f9326838845-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">reader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">File</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">OpenText</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">priavteKeyPath</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// file containing RSA PKCS1 private key</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f9326838845-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">reader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReadToEnd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f9326838845-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f9326838845-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TokenGenerator</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GenerateToken</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">GetClaimsList</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">appId</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f9326838845-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0f9326838845-11\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0f9326838845-12\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0003 seconds] -->\r\n<p></p>\n<p>This will of course require a couple of items in your appsettings.json file Add the following object to your appsettings.json file and fill in with the appropriate values:</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0fa447631696\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\n\"Authentication\": {\n    \"appId\": \"app_id\",\n    \"privateKey\": \"path_to_key_file\"\n  }\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fa447631696-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fa447631696-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fa447631696-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fa447631696-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fa447631696-5\">5</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fa447631696-1\"><span class=\"crayon-s\">\"Authentication\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fa447631696-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"appId\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"app_id\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fa447631696-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"privateKey\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"path_to_key_file\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fa447631696-4\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fa447631696-5\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0001 seconds] -->\r\n<p></p>\n<h4>Send a Message</h4>\n<p>Now we&#8217;re going to tie this all together with our SendMessage method, which will take our message, toId, fromId, and config. This method will generate a JWT and send along a request to the Messages API to send a message containing the feedback from our classifier to our end user.</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0fb652342723\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\npublic static void SendMessage(string message, string fromId, string toId, IConfiguration config)\n{\n    const string MESSAGING_URL = @\"https://api.nexmo.com/v0.1/messages\";\n    try\n    {\n        var jwt = BuildJwt(config);\n\n        var requestObject = new MessageRequest()\n        {\n            to = new MessageRequest.To()\n            {\n                id = toId,\n                type = \"messenger\"\n            },\n            from = new MessageRequest.From()\n            {\n                id = fromId,\n                type = \"messenger\"\n            },\n            message = new MessageRequest.Message()\n            {\n                content = new MessageRequest.Message.Content()\n                {\n                    type = \"text\",\n                    text = message\n                },\n                messenger = new MessageRequest.Message.Messenger()\n                {\n                    category = \"RESPONSE\"\n                }\n            }\n        };\n        var requestPayload = JsonConvert.SerializeObject(requestObject, new JsonSerializerSettings() { NullValueHandling = NullValueHandling.Ignore, DefaultValueHandling = DefaultValueHandling.Ignore });\n        var httpWebRequest = (HttpWebRequest)WebRequest.Create(MESSAGING_URL);\n        httpWebRequest.ContentType = \"application/json\";\n        httpWebRequest.Accept = \"application/json\";\n        httpWebRequest.Method = \"POST\";\n        httpWebRequest.PreAuthenticate = true;\n        httpWebRequest.Headers.Add(\"Authorization\", \"Bearer \" + jwt);\n        using (var streamWriter = new StreamWriter(httpWebRequest.GetRequestStream()))\n        {\n            streamWriter.Write(requestPayload);\n        }\n        using (var httpResponse = (HttpWebResponse)httpWebRequest.GetResponse())\n        {\n            using (var streamReader = new StreamReader(httpResponse.GetResponseStream()))\n            {\n                var result = streamReader.ReadToEnd();\n                Console.WriteLine(result);\n                Console.WriteLine(\"Message Sent\");\n            }\n        }\n    }\n    catch (Exception e)\n    {\n        Debug.WriteLine(e.ToString());\n    }\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fb652342723-59\">59</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SendMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fromId</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">toId</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MESSAGING_URL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-s\">\"https://api.nexmo.com/v0.1/messages\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">BuildJwt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">requestObject</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MessageRequest</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">To</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">toId</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"messenger\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">From</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fromId</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"messenger\"</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">message</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Message</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">content</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Content</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"text\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">text</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">message</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">messenger</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Messenger</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">category</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"RESPONSE\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">requestPayload</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">JsonConvert</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SerializeObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">requestObject</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">JsonSerializerSettings</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NullValueHandling</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NullValueHandling</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Ignore</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DefaultValueHandling</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DefaultValueHandling</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">Ignore</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">HttpWebRequest</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">WebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Create</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">MESSAGING_URL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ContentType</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"application/json\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-36\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Accept</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"application/json\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Method</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"POST\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">PreAuthenticate</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Headers</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"Authorization\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Bearer \"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-40\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">streamWriter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StreamWriter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetRequestStream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-41\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-42\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">streamWriter</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">requestPayload</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-43\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-44\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">httpResponse</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">HttpWebResponse</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetResponse</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-45\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-46\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">streamReader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StreamReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">httpResponse</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetResponseStream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-47\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-48\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">streamReader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReadToEnd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-49\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-50\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"Message Sent\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-51\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-52\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-53\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-54\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Exception</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-55\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-56\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Debug</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-57\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fb652342723-58\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fb652342723-59\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p></p>\n<h4>Classification Handler</h4>\n<p>We&#8217;re going to want the handling of inbound webhooks to be asynchronous and respond immediately, so we&#8217;re going to create a ClassificationHandler.cs file to actually handle the classify / reply operations. This file will contain a couple of small structures to allow us to unpack, classify or train, and reply to inbound messages.</p>\n<p>In ClassificationHandler.cs add the following code:</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0fd464794389\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\npublic static void ClassifyAndRespond(object state)\n{\n    var request = state as ClassifyRequest;\n    var response = TFEngine.Instance.ClassifySingleImage(request.imageUrl);\n    MessageSender.SendMessage(response, request.toId, request.fromid, request.Configuration);\n}\n\npublic static void AddTrainingData(object state)\n{\n    var request = state as TrainRequest;\n    var response = TFEngine.Instance.AddTrainingImage(request.imageUrl, request.Label);\n    MessageSender.SendMessage(response, request.toId, request.fromid, request.Configuration);\n}\npublic class TrainRequest : Request\n{\n    public string Label { get; set; }\n}\npublic class ClassifyRequest : Request{}\npublic abstract class Request\n{\n    public string imageUrl { get; set; }\n    public string toId { get; set; }\n    public string fromid { get; set; }\n\n    public IConfiguration Configuration { get; set; }\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fd464794389-27\">27</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">ClassifyAndRespond</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">object</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">state</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">state </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClassifyRequest</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">response</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TFEngine</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Instance</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ClassifySingleImage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">MessageSender</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SendMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">toId</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">fromid</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-8\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">AddTrainingData</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">object</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">state</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-9\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">state </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TrainRequest</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">response</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TFEngine</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Instance</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AddTrainingImage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Label</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">MessageSender</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SendMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">toId</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">fromid</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-13\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-14\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TrainRequest</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Request</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-15\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Label</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-17\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-18\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClassifyRequest</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Request</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-19\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">abstract</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Request</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-20\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">imageUrl</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">toId</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">fromid</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-24\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IConfiguration</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fd464794389-26\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fd464794389-27\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0007 seconds] -->\r\n<p></p>\n<h2>Handle Incoming Messages Webhooks</h2>\n<p>From our code&#8217;s perspective the final thing we&#8217;re going to need to do is to create a couple of controllers to handle the incoming messages and status from the Messages API.</p>\n<p>In the Controllers folder, add 2 &#8220;API controller &#8211; Empty&#8221; called InboundController and StatusController.</p>\n<h3>Status Controller</h3>\n<p>The Status controller is going to provide status to our application&#8217;s messages as they flow through the API, to keep track of what&#8217;s going on, let&#8217;s add a post method to the Status controller to write the status contents out to the debug console:</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0fe566370565\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\n[HttpPost]\npublic HttpStatusCode Post([FromBody]StatusMessage message)\n{\n    Debug.WriteLine(JsonConvert.SerializeObject(message));\n    return HttpStatusCode.NoContent;\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fe566370565-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fe566370565-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fe566370565-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fe566370565-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fe566370565-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0fe566370565-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0fe566370565-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fe566370565-1\"><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">HttpPost</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fe566370565-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HttpStatusCode </span><span class=\"crayon-e\">Post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">FromBody</span><span class=\"crayon-sy\">]</span><span class=\"crayon-e\">StatusMessage </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fe566370565-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fe566370565-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Debug</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">JsonConvert</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SerializeObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fe566370565-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpStatusCode</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NoContent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0fe566370565-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0fe566370565-7\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0001 seconds] -->\r\n<p></p>\n<h3>Inbound Controller</h3>\n<p>The Inbound Controller is going to be managing the Inbound Messages from our webhook.</p>\n<h4>Class Setup</h4>\n<p>Let&#8217;s first set it up by creating a dictionary for the pending training labels, a Configuration object for the controller to access the configuration, and by Dependency Injecting the Configuration into the Inbound Controller constructor:</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d0ff631331996\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\npublic static Dictionary&lt;string, string&gt; _pendingTrainLabels = new Dictionary&lt;string, string&gt;();\npublic IConfiguration Configuration { get; set; }\npublic InboundController(IConfiguration configuration)\n{\n    Configuration = configuration;\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ff631331996-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ff631331996-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ff631331996-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ff631331996-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ff631331996-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d0ff631331996-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d0ff631331996-7\">7</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ff631331996-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Dictionary</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Dictionary</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ff631331996-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IConfiguration</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">get</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">set</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ff631331996-3\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">InboundController</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">configuration</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ff631331996-4\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ff631331996-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">configuration</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d0ff631331996-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d0ff631331996-7\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0002 seconds] -->\r\n<p></p>\n<h4>Handling Inbound Messages</h4>\n<p>Next, we&#8217;ll write the actual InboundMessage handler. This handler will be a POST request. It will check to see if there&#8217;s any text in the message. If there is, it will see if the first word in that message is &#8216;train.&#8217; If so it will save the rest of the message as a training label, and the next time that user sends a message with a picture, the classifier will be trained with that image and label.</p>\n<p>On any other image message it will simply classify the image and send the output of the classification back to the message sender.</p>\n<p>In both cases it starts a WorkItem in the ThreadPool, passing in one of those handy ClassificationHandler request objects we generated earlier &#8211; this unblocks the controller to send a status back to the messages api (in this case a 204 to inform it that it received the message)</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d101067327008\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\n[HttpPost]\npublic HttpStatusCode Post([FromBody]InboundMessage message)\n{\n    const string TRAIN = \"train\";\n    try\n    {\n        Debug.WriteLine(JsonConvert.SerializeObject(message));\n        if (!string.IsNullOrEmpty(message.message.content.text))\n        {\n            var split = message.message.content.text.Split(new[] { ' ' }, 2);\n            if (split.Length &gt; 1)\n            {\n                if (split[0].ToLower() == TRAIN)\n                {\n                    var label = split[1];\n                    var requestor = message.from.id;\n                    if (!_pendingTrainLabels.ContainsKey(requestor))\n                    {\n                        _pendingTrainLabels.Add(requestor, label);\n                    }\n                    else\n                    {\n                        _pendingTrainLabels[requestor] = label;\n                    }\n                }\n            }\n        }\n        if (_pendingTrainLabels.ContainsKey(message.from.id) &amp;&amp; message.message.content?.image?.url != null)\n        {\n            ThreadPool.QueueUserWorkItem(ClassificationHandler.AddTrainingData, new ClassificationHandler.TrainRequest()\n            {\n                toId = message.to.id,\n                fromid = message.from.id,\n                imageUrl = message.message.content.image.url,\n                Label = _pendingTrainLabels[message.from.id],\n                Configuration = Configuration\n            });\n            _pendingTrainLabels.Remove(message.from.id);\n        }\n        else\n        {\n            ThreadPool.QueueUserWorkItem(ClassificationHandler.ClassifyAndRespond,\n            new ClassificationHandler.ClassifyRequest()\n            {\n                toId = message.to.id,\n                fromid = message.from.id,\n                imageUrl = message.message.content.image.url,\n                Configuration = Configuration\n            });\n        }\n\n        return HttpStatusCode.NoContent;\n    }\n    catch (Exception ex)\n    {\n        return HttpStatusCode.NoContent;\n    }\n}\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d101067327008-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d101067327008-59\">59</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-1\"><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">HttpPost</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HttpStatusCode </span><span class=\"crayon-e\">Post</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">FromBody</span><span class=\"crayon-sy\">]</span><span class=\"crayon-e\">InboundMessage </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TRAIN</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"train\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Debug</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">JsonConvert</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SerializeObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">IsNullOrEmpty</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">split</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Split</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-sy\">[</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">' '</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">split</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Length</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">split</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToLower</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TRAIN</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">label</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">split</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">requestor</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ContainsKey</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">requestor</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">requestor</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">label</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">requestor</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">label</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ContainsKey</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">?</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">image</span><span class=\"crayon-sy\">?</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">url</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">ThreadPool</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">QueueUserWorkItem</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ClassificationHandler</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">AddTrainingData</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClassificationHandler</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">TrainRequest</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">toId</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">to</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">fromid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">image</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">url</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Label</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-36\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Configuration</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_pendingTrainLabels</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Remove</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-40\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-41\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-42\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">ThreadPool</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">QueueUserWorkItem</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">ClassificationHandler</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ClassifyAndRespond</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-43\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClassificationHandler</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ClassifyRequest</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-44\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-45\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">toId</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">to</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-46\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">fromid</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-47\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">imageUrl</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">image</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">url</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-48\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Configuration</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">Configuration</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-49\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-50\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-51\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-52\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpStatusCode</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NoContent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-53\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-54\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">Exception </span><span class=\"crayon-v\">ex</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-55\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-56\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpStatusCode</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NoContent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-57\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d101067327008-58\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d101067327008-59\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0013 seconds] -->\r\n<p></p>\n<h4>Seeding With a Little Data.</h4>\n<p>You can add whatever images and tags you want to get yourself started. For the sake of simplicity I&#8217;m only going to start with one image &#8211; an image of my dog (aptly named Zero).</p>\n<p><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/zero.png\" alt=\"Zero\" width=\"360\" height=\"480\" class=\"aligncenter size-full wp-image-30592\" /></p>\n<p>I&#8217;m going to put that image in the assets/train directory.</p>\n<p>Now since Zero is a whippet, I&#8217;m going to, in the tags.tsv file in the assets/train folder, add the file name &#8216;zero.jpg&#8217; followed by a tab, followed by the label &#8216;whippet&#8217; followed by a new line</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\r\n\r\n\t\t<div id=\"crayon-5e9c0bd55d102670269166\" class=\"crayon-syntax crayon-theme-nexmo-2018 crayon-font-monaco crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 24px; margin-bottom: 24px; font-size: 14px !important; line-height: 22px !important;\">\r\n\t\t\r\n\t\t\t<div class=\"crayon-toolbar\" data-settings=\" show\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><span class=\"crayon-title\"></span>\r\n\t\t\t<div class=\"crayon-tools\" style=\"font-size: 14px !important;height: 21px !important; line-height: 21px !important;\"><div class=\"crayon-button crayon-nums-button\" title=\"Toggle Line Numbers\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-wrap-button\" title=\"Toggle Line Wrap\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-expand-button\" title=\"Expand Code\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-copy-button\" title=\"Copy\"><div class=\"crayon-button-icon\"></div></div><div class=\"crayon-button crayon-popup-button\" title=\"Open Code In New Window\"><div class=\"crayon-button-icon\"></div></div></div></div>\r\n\t\t\t<div class=\"crayon-info\" style=\"min-height: 19.6px !important; line-height: 19.6px !important;\"></div>\r\n\t\t\t<div class=\"crayon-plain-wrap\"><textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\nzero.jpg    whippet\n</textarea></div>\r\n\t\t\t<div class=\"crayon-main\" style=\"\">\r\n\t\t\t\t<table class=\"crayon-table\">\r\n\t\t\t\t\t<tr class=\"crayon-row\">\r\n\t\t\t\t<td class=\"crayon-nums \" data-settings=\"show\">\r\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9c0bd55d102670269166-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9c0bd55d102670269166-2\">2</div></div>\r\n\t\t\t\t</td>\r\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9c0bd55d102670269166-1\"><span class=\"crayon-v\">zero</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">jpg&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-i\">whippet</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9c0bd55d102670269166-2\">&nbsp;</div></div></td>\r\n\t\t\t\t\t</tr>\r\n\t\t\t\t</table>\r\n\t\t\t</div>\r\n\t\t</div>\r\n<!-- [Format Time: 0.0000 seconds] -->\r\n<p></p>\n<h2>Testing</h2>\n<p>With this done, all that&#8217;s left to do is fire it up, expose it to the internet, and test it out. I use ngrok and IIS express to test it.</p>\n<h3>IIS Express Config</h3>\n<p>First go into the project properties debug tab and look for the App Url &#8211; specifically which port it&#8217;s going to be using &#8211; I uncheck the Enable SSL box for testing.</p>\n<p><a href=\"https://www.nexmo.com/wp-content/uploads/2019/10/IIS_Config.png\"><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/IIS_Config.png\" alt=\"\" width=\"999\" height=\"457\" class=\"alignnone size-full wp-image-30588\" /></a></p>\n<p>Then launch the site from visual studio using IIS Express &#8211; you&#8217;ll see the port in the address bar of the browser which pops up &#8211; in my sample I cleaned out all the weather controller stuff that comes out of the box so I get a 404 when I fire it up &#8211; which is fine as this is really only acting as a web service to listen for and reply to webhooks. There isn&#8217;t any get requests to propagate a page back to your web browser.</p>\n<h3>Using Ngrok to Expose the Port to the Internet</h3>\n<p>For the Messages API to forward the messages we&#8217;ll need to expose the site to the internet &#8211; for testing purposes, we&#8217;ll use <a href=\"https://ngrok.com\">ngrok</a> to expose our IIS express port. Open up your command line and use this command, replace <code></code> with your port number.</p>\n<p><code>ngrok http --host-header=\"localhost:\" http://localhost:</code></p>\n<p>This command produces an output like this:</p>\n<p><a href=\"https://www.nexmo.com/wp-content/uploads/2019/10/ngrok.png\"><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/ngrok.png\" alt=\"\" width=\"696\" height=\"212\" class=\"alignnone size-full wp-image-30589\" /></a></p>\n<h3>Configuring the Webhooks</h3>\n<p>Using the http link we just got from ngrok you can create the url that the webhook will be calling back on &#8211; you can see in the Route of the controllers we just made what the route will look like:<br />\n<a href=\"https://www.nexmo.com/wp-content/uploads/2019/10/controllerExample.png\"><img src=\"https://www.nexmo.com/wp-content/uploads/2019/10/controllerExample.png\" alt=\"\" width=\"392\" height=\"80\" class=\"alignnone size-full wp-image-30587\" /></a><br />\nIt&#8217;s going to work out to be<br />\n<code>http://dc0feb1d.ngrok.io/api/Status</code> for status messages<br />\nand<br />\n<code>http://dc0feb1d.ngrok.io/api/Inbound</code> for inbound messages</p>\n<p>NOTE: The first part of the url (dc0feb1d) will change whenever you restart ngrok on the free tier.</p>\n<p>We&#8217;ll use those callback URLs to register our webhooks with Nexmo.</p>\n<p>Go To https://dashboard.nexmo.com and login to your Nexmo account</p>\n<p>Go to messages and dispatch -&gt; Your applications and select the edit button for your application</p>\n<p>On the edit screen change the Status URL and Inbound URL fields to the noted values above and click the blue save button in the lower right hand corner.</p>\n<p>And that&#8217;s it. Now you have a classifier / learner that you can feed images over messenger.</p>\n<h2>Helpful Links</h2>\n<ul>\n<li><a href=\"https://developer.nexmo.com/messages/overview\">The full overview of the Messages API</a></li>\n<li><a href=\"https://github.com/slorello89/MessagesTensorFlow\">All the code from this tutorial</a></li>\n<li><a href=\"https://docs.microsoft.com/en-us/dotnet/machine-learning/tutorials/image-classification\">ML.NET Tensor Flow documentation</a> for more information about ML.NET Tensor Flow &#8211; in fact, the TFEngine&#8217;s GenerateModel function is derived from this tutorial.</li>\n</ul>\n"}