{"_filedata":{"slug":"adding-2-factor-authentication-to-wordpress-with-nexmo-verify-api-dr"},"title":"Adding 2-Factor Authentication to WordPress with Nexmo Verify API","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2019/10/E_2FA-WordPress_1200x600.jpg","author":352,"published":true,"published_at":"2019-10-09T21:06:04","tags":[1550,1117,1635],"body":"[![blog spotlight banner ](https://www.nexmo.com/wp-content/uploads/2019/08/blog-spotlight-banner.png)](https://developer.nexmo.com/spotlight)\n\n## Introduction\n\nWith security breaches on the rise, protecting your website and its users has never been as dire as it is today. In this tutorial, you will set up 2FA (two-factor authentication) on WordPress using the Nexmo Verify API. With this setup, whenever a user tries to log in, they’ll get an SMS or call on the mobile number registered to their profile with a unique code, and upon entering the valid code will they be logged in.\n\nAt the end of this tutorial, you’ll have learned the basics of building a WordPress plugin and have a good understanding of how to integrating the Nexmo API with WordPress using the Nexmo PHP Library. So let’s get started!\n\n### About the Nexmo Verify API\n\nThe Verify API is Nexmo’s plug and play solution for two-factor authentication on any system. The process is simple; you’d call the [Send Verification](https://developer.nexmo.com/verify/code-snippets/send-verify-request/php) endpoint passing a mobile number, Nexmo will send the mobile number a unique code via SMS/call and return a request ID. With the user’s code, you’d call the [Check Verification](https://developer.nexmo.com/verify/code-snippets/check-verify-request) endpoint along with the request ID to verify the code, and Nexmo returns a status depending on if the code is valid or not. Quite simple right?\n\nI particularly like Nexmo Verify because of something called workflows. With workflows, you can set up multiple fallback options in case a user doesn’t receive the code via SMS on time. You can set up a fallback option for a voice call after a certain duration and much more, you can read about workflows [here](https://developer.nexmo.com/verify/guides/workflows-and-events).\n\n## What You Need to Get Started:\n\n*   Self-hosted [WordPress](https://wordpress.com) website\n*   [Nexmo account](https://dashboard.nexmo.com/sign-up?utm_source=DEV_REL&utm_medium=github&utm_campaign=https://github.com/Kendysond/two-factor-auth-nexmo). You can sign up now for free if you don’t already have an account.\n\n## Creating Your WordPress Plugin\n\nWhile you can create a WordPress plugin by simply adding a new folder in the WordPress plugins folder, a really efficient way is using a lightweight boilerplate to get started. Boilerplates are helpful to set up all the files and Classes in a standard way. In this tutorial, you’ll be using the [wppb](https://wppb.me/) boilerplate; simply fill in the details on the website, and click the build plugin button to download your plugin boilerplate.\n\n[![wordpress_login](https://www.nexmo.com/wp-content/uploads/2019/10/wordpress_login.png)](https://www.nexmo.com/wp-content/uploads/2019/10/wordpress_login.png)\n\nOnce you have that, extract the zip file and put it in your WordPress plugins folder. Next, go to your WordPress admin, navigate to the installed plugins page and activate your plugin.\n\n[![plugins ](https://www.nexmo.com/wp-content/uploads/2019/10/plugins.png)](https://www.nexmo.com/wp-content/uploads/2019/10/plugins.png)\n\n## User Stories\n\nWith our goal of setting up 2FA on WordPress, let’s break the idea into actionable user stories/steps and implement them from top to bottom:\n\n*   On the WordPress user profile settings, you’ll need custom fields for the user’s 2FA mobile number and if they’re enabled for 2FA\n*   You’ll send a code to the user’s mobile number when they log in\n*   You’ll have a form for the user to enter the code they received and verify the code\n\n#### Understanding WordPress Actions and Filters\n\nMost of the edits you’ll be making on WordPress have to do with hooking your functions to existing WordPress actions and filters; **Actions** are functions performed when a certain event occurs in WordPress. Hence, if you want your function to run when a specific event occurs e.g when a user logs in, you’ll hook your function to the login related action. On the other end, **Filters** modify certain functions; you can use a filter to manipulate the result of a function.\n\nYou hook your function to an existing action like this:\n\n`add_action( 'action_name', 'name_of_your_function' );`\n\nYou hook your function to a filter like this:\n\n`add_filter( 'filter_name', 'name_of_your_function' );`\n\n## User Custom Fields\n\nFor brevity of this post, here’s the [link](https://github.com/Kendysond/two-factor-auth-nexmo/blob/dca42f3695ad8385cd1655f942b5f42e8b45b16c/admin/class-two-factor-auth-nexmo-admin.php#L62) to the code that adds the mobile number and 2FA enabled checkbox fields to the WordPress user profile settings. With that setup, your user settings page would look like this:\n\n[![nexmo_2fa](https://www.nexmo.com/wp-content/uploads/2019/10/nexmo_2fa.png)](https://www.nexmo.com/wp-content/uploads/2019/10/nexmo_2fa.png)\n\n## Adding the Nexmo PHP Library to the Mix\n\nNexmo recommends you install their [PHP Library](https://github.com/Nexmo/nexmo-php) via Composer; you’ll need to have Composer set up on your server/local system. If you don’t have Composer set up, here are two guides recommended by Nexmo to help you: [GetComposer.org](https://getcomposer.org/doc/00-intro.md) or [Scotch.io](https://scotch.io/tutorials/a-beginners-guide-to-composer)\n\nWith Composer installed, open your terminal, navigate to your plugin’s root folder, and run:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">composer require nexmo/client</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2c9d361659858-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2c9d361659858-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2c9d361659858-1\"><span class=\"crayon-e\">composer </span><span class=\"crayon-e\">require </span><span class=\"crayon-v\">nexmo</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">client</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2c9d361659858-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nIt’ll create a new folder called `vendor` that contains a number of other libraries, Nexmo’s PHP Library included. To include the Library in your plugin, simply add this line to your plugin’s root PHP file.\n\n`require_once plugin_dir_path( __FILE__ ) . 'vendor/autoload.php';`\n\n#### Initializing the Nexmo Class\n\nBefore you can make any call with Nexmo’s PHP Library, you need to initialize the Nexmo Class and use the client object to make your subsequent requests.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">$basic = new \\Nexmo\\Client\\Credentials\\Basic(NEXMO_API_KEY, NEXMO_API_SECRET); $client = new \\Nexmo\\Client(new \\Nexmo\\Client\\Credentials\\Container($basic));</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca2709549683-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca2709549683-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca2709549683-3\">3</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca2709549683-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">basic</span><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Client</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Credentials</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">Basic</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">NEXMO_API_KEY</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NEXMO_API_SECRET</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca2709549683-2\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">client</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">Client</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Client</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Credentials</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">Container</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">basic</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca2709549683-3\">&nbsp;</div></div></td></tr></tbody></table>\n\nIf you’re using the boilerplate, you can make the following edits in the [public Class file](https://github.com/Kendysond/two-factor-auth-nexmo/blob/master/public/class-two-factor-auth-nexmo-public.php) in your plugin’s `/public` folder. You’ll be initializing the Nexmo Library in the construct and setting the client object as a protected variable so other methods of our public Class can access it.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">&lt;?php class Two_Factor_Auth_Nexmo_Public { protected $nexmo_client; public function __construct( $plugin_name, $version ) { $this-&gt;nexmo_client = new Nexmo\\Client(new Nexmo\\Client\\Credentials\\Basic(TWO_FACTOR_AUTH_NEXMO_KEY, TWO_FACTOR_AUTH_NEXMO_SECRET)); } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca3967785927-13\">13</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca3967785927-1\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-sy\">?</span><span class=\"crayon-e\">php</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca3967785927-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca3967785927-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca3967785927-4\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Two_Factor_Auth_Nexmo_Public</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca3967785927-5\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca3967785927-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nexmo_client</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca3967785927-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca3967785927-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">plugin_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">version</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca3967785927-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">nexmo_client</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">Client</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Client</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Credentials</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">Basic</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TWO_FACTOR_AUTH_NEXMO_KEY</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TWO_FACTOR_AUTH_NEXMO_SECRET</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca3967785927-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca3967785927-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca3967785927-12\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca3967785927-13\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Sending the Verification Request\n\nBased on our user story, we want to intercept the user login, check if the user is enabled for 2FA, and if they are, initiate a [Send Verification](https://developer.nexmo.com/verify/code-snippets/send-verify-request) request to their mobile number. To achieve this, you’ll be hooking the `authenticate` WordPress action as it’s the action triggered when a user logs in successfully.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">&lt;?php class Two_Factor_Auth_Nexmo_Public { protected $nexmo_client; public function __construct( $plugin_name, $version ) { $this-&gt;nexmo_client = new Nexmo\\Client(new Nexmo\\Client\\Credentials\\Basic(TWO_FACTOR_AUTH_NEXMO_KEY, TWO_FACTOR_AUTH_NEXMO_SECRET)); add_action( 'authenticate', array( $this, 'intercept_login_with_two_factor_auth' ), 10, 3 ); } public function intercept_login_with_two_factor_auth( $user, $username, $password ) { $errors = array(); $redirect_to = isset( $_POST['redirect_to'] ) ? $_POST['redirect_to'] : admin_url(); $remember_me = ( isset( $_POST['rememberme'] ) &amp;&amp; $_POST['rememberme'] === 'forever' ) ? true : false; $_user = get_user_by( 'login', $username ); if ( $_user ) { $this-&gt;verify_user( $_user, $redirect_to, $remember_me ); } return $user; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca4958675057-27\">27</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-1\"><span class=\"crayon-o\">&lt;</span><span class=\"crayon-sy\">?</span><span class=\"crayon-e\">php</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-3\"><span class=\"crayon-t\">class</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Two_Factor_Auth_Nexmo_Public</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-4\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">protected</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nexmo_client</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">__construct</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">plugin_name</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">version</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">nexmo_client</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">Client</span><span class=\"crayon-sy\">(</span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Client</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Credentials</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">Basic</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">TWO_FACTOR_AUTH_NEXMO_KEY</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TWO_FACTOR_AUTH_NEXMO_SECRET</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-9\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">add_action</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'authenticate'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'intercept_login_with_two_factor_auth'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">10</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-13\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">intercept_login_with_two_factor_auth</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">username</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">password</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">errors</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">redirect_to</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">isset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'redirect_to'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'redirect_to'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">admin_url</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remember_me</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">isset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'rememberme'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'rememberme'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'forever'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-18\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_user</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_user_by</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'login'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">username</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-20\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">_user</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">verify_user</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">redirect_to</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remember</span><span class=\"crayon-sy\">_</span>me<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-24\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca4958675057-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca4958675057-27\">&nbsp;</div></div></td></tr></tbody></table>\n\nHooking our function into the `authenticate` action gives us three variables to work with: `$user`, `$username`, and `$password`, the `$user` variable is typically null, but that’s okay. What you need is the `$username`, with that, you can call the WordPress function to get the user object. You need the user object to get other properties of the user like the mobile number and if they’re enabled for 2FA.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">$_user = get_user_by( 'login', $username );// Function to get the user object</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca6372207068-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca6372207068-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca6372207068-1\"><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_user</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_user_by</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'login'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">username</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-c\">// Function to get the user object</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca6372207068-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nTo get the value for a user’s custom fields, you use the WordPress function `get_user_meta`, passing the user ID and the name for the custom field. As defined in the user profile settings code, the name of the fields are `two_factor_auth_nexmo_enabled` and `two_factor_auth_nexmo_mobile`.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">private function verify_user( $user, $redirect_to, $remember_me, $errors = array() ) { $enabled_2fa = get_user_meta($user-&gt;ID, 'two_factor_auth_nexmo_enabled', true ); $mobile = get_user_meta($user-&gt;ID, 'two_factor_auth_nexmo_mobile', true ); if ( ! $mobile || ! $enabled_2fa) { return; } try { $verification = new \\Nexmo\\Verify\\Verification($mobile, TWO_FACTOR_AUTH_NEXMO_SENDER_NAME); $this-&gt;nexmo_client-&gt;verify()-&gt;start($verification); } catch(Exception $e) { $errors = array( \"Error sending verification request\" ); } $request_id = $verification-&gt;getRequestId(); update_user_meta( $user-&gt;ID, 'two_factor_auth_nexmo_request_id', $request_id); wp_logout(); }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca7013563964-25\">25</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-1\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">verify_user</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">redirect_to</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remember_me</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">errors</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">enabled_2fa</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_user_meta</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ID</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'two_factor_auth_nexmo_enabled'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">mobile</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_user_meta</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ID</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'two_factor_auth_nexmo_mobile'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-5\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">mobile</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">enabled_2fa</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-9\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">verification</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Verify</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">Verification</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">mobile</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TWO_FACTOR_AUTH_NEXMO_SENDER_NAME</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">nexmo_client</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">verify</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">start</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">verification</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Exception</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">errors</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Error sending verification request\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-17\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-18\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">verification</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getRequestId</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">update_user_meta</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ID</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'two_factor_auth_nexmo_request_id'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request_id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-21\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">wp_logout</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-23\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca7013563964-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca7013563964-25\">&nbsp;</div></div></td></tr></tbody></table>\n\nIf all the required variables are set (mobile number and 2FA enabled for the user), you call the function to initiate a [Send Verification](https://developer.nexmo.com/verify/code-snippets/send-verify-request) request, Nexmo sends the user the unique code, and a request ID is returned. It’s important to store the request ID so you can use it to call the Validate code function in the next step. A simple way to do this is using the WordPress `update_user_meta` function with the key identifier for the variable (in our case `two_factor_auth_nexmo_request_id`) and the variable `$request_id`.\n\nLastly, call the `logout` function. You might be wondering, why would you do that? You do this because, as initially stated, the authenticate action is triggered when the user has successfully logged in. So in reality, all of this code is running when the user is logged in, but that’s not what you want—at least not yet. You want the user logged in only after validating the code. Hence, log the user out after sending the code, and that leads us to our final step, validating the code and logging the user in.\n\n#### Validating the Code\n\nYou’ve sent the code to the user in the above section, all that’s left is showing the user a form to enter the code they received and validating it against their profile to log them in.\n\nBuilding on the `verify_user` function you created earlier, you’ll be adding the code validation form.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">private function verify_user( $user, $redirect_to, $remember_me, $errors = array() ) { $enabled_2fa = get_user_meta($user-&gt;ID, 'two_factor_auth_nexmo_enabled', true ); $mobile = get_user_meta($user-&gt;ID, 'two_factor_auth_nexmo_mobile', true ); if ( ! $mobile || ! $enabled_2fa) { return; } try { $verification = new \\Nexmo\\Verify\\Verification($mobile, TWO_FACTOR_AUTH_NEXMO_SENDER_NAME); $this-&gt;nexmo_client-&gt;verify()-&gt;start($verification); } catch(Exception $e) { $errors = array( \"Error sending verification request\" ); } $request_id = $verification-&gt;getRequestId(); update_user_meta( $user-&gt;ID, 'two_factor_auth_nexmo_request_id', $request_id); wp_logout(); nocache_headers(); header('Content-Type: ' . get_bloginfo( 'html_type' ) . '; charset=' . get_bloginfo( 'charset' ) ); login_header('Nexmo Two-Factor Authentication', '&lt;p class=\"message\"&gt;' . sprintf( 'Enter the PIN code sent to your mobile number ending in &lt;strong&gt;%1$s&lt;/strong&gt;' , substr($mobile, -5) ) . '&lt;/p&gt;'); if(!empty($errors)) { ?&gt; &lt;div id=\"login_error\"&gt;&lt;?php echo implode( '&lt;br /&gt;', $errors ) ?&gt;&lt;/div&gt; &lt;?php } ?&gt; &lt;form name=\"loginform\" id=\"loginform\" action=\"&lt;?php echo esc_url( site_url( 'wp-login.php', 'login_post' ) ) ?&gt;\" method=\"post\" autocomplete=\"off\"&gt; &lt;p&gt; &lt;label for=\"two_factor_auth_nexmo_pin_code\"&gt;Code &lt;br /&gt; &lt;input type=\"number\" name=\"two_factor_auth_nexmo_pin_code\" id=\"two_factor_auth_nexmo_pin_code\" class=\"input\" value=\"\" size=\"6\" /&gt; &lt;/label&gt; &lt;/p&gt; &lt;p class=\"submit\"&gt; &lt;input type=\"submit\" name=\"wp-submit\" id=\"wp-submit\" class=\"button button-primary button-large\" value=\"Verify\" /&gt; &lt;input type=\"hidden\" name=\"log\" value=\"&lt;?php echo esc_attr( $user-&gt;user_login ) ?&gt;\" /&gt; &lt;input type=\"hidden\" name=\"two_factor_auth_nexmo_request_id\" value=\"&lt;?php echo esc_attr( $request_id ) ?&gt;\" /&gt; &lt;input type=\"hidden\" name=\"redirect_to\" value=\"&lt;?php echo esc_attr( $redirect_to ) ?&gt;\" /&gt; &lt;?php if ( $remember_me ) : ?&gt; &lt;input type=\"hidden\" name=\"rememberme\" value=\"forever\" /&gt; &lt;?php endif; ?&gt; &lt;/p&gt; &lt;/form&gt; &lt;?php login_footer( 'two_factor_auth_nexmo_pin_code' ); exit; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2ca8858170001-58\">58</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-1\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">verify_user</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">redirect_to</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remember_me</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">errors</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">enabled_2fa</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_user_meta</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ID</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'two_factor_auth_nexmo_enabled'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">mobile</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_user_meta</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ID</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'two_factor_auth_nexmo_mobile'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-5\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">mobile</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">||</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">!</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">enabled_2fa</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-9\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">verification</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Verify</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">Verification</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">mobile</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TWO_FACTOR_AUTH_NEXMO_SENDER_NAME</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">nexmo_client</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">verify</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">start</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">verification</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Exception</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">errors</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Error sending verification request\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-17\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-18\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">verification</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getRequestId</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">update_user_meta</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ID</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'two_factor_auth_nexmo_request_id'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">request_id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-21\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">wp_logout</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">nocache_headers</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">header</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Content-Type: '</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_bloginfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'html_type'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'; charset='</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_bloginfo</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'charset'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">login_header</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">'Nexmo Two-Factor Authentication'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'&lt;p class=\"message\"&gt;'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sprintf</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'Enter the PIN code sent to your mobile number ending in &lt;strong&gt;%1$s&lt;/strong&gt;'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">substr</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">mobile</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">5</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'&lt;/p&gt;'</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-26\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-sy\">(</span><span class=\"crayon-o\">!</span><span class=\"crayon-e\">empty</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">errors</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"></span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-28\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">?</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">div </span><span class=\"crayon-v\">id</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"login_error\"</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-ta\">&lt;?php</span><span class=\"crayon-h\"> </span><span class=\"crayon-k \">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">implode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'&lt;br /&gt;'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$errors</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-ta\">?&gt;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">div</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-ta\">&lt;?php</span><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-h\"> </span><span class=\"crayon-ta\">?&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-32\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">form </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"loginform\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">id</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"loginform\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">action</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"<span class=\"crayon-ta\">&lt;?php</span><span class=\"crayon-h\"> </span><span class=\"crayon-k \">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">esc_url</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">site_url</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'wp-login.php'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'login_post'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-ta\">?&gt;</span>\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">method</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"post\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">autocomplete</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"off\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">label </span><span class=\"crayon-st\">for</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"two_factor_auth_nexmo_pin_code\"</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-v\">Code</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-36\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">br</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">input </span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"number\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"two_factor_auth_nexmo_pin_code\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">id</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"two_factor_auth_nexmo_pin_code\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"input\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">size</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"6\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">label</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-40\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-i\">p</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"submit\"</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-41\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">input </span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"submit\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"wp-submit\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">id</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"wp-submit\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">class</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"button button-primary button-large\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"Verify\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-42\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">input </span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"hidden\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"log\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"<span class=\"crayon-ta\">&lt;?php</span><span class=\"crayon-h\"> </span><span class=\"crayon-k \">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">esc_attr</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$user</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-i\">user_login</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-ta\">?&gt;</span>\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-43\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">input </span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"hidden\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"two_factor_auth_nexmo_request_id\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"<span class=\"crayon-ta\">&lt;?php</span><span class=\"crayon-h\"> </span><span class=\"crayon-k \">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">esc_attr</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$request_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-ta\">?&gt;</span>\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-44\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">input </span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"hidden\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"redirect_to\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"<span class=\"crayon-ta\">&lt;?php</span><span class=\"crayon-h\"> </span><span class=\"crayon-k \">echo</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">esc_attr</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$redirect_to</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-ta\">?&gt;</span>\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-45\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-46\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-ta\">&lt;?php</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">$remember_me</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-ta\">?&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-47\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-e\">input </span><span class=\"crayon-v\">type</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"hidden\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"rememberme\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">value</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"forever\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-48\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-ta\">&lt;?php</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">endif</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-ta\">?&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-49\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">p</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-50\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">form</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-51\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-52\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-sy\">?</span><span class=\"crayon-e\">php</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-53\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-54\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">login_footer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'two_factor_auth_nexmo_pin_code'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-55\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-56\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">exit</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2ca8858170001-57\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2ca8858170001-58\">&nbsp;</div></div></td></tr></tbody></table>\n\n**NB**: I have my HTML in the Class method here, but you can always put yours in a separate file and include it.\n\nWith the above code, you should have a page that looks like this when you try to log in to an account enabled for 2FA.\n\n[![wordpress pin](https://www.nexmo.com/wp-content/uploads/2019/10/wordpress-pin.png)](https://www.nexmo.com/wp-content/uploads/2019/10/wordpress-pin.png)\n\nThe `login_header` function adds that small section above the form that shows the last 5 digits of the user’s mobile number.\n\nThe `<form>` in this view is a replica of the WordPress login form with just a couple changes. If you inspect your WordPress login form via your browser, you’ll notice the username input field has a name attribute called “**log**.” Keep that because that’s how WordPress gets the username variable; however, in this case, you’ll pass the username from your user object. For keeping the experience of redirects and remember me preference from the initial login session, keep those variables in their respective input field names, but this time, they’ll be hidden. Lastly, pass the request ID from the Send Verification request call in a hidden input field as well as the value for the code the user enters—all of these would be used for validating the code.\n\nThe form’s parameters are:\n\n*   `log`: Username of the user\n*   `two_factor_auth_nexmo_pin_code`: Code the user enters\n*   `two_factor_auth_nexmo_request_id`: Request ID from the initial request\n*   `rememberme`: Remember me status from the initial login\n*   `redirect_to`: Redirect to URL if the user was trying to access a particular page before the login form\n\n**Important note:** The form’s action URL is still the WordPress login URL route  \n`<?php echo esc_url( site_url( 'wp-login.php', 'login_post' ) ) ?>`, What’s interesting is, because our intercept function is hooked to the authenticate action, when you click the verify button on the verify code form, your intercept function still runs, and that’s where you add the code snippet to validate the code the user entered.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public function intercept_login_with_two_factor_auth( $user, $username, $password ) { $errors = array(); $redirect_to = isset( $_POST['redirect_to'] ) ? $_POST['redirect_to'] : admin_url(); $remember_me = ( isset( $_POST['rememberme'] ) &amp;&amp; $_POST['rememberme'] === 'forever' ) ? true : false; $_user = get_user_by( 'login', $username ); // New addition $saved_request_id = ($_user) ? get_user_meta($_user-&gt;ID, 'two_factor_auth_nexmo_request_id', true ) : null; $nexmo_pin_code = isset( $_POST['two_factor_auth_nexmo_pin_code'] ) ? $_POST['two_factor_auth_nexmo_pin_code'] : false; $nexmo_request_id = isset( $_POST['two_factor_auth_nexmo_request_id'] ) ? $_POST['two_factor_auth_nexmo_request_id'] : false; if ( $nexmo_request_id &amp;&amp; $nexmo_pin_code &amp;&amp; $saved_request_id == $nexmo_request_id ) { $verification = new \\Nexmo\\Verify\\Verification($nexmo_request_id); try { $result = $this-&gt;nexmo_client-&gt;verify()-&gt;check($verification, $nexmo_pin_code); $response = $result-&gt;getResponseData(); if ($response['status'] == \"0\") { wp_set_auth_cookie( $_user-&gt;ID, $remember_me ); wp_safe_redirect( $redirect_to ); exit; } } catch(Exception $e) { // handle invalid code if ($e-&gt;getCode() == 16){ $errors = array( \"Invalid PIN code\" ); } $this-&gt;verify_user( $_user, $redirect_to, $remember_me,$errors ); } } // End of addition if ( $_user ) { $this-&gt;verify_user( $_user, $redirect_to, $remember_me ); } return $user; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2caa964060757-39\">39</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">intercept_login_with_two_factor_auth</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">username</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">password</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">errors</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">redirect_to</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">isset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'redirect_to'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'redirect_to'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">admin_url</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remember_me</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">isset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'rememberme'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'rememberme'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">===</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'forever'</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-5\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_user</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_user_by</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'login'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">username</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-7\"><span class=\"crayon-c\">// New addition</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">saved_request_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_user</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">get_user_meta</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_user</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ID</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'two_factor_auth_nexmo_request_id'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">null</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nexmo_pin_code</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">isset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'two_factor_auth_nexmo_pin_code'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'two_factor_auth_nexmo_pin_code'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nexmo_request_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">isset</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'two_factor_auth_nexmo_request_id'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">?</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_POST</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'two_factor_auth_nexmo_request_id'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">false</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-11\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nexmo_request_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nexmo_pin_code</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&amp;&amp;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">saved_request_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nexmo_request</span><span class=\"crayon-sy\">_</span>id<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-13\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">verification</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Nexmo</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-v\">Verify</span><span class=\"crayon-sy\">\\</span><span class=\"crayon-e\">Verification</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nexmo_request_id</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">nexmo_client</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">verify</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">check</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">verification</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">nexmo_pin_code</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">result</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getResponseData</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">'status'</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"0\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">wp_set_auth_cookie</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_user</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ID</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remember</span><span class=\"crayon-sy\">_</span>me<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">wp_safe_redirect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">redirect</span><span class=\"crayon-sy\">_</span>to<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">exit</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Exception</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// handle invalid&nbsp;&nbsp;code</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">e</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getCode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">16</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">errors</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">array</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Invalid PIN code\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">verify_user</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">redirect_to</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remember_me</span><span class=\"crayon-sy\">,</span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">errors</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-32\"><span class=\"crayon-c\">// End of addition</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-i\">_user</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">$</span><span class=\"crayon-r\">this</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">verify_user</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_user</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">redirect_to</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remember</span><span class=\"crayon-sy\">_</span>me<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-36\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">user</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2caa964060757-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2caa964060757-39\">&nbsp;</div></div></td></tr></tbody></table>\n\nIn the above addition, you are checking the POST data of the login request to see if the `'two_factor_auth_nexmo_pin_code'` and `'two_factor_auth_nexmo_request_id'` keys are set. If they are, it is a request to validate a code. To ensure you’re validating the code for the right user, you also compare the request ID from the POST data with the request ID saved on the user’s profile; if they match, then you call the [Check Verification](https://developer.nexmo.com/verify/code-snippets/check-verify-request) function to verify the code entered is correct. If it’s correct, you set the WordPress authentication cookie for the user and redirect them to the dashboard.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">wp_set_auth_cookie( $_user-&gt;ID, $remember_me ); wp_safe_redirect( $redirect_to );</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2cac220891872-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1ff2cac220891872-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1ff2cac220891872-3\">3</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2cac220891872-1\"><span class=\"crayon-e\">wp_set_auth_cookie</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">_user</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-v\">ID</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">remember</span><span class=\"crayon-sy\">_</span>me<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1ff2cac220891872-2\"><span class=\"crayon-e\">wp_safe_redirect</span><span class=\"crayon-sy\">(</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">redirect</span><span class=\"crayon-sy\">_</span>to<span class=\"crayon-h\"> </span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1ff2cac220891872-3\">&nbsp;</div></div></td></tr></tbody></table>\n\nIf it’s not, you simply call the `verify_user` function again and send a new verification code.\n\nHere’s a [link](https://github.com/Kendysond/two-factor-auth-nexmo/blob/master/public/class-two-factor-auth-nexmo-public.php) to the full Class file.\n\n## Conclusion\n\nIn this tutorial, you learned the basics of building a WordPress plugin, integrating the Nexmo PHP Library, and using the Nexmo Verify API. I hope you found this very helpful; you can check out the full code on GitHub via this [link](https://github.com/Kendysond/two-factor-auth-nexmo). Thanks for reading!"}