{"_filedata":{"slug":"how-permissions-work-in-aws-lambda-dr"},"title":"How Permissions Work in AWS Lambda","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2020/03/E_AWS-permissions_1200x600.png","author":340,"published":true,"published_at":"2020-03-25T13:03:43","tags":[499,416,161],"body":"When working with AWS Lambda, many users struggle with permissions using other AWS services. More specifically, how to access services like S3, RDS, Transcribe, or others.\n\nMany create a new [IAM user](https://aws.amazon.com/iam/), and set `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` in [environment variables](https://docs.aws.amazon.com/sdk-for-php/v3/developer-guide/guide_credentials_environment.html). The AWS SDK “automagically” uses those keys or values from an [AWS Credentials File](https://docs.aws.amazon.com/sdk-for-php/v3/developer-guide/guide_credentials_profiles.html). (See the [documentation](https://docs.aws.amazon.com/sdk-for-php/v3/developer-guide/getting-started_basic-usage.html#creating-a-client) on how the SDK uses those values.) However, adding those credentials for a Lambda would be a mistake.\n\n## Mistaken Identity\n\nAttempting the following `.env` file prevents an application from accessing AWS services from within Lambda. Connection failure is regardless of how you configured the IAM user.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">AWS_ACCESS_KEY_ID={{YOUR-ACCESS-KEY-HERE}} AWS_SECRET_ACCESS_KEY={{YOUR-SECRET-HERE}}</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1809198477610555-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1809198477610555-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1809198477610555-3\">3</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1809198477610555-1\"><span class=\"crayon-v\">AWS_ACCESS_KEY_ID</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">YOUR</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">ACCESS</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">KEY</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">HERE</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1809198477610555-2\"><span class=\"crayon-v\">AWS_SECRET_ACCESS_KEY</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">{</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">YOUR</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">SECRET</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">HERE</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1809198477610555-3\">&nbsp;</div></div></td></tr></tbody></table>\n\nAs the Lambda function deploys, the environment variables shown above get generated by Lambda. Meaning, the values of the file `.env` do not get set as expected.\n\nTo read more about deploying with Serverless, check out [AWS Lambda With PHP Using Bref and Serverless Framework](https://www.nexmo.com/blog/2020/03/16/aws-lambda-with-php-using-bref-and-serverless-framework-dr) or [Serverless Python with AWS Lambda](https://www.nexmo.com/blog/2020/03/20/serverless-python-with-aws-lambda-dr).\n\n## Setting Permissions\n\nWith environment variables `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY` set by Lambda, the role permissions also need set during deployment. All AWS services also get handled directly in the Lambda function instead of an IAM user.\n\nBelow is a partial yaml example using the Serverless framework to deploy an AWS Lambda function.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">provider: name: aws region: us-east-1 runtime: provided iamRoleStatements: - Effect: Allow Action: - s3:PutObject - s3:GetObject - s3:DeleteObject Resource: 'arn:aws:s3:::bucket-name/*' - Effect: Allow Action: transcribe:* Resource: '*'</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180919c953035591-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180919c953035591-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180919c953035591-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180919c953035591-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180919c953035591-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180919c953035591-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180919c953035591-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180919c953035591-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180919c953035591-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180919c953035591-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180919c953035591-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180919c953035591-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180919c953035591-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180919c953035591-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180919c953035591-15\">15</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc180919c953035591-1\"><span class=\"crayon-v\">provider</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180919c953035591-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">aws</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180919c953035591-3\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">region</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">us</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">east</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180919c953035591-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">runtime</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">provided</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180919c953035591-5\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">iamRoleStatements</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180919c953035591-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Effect</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Allow</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180919c953035591-7\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Action</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180919c953035591-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s3</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">PutObject</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180919c953035591-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s3</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">GetObject</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180919c953035591-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s3</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">DeleteObject</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180919c953035591-11\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Resource</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'arn:aws:s3:::bucket-name/*'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180919c953035591-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Effect</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Allow</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180919c953035591-13\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Action</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">transcribe</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">*</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180919c953035591-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Resource</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'*'</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180919c953035591-15\">&nbsp;</div></div></td></tr></tbody></table>\n\nNote the `iamRoleStatements` block in the example above. In it, the Lambda is granted `s3:PutObject`, `s3:GetObject`, and `s3:DeleteObject` permissions to the resource `bucket-name` and anything in it. Also, the function has access to `transcribe:*` services.\n\nThe example above is very similar to how IAM permissions get set in the examples below:\n\n![aws_iam_s3_policy](https://www.nexmo.com/wp-content/uploads/2020/03/aws_iam_s3_policy.png \"AWS IAM S3 Policy Example\")\n\n![amazon_iam_transcribe_policy](https://www.nexmo.com/wp-content/uploads/2020/03/amazon_iam_transcribe_policy.png \"AWS IAM Transcribe Policy Example\")\n\n## Examining Permissions\n\nUpon successful deployment to AWS Lambda, the active permissions of the function can be viewed in the AWS Console. Do this by navigating to the Permissions tab of the function console.\n\n![lambda_function_permissions](https://www.nexmo.com/wp-content/uploads/2020/03/lambda_function_permissions.png \"AWS Lambda Function Permissions\")\n\nFrom there, you can click into the permissions of each service for a more detailed breakdown of how you set them.\n\n## What Next\n\nDocumentation about possible permissions to various AWS services are available in the [AWS Identity and Access Management Documentation](https://docs.aws.amazon.com/IAM/latest/UserGuide/access_policies.html). Also, watch for future posts with examples of using these permissions in action."}