{"_filedata":{"slug":"deploying-an-aws-lambda-function-for-nexmo-voice-callbacks-with-php-dr"},"title":"Deploying an AWS Lambda Function for Vonage Voice Callbacks With PHP","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2020/03/E_Vonage-Voice-Callbacks_1200x600.png","author":340,"published":true,"published_at":"2020-04-02T12:12:27","tags":[499,416,161],"body":"Deploying a complete and web-accessible application to AWS Lambda presents a unique set of requirements and hurdles. Among these are execution and permissions settings. In this post, I’ll build upon a few previous posts, bringing them together as a practical example.\n\nThis post uses a sample callback application from [“AWS Transcribe with Nexmo Voice Using PHP”](https://www.nexmo.com/blog/2020/02/14/aws-transcribe-with-nexmo-voice-using-php-dr). It also leverages [“AWS Lambda with PHP Using Bref and Serverless Framework”](https://www.nexmo.com/blog/2020/03/16/aws-lambda-with-php-using-bref-and-serverless-framework-dr). I also apply the permissions model shown in [“How Permissions Work In AWS Lambda”](https://www.nexmo.com/blog/2020/03/25/how-permissions-work-in-aws-lambda-dr) for [AWS S3](https://aws.amazon.com/s3/) and [Amazon Transcribe](https://aws.amazon.com/transcribe/). Together these pieces allow you to create your own [AWS Lambda](https://aws.amazon.com/lambda/) function, creating a transcription microservice to be used in your applications.\n\nNote: You won’t need to go through the three posts mentioned above to follow along with this one. I thoroughly cover everything you need to know below.\n\n### Prerequisites\n\nIn this example the following are needed:\n\n*   PHP installed locally (version 7.3 preferred)\n*   [Composer installed globally](https://getcomposer.org/doc/00-intro.md#globally)\n*   A local clone of the [nexmo-community/voice-aws-speechtotext-php](https://github.com/nexmo-community/voice-aws-speechtotext-php) repo on Github\n*   [Nexmo account](https://dashboard.nexmo.com/sign-up?utm_source=DEV_REL&utm_medium=github&utm_campaign=https%3A%2F%2Fgithub.com%2Fnexmo-community%2Fvoice-aws-speechtotext-php)\n*   [Nexmo CLI tool](https://github.com/Nexmo/nexmo-cli)\n*   [AWS account](https://aws.amazon.com/)\n*   [Serverless Framework](https://serverless.com/framework/docs/getting-started/) installed globally. (more on this later)\n\n### AWS Setup\n\nYou’ll need an AWS account, as well as [IAM credentials](https://aws.amazon.com/iam/) associated with a user who has sufficient privileges. That permission ensures Serverless can create the Lambda function and assign permissions as needed.\n\n#### Create an S3 Bucket\n\nCreate an S3 Bucket to store the voice recording MP3 files retrieved from Nexmo. Amazon Transcribe can then easily access the files for transcription later.\n\nAfter creating it, make sure to check the box beside the bucket name. A panel opens from the right, so you can click the button “Copy Bucket ARN” and save it for later usage.\n\n#### Creating an IAM User\n\nSelect the IAM Management Console from the Services panel:\n\n![Select IAM Management Console](/wp-content/uploads/2020/02/select_iam_management.png \"Select IAM Management Console\")\n\nFrom the IAM Management Console, add a new IAM user by clicking the blue Add User button:\n\n![AWS new IAM user](/wp-content/uploads/2020/02/aws_new_iam_user.png \"Add a new IAM user\")\n\nBelow is a JSON snippet to assign the permissions needed for the new user.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">{ \"Version\": \"2012-10-17\", \"Statement\": [ { \"Sid\": \"VisualEditor0\", \"Effect\": \"Allow\", \"Action\": \"*\", \"Resource\": \"*\" } ] }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807516777251050-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807516777251050-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807516777251050-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807516777251050-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807516777251050-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807516777251050-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807516777251050-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807516777251050-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807516777251050-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807516777251050-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807516777251050-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807516777251050-12\">12</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1807516777251050-1\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807516777251050-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Version\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"2012-10-17\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1807516777251050-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Statement\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">[</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807516777251050-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1807516777251050-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Sid\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"VisualEditor0\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807516777251050-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Effect\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Allow\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1807516777251050-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Action\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"*\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807516777251050-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"Resource\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"*\"</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1807516777251050-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807516777251050-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1807516777251050-11\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807516777251050-12\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Serverless Framework\n\nThe [Bref](https://bref.sh/) tool leverages the [Serverless Framework](https://serverless.com) foundation, which is a “complete solution for building and operating serverless applications.” Thus, our first step is to get this framework installed on the development system you’re using. I recommend installing it globally, to allow usage from anywhere via CLI.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm install -g serverless</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751b412152451-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751b412152451-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc180751b412152451-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-v\">install</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">g</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">serverless</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751b412152451-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### AWS Credentials\n\nWith Serverless installed, ensure you’ve also set up the AWS credentials above as an admin, for Serverless to interact with the various AWS services. You can read more about this at [serverless.com](https://serverless.com/framework/docs/providers/aws/guide/credentials/#using-aws-access-keys) and [bref.sh](https://bref.sh/docs/installation/aws-keys.html) so that we won’t go into the details here.\n\n### Application Preparation\n\nNext, we prepare the application using Composer to retrieve dependencies. A small edit is required in the code to work correctly with the Lambda URLs.\n\n#### Composer\n\nPreparing the application takes a couple of steps before doing the Composer install. We need to require Bref to perform the Serverless functionalities. Type the following in your terminal after navigating to the project directory containing the code.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">composer install composer require bref/bref</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751d583813993-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751d583813993-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751d583813993-3\">3</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc180751d583813993-1\"><span class=\"crayon-e\">composer </span><span class=\"crayon-e\">install</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751d583813993-2\"><span class=\"crayon-e\">composer </span><span class=\"crayon-e\">require </span><span class=\"crayon-v\">bref</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">bref</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751d583813993-3\">&nbsp;</div></div></td></tr></tbody></table>\n\nThe first command installs the dependencies of the application. Then, the second command adds Bref along with dependencies needed for it. Alternatively, you could edit the `composer.json` file to require Bref and only run the `install` command.\n\n#### Bref Init\n\nTypically, for a new application, you would command Bref to `init`, and create `serverless.yml` and `index.php`. However, in this case, you should simply create a file named `serverless.yml` in the root directory as follows:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">service: app provider: name: aws region: us-east-1 runtime: provided iamRoleStatements: - Effect: Allow Action: - s3:PutObject - s3:GetObject - s3:DeleteObject Resource: 'arn:aws:s3:::{{bucket-name}}/*' - Effect: Allow Action: transcribe:* Resource: '*' plugins: - ./vendor/bref/bref functions: api: handler: index.php description: '' timeout: 28 # in seconds (API Gateway has a timeout of 29 seconds) layers: - ${bref:layer.php-73-fpm} events: - http: 'ANY /' - http: 'ANY /{proxy+}' # Exclude files from deployment package: exclude: - 'node_modules/**' - 'tests/**'</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751e344445846-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751e344445846-37\">37</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-1\"><span class=\"crayon-v\">service</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">app</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-3\"><span class=\"crayon-v\">provider</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">aws</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-5\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">region</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">us</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">east</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">runtime</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">provided</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-7\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">iamRoleStatements</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Effect</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Allow</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-9\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Action</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s3</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">PutObject</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s3</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">GetObject</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">s3</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">DeleteObject</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-13\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Resource</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'arn:aws:s3:::{{bucket-name}}/*'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Effect</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Allow</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-15\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Action</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">transcribe</span><span class=\"crayon-o\">:</span><span class=\"crayon-o\">*</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Resource</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'*'</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-17\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-18\"><span class=\"crayon-v\">plugins</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">vendor</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bref</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">bref</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-20\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-21\"><span class=\"crayon-v\">functions</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">api</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">handler</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">php</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-24\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">description</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">''</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">timeout</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">28</span><span class=\"crayon-h\"> </span><span class=\"crayon-p\"># in seconds (API Gateway has a timeout of 29 seconds)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">layers</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">bref</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">layer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">php</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">73</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">fpm</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-28\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">events</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\">&nbsp;&nbsp; </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'ANY /'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\">&nbsp;&nbsp; </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'ANY /{proxy+}'</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-31\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-32\"><span class=\"crayon-p\"># Exclude files from deployment</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-33\"><span class=\"crayon-t\">package</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">exclude</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'node_modules/**'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751e344445846-36\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'tests/**'</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751e344445846-37\">&nbsp;</div></div></td></tr></tbody></table>\n\nNote: You should update the AWS region and replace {{bucket-name}} to match your needs.\n\nAlso, notice that `iamRoleStatements` is setting permissions for the Lambda to use AWS S3 as well as Amazon Transcribe. See the post [“How Permissions Work in AWS Lambda”](https://www.nexmo.com/blog/2020/03/25/how-permissions-work-in-aws-lambda-dr), mentioned above, for more details.\n\n#### Environment Variables\n\nAs a part of the preparation, rename the `.env.default` file to become `.env`, and update as needed to suit your AWS and Nexmo account information. Though you can safely ignore `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`, because those are automatically added to the environment by Lambda.\n\nYou will also not be able to populate the `NEXMO_APPLICATION_PRIVATE_KEY_PATH` and `NEXMO_APPLICATION_ID` values until AFTER you deploy to Lambda, causing the need to deploy to Lambda twice. The first time to provide you with the URLs needed to create the Nexmo Application. Then, the second deployment contains an updated `.env` file with the Nexmo values. That’s all covered later.\n\n#### Event URLs\n\nBecause of the difference in how Lambda handles the URI, you will also need to edit the `index.php` file in the application. Specifically, you will need to alter the `eventUrl` on lines 33 and 47. The end result will look like the following, respectively:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">// Line 33 'https://'.$uri-&gt;getHost().'/dev/webhooks/fetch' // Line 47 'https://'.$uri-&gt;getHost().'/dev/webhooks/transcribe'</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751f393198243-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751f393198243-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751f393198243-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc180751f393198243-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc180751f393198243-5\">5</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc180751f393198243-1\"><span class=\"crayon-c\">// Line 33</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751f393198243-2\"><span class=\"crayon-s\">'https://'</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">uri</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getHost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-s\">'/dev/webhooks/fetch'</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751f393198243-3\"><span class=\"crayon-c\">// Line 47</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc180751f393198243-4\"><span class=\"crayon-s\">'https://'</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">$</span><span class=\"crayon-v\">uri</span><span class=\"crayon-o\">-&gt;</span><span class=\"crayon-e\">getHost</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-s\">'/dev/webhooks/transcribe'</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc180751f393198243-5\">&nbsp;</div></div></td></tr></tbody></table>\n\nThe update is caused by the `$request` not showing with `https`, and Lambda also includes the environment in the API Gateway URLs.\n\n### Deploying\n\nWill all the steps above completed, you are now ready to deploy the application to Lambda using Serverless. In your terminal, issue the following command:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">serverless deploy</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807522627110887-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807522627110887-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1807522627110887-1\"><span class=\"crayon-e\">serverless </span><span class=\"crayon-i\">deploy</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807522627110887-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nAfter deployment, you receive the URL needed to access the application via the API Gateway. Make a note of the URL for the next step.\n\n**IMPORTANT:** The example application, as-is, does not carry any authentication or verification. Anyone with access to the URL provided after deployment can access it. Doing so could cause unexpected charges to your accounts. Therefore, please secure the app if you intend to leave it active.\n\n### Nexmo Setup\n\nUnfortunately, in the case of deploying AWS Lambda applications, you did not know the URL until after deployment. However, you still need to create the Application at Nexmo to gain the `NEXMO_APPLICATION_PRIVATE_KEY_PATH` and `NEXMO_APPLICATION_ID` for the application to function.\n\nUsing the Nexmo CLI, installed as a prerequisite, enter the following command:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">nexmo app:create &lt;name&gt; &lt;answer_url&gt;/webhooks/answer &lt;event_url&gt;/webhooks/event</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807523682352263-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807523682352263-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1807523682352263-1\"><span class=\"crayon-e\">nexmo </span><span class=\"crayon-v\">app</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">create</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">answer_url</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">webhooks</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">answer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">event_url</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">webhooks</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">event</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807523682352263-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nAs an example, the command might look like this:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">nexmo app:create MyTranscripeApp https://asdrferwef.execute-api.us-east-1.amazonaws.com/dev/webhooks/answer https://asdrferwef.execute-api.us-east-1.amazonaws.com/dev/webhooks/event</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807524097240793-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807524097240793-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1807524097240793-1\"><span class=\"crayon-e\">nexmo </span><span class=\"crayon-v\">app</span><span class=\"crayon-o\">:</span><span class=\"crayon-e\">create </span><span class=\"crayon-e\">MyTranscripeApp </span><span class=\"crayon-v\">https</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//asdrferwef.execute-api.us-east-1.amazonaws.com/dev/webhooks/answer https://asdrferwef.execute-api.us-east-1.amazonaws.com/dev/webhooks/event</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807524097240793-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nThe response from the command provides the `Application ID` and the `Private Key`, to be used in the following steps.\n\n#### Update Private Key\n\nRename the file `private.key.default` to `private.key` and save the `Private Key` into the file.\n\n#### Update .env\n\nUpdate the `.env` file with the values for `NEXMO_APPLICATION_PRIVATE_KEY_PATH` and `NEXMO_APPLICATION_ID`. It will look something like this:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">NEXMO_APPLICATION_PRIVATE_KEY_PATH=./private.key NEXMO_APPLICATION_ID=2735sd6ed1asd-29cf4-4858f-bd90sd-7135a8cf122bas</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807526661621002-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807526661621002-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807526661621002-3\">3</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1807526661621002-1\"><span class=\"crayon-v\">NEXMO_APPLICATION_PRIVATE_KEY_PATH</span><span class=\"crayon-o\">=</span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-m\">private</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">key</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807526661621002-2\"><span class=\"crayon-v\">NEXMO_APPLICATION_ID</span><span class=\"crayon-o\">=</span><span class=\"crayon-cn\">2735sd6ed1asd</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">29cf4</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">4858f</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">bd90sd</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">7135a8cf122bas</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1807526661621002-3\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Number Association\n\nThe last step to prepare Nexmo is to associate the rented Nexmo number with the newly created application. Use the following command for this:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">nexmo link:app &lt;number&gt; &lt;app_id&gt;</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807527744649268-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807527744649268-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1807527744649268-1\"><span class=\"crayon-e\">nexmo </span><span class=\"crayon-v\">link</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">app</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">number</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">app_id</span><span class=\"crayon-o\">&gt;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807527744649268-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nMake sure to update the variables above with your Nexmo number and the `app_id` given with the Application creation. Ensure you prepend the country code, to prevent failure. Here is an example:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">nexmo link:app +15558675309 2735sd6ed1asd-29cf4-4858f-bd90sd-7135a8cf122bas</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807528119771207-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807528119771207-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1807528119771207-1\"><span class=\"crayon-e\">nexmo </span><span class=\"crayon-v\">link</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">app</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-cn\">15558675309</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">2735sd6ed1asd</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">29cf4</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">4858f</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">bd90sd</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">7135a8cf122bas</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807528119771207-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### More Details\n\nCreating the Nexmo application, and associating the number, instructs Nexmo to make callbacks when events happen, and you want those callbacks to point to the newly created app.\n\nThe Event URL is for when an event changes the status of a call, while the Answer URL is requested for any inbound calls to retrieve an NCCO object ([Nexmo Call Control Object](https://developer.nexmo.com/voice/voice-api/ncco-reference)).\n\nNow we are finished with the Nexmo setup. Time to redeploy to Lambda with the following command:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">serverless deploy</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1807529851248381-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1807529851248381-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1807529851248381-1\"><span class=\"crayon-e\">serverless </span><span class=\"crayon-i\">deploy</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1807529851248381-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nAfter a couple of minutes, the updated application will be redeployed to Lambda. Though the contents of the application will have changed, the URL remains constant.\n\n### Testing\n\nNow it is time to make a test call to your Nexmo number. After calling, the automated voice should say, “Please leave a message after the tone, then press #”. unless you changed that message in `index.php`. Then, after you leave a short voice message and hit `#`, the automated voice should say, “Thank you for your message. Goodbye.”\n\nTo confirm everything worked as expected, you should be able to see the MP3 file in the S3 bucket you specified. There should also be a transcription job running at Amazon Transcribe. All of that is accessible through the AWS Console.\n\nCongrats! You’ve built your first Lambda!\n\n### Next Steps\n\nThere are many possible next steps, depending on your needs. One possible solution may be to create an AWS Cloudwatch event to be alerted when a Transcribe job is “Complete”. The event could call another Lambda function to email the transcription, or add the transcription to a database. Bottom line is, you now have a text version of the voice message left by a caller. If you have any questions, or run into troubles, you can reach out to [@VonageDev](https://twitter.com/vonagedev) on Twitter or inquire in the [Vonage Developer Community](http://nexmo-community.slack.com) Slack team.\n\nGood luck."}