{"_filedata":{"slug":"aws-lambda-with-php-using-bref-and-serverless-framework-dr"},"title":"AWS Lambda With PHP Using Bref And Serverless Framework","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2020/03/E_AWS-Lambda_1200x600.png","author":340,"published":true,"published_at":"2020-03-16T13:12:07","tags":[499,416,1687,161,1686,200,1216],"body":"Using PHP in serverless environments has previously been challenging due to the lack of default runtimes provided by the various cloud providers. However, this has changed recently with added libraries and functionality, making the use of PHP more approachable.\n\nThis example will create an [AWS Lambda](https://aws.amazon.com/lambda/) Function for PHP using [Bref](https://bref.sh/). The addition of [AWS Lambda Runtime API](https://docs.aws.amazon.com/lambda/latest/dg/runtimes-api.html) and the ability to add [AWS Lambda Layers](https://docs.aws.amazon.com/lambda/latest/dg/configuration-layers.html) has made it easier to create a PHP custom runtime. Therefore, packages like Bref have sprung up to make PHP developers’ lives easier.\n\n## Prerequisites\n\nHere are things you will need for this example:\n\n*   PHP installed locally (version 7.3+ preferred)\n*   [Composer installed globally](https://getcomposer.org/doc/00-intro.md#globally)\n*   [Node.js](https://nodejs.org/en/)\n*   [AWS account](https://aws.amazon.com/) and [access keys](https://docs.aws.amazon.com/IAM/latest/UserGuide/introduction.html) for a user with access to [AWS S3](https://docs.aws.amazon.com/s3/) as well as [AWS Lambda](https://docs.aws.amazon.com/lambda/latest/dg/welcome.html)\n\n## Serverless Framework\n\nThe [Bref](https://bref.sh/) tool leverages the [Serverless Framework](https://serverless.com) foundation, which is a “complete solution for building and operating serverless applications”. Thus, our first step is to get this framework installed on the development system you’re using. We recommend installing it globally, to allow usage from anywhere via CLI.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">npm install -g serverless</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73161295392512-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73161295392512-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73161295392512-1\"><span class=\"crayon-e\">npm </span><span class=\"crayon-v\">install</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">g</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">serverless</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73161295392512-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n### AWS Credentials\n\nWith Serverless installed, ensure you’ve also set up the AWS credentials needed for Serverless to interact with the various AWS services. (S3, Lambda, and potentially EC2 or databases as required) In this example, we will only be using S3 and Lambda. You can read more about this at [serverless.com](https://serverless.com/framework/docs/providers/aws/guide/credentials/#using-aws-access-keys) and [bref.sh](https://bref.sh/docs/installation/aws-keys.html) so that we won’t go into the details here.\n\n## Install Bref\n\nYou should also install Bref as a dependency within each given project using it. With that in mind, we will use Composer to install it using the CLI from within the project directory.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">composer require bref/bref</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73164146113961-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73164146113961-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73164146113961-1\"><span class=\"crayon-e\">composer </span><span class=\"crayon-e\">require </span><span class=\"crayon-v\">bref</span><span class=\"crayon-o\">/</span><span class=\"crayon-i\">bref</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73164146113961-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Init Bref Project\n\nAfter Composer has finalized the addition of Bref to the project, the best way to get started is to `init` Bref for usage. Doing the `init` will then prompt whether you desire a Function, HTTP, or Console function, resulting in the creation of `serverless.yml` and possibly `index.php` depending upon your selection, which you can edit to fit the needs of the application.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">vendor/bin/bref init</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73165768716358-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73165768716358-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73165768716358-1\"><span class=\"crayon-v\">vendor</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bin</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">bref </span><span class=\"crayon-i\">init</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73165768716358-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Example YML File\n\nAs an example, below is a sample `serverless.yml` file:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">service: app provider: name: aws region: us-east-1 runtime: provided plugins: - ./vendor/bref/bref functions: function: handler: index.php description: '' layers: - ${bref:layer.php-73} # Exclude files from deployment package: exclude: - 'tests/**'</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73166657855424-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73166657855424-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73166657855424-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73166657855424-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73166657855424-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73166657855424-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73166657855424-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73166657855424-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73166657855424-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73166657855424-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73166657855424-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73166657855424-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73166657855424-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73166657855424-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73166657855424-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73166657855424-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73166657855424-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73166657855424-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73166657855424-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73166657855424-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73166657855424-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73166657855424-22\">22</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73166657855424-1\"><span class=\"crayon-v\">service</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">app</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73166657855424-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73166657855424-3\"><span class=\"crayon-v\">provider</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73166657855424-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">name</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">aws</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73166657855424-5\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">region</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">us</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">east</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73166657855424-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">runtime</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">provided</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73166657855424-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73166657855424-8\"><span class=\"crayon-v\">plugins</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73166657855424-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">vendor</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">bref</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">bref</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73166657855424-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73166657855424-11\"><span class=\"crayon-v\">functions</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73166657855424-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">function</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73166657855424-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">handler</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">index</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">php</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73166657855424-14\"><span class=\"crayon-e\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">description</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">''</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73166657855424-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">layers</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73166657855424-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-sy\">{</span><span class=\"crayon-v\">bref</span><span class=\"crayon-o\">:</span><span class=\"crayon-v\">layer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">php</span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">73</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73166657855424-17\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73166657855424-18\"><span class=\"crayon-p\"># Exclude files from deployment</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73166657855424-19\"><span class=\"crayon-t\">package</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73166657855424-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">exclude</span><span class=\"crayon-o\">:</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73166657855424-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'tests/**'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73166657855424-22\">&nbsp;</div></div></td></tr></tbody></table>\n\nIn the file, observe the name of the service, which you can alter to fit the desired naming conventions of your functions. By default, it is named `app`.\n\nFollowing this, we can see the provider information for AWS Lambda.\n\nThere is a section for any plugins and the inclusion of Bref.\n\nThen, there is the section outlining the details of the function. Included is the handler, desired description to be added to AWS, and any layers required, such as PHP. Note in the example above, `php-73` is specified. If you selected HTTP instead, it would specify `php-73-fpm` and provide a web server in the layer instead of a CLI only version of PHP. The image to be used is why the `init` process is essential to ensure Lambda creates the correct layer.\n\n## Deploying to AWS Lambda\n\nFor either Function or HTTP use cases, the default `init` provides enough of a skeleton to deploy straight to AWS Lambda and test using Serverless. Leveraging the AWS credentials configuration added prior, Serverless will deploy straight to Lambda using the contents of `serverless.yml` as criteria.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">serverless deploy</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73168443261355-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73168443261355-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73168443261355-1\"><span class=\"crayon-e\">serverless </span><span class=\"crayon-i\">deploy</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73168443261355-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n**IMPORTANT:** The example application, as-is, does not carry any authentication or verification. Anyone with access to the URL provided after deployment can access it. Doing so could cause unexpected charges to your accounts. Therefore, please secure the app if you intend to leave it active.\n\n## Testing the Function\n\nIn the case of a function, there are two ways to test. One way is to use the AWS Console, while the second is using Serverless via CLI from the system used to deploy.\n\n### AWS Console\n\nBy navigating the AWS Console select the Lambda item from the list of Compute services.\n\n![aws_console_compute_lambda](https://www.nexmo.com/wp-content/uploads/2020/02/aws_console_compute_lambda.png \"AWS Console-Lambda Dashboard\")\n\nOn the Lambda dashboard, you can select the function created and create a new test by clicking `Configure test events`. Alternatively, you can click the `Test` button to receive the same prompt.\n\n![lambda_function_create_test](https://www.nexmo.com/wp-content/uploads/2020/02/lambda_function_create_test.png \"Lambda Create Test\")\n\nFor a test of the skeleton created, add a name and slightly alter the JSON in the body.\n\n![configure_test_events](https://www.nexmo.com/wp-content/uploads/2020/02/configure_test_events.png \"Configure Test Events\")\n\nUpon clicking the `Create` button at the bottom of the dialog, you can then click the `Test` button to execute the test. Running should result in a green dialog area you can expand to show the results.\n\n![lambda_test_results](https://www.nexmo.com/wp-content/uploads/2020/02/lambda_test_results.png \"Lambda Test Results\")\n\n### Serverless Function Execution\n\nAs stated above, you can also use the Serverless CLI to also test the function by using the following command from within the local application root:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">serverless invoke -f function --data='{\"name\": \"Adam\"}'</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1a73169960026243-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1a73169960026243-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1a73169960026243-1\"><span class=\"crayon-e\">serverless </span><span class=\"crayon-v\">invoke</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-i\">f</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">function</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">data</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">'{\"name\": \"Adam\"}'</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1a73169960026243-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nExample result:\n\n![serverless_lambda_function_execution](https://www.nexmo.com/wp-content/uploads/2020/02/serverless_lambda_function_execution.png \"Serverless Lambda Function Execution\")\n\n### Testing An HTTP Function\n\nIf you deployed an HTTP function instead, the two testing methods above would not work. Instead, you can use an HTTP client or a standard browser to test by using the URL provided by the deploy output results.\n\n## What Next\n\nWith an AWS Lambda function created, you can continue adding more code and creating more robust PHP apps leveraging the serverless technologies available today. Watch for future posts showing how to build useful functions to leverage Vonage APIs and services using AWS Lambda."}