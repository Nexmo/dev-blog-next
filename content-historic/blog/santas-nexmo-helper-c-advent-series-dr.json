{"_filedata":{"slug":"santas-nexmo-helper-c-advent-series-dr"},"title":"Santa&#8217;s Nexmo Helper &#8211; C# Advent Series","description":"","thumbnail":"https://www.nexmo.com/wp-content/uploads/2019/12/E_Santas-Helper_1200x600.jpg","author":349,"published":true,"published_at":"2019-12-19T09:01:01","tags":[385,706,517,1529,736,1657,718,1237,1656],"body":"‘Tis the season of Advent, such a busy time for so many, but none more than Ol’ St. Nick, whose feast day the Eastern Rite celebrates today. In honor of the season of [C# Advent](https://crosscuttingconcerns.com/The-Third-Annual-csharp-Advent) that’s upon us, we’re going to help Santa out by automating some of his correspondence and providing him more modern means of fielding questions than the postal service.\n\nTo crystallize our goal here, we are going to create an FAQ bot for Santa that can be reached over, and respond via, Facebook Messenger, WhatsApp, and SMS.\n\nWe’re going to build this with the help of [QnAMaker](https://www.qnamaker.ai/) and of course the [Nexmo Messages API](https://developer.nexmo.com/messages/overview)\n\n## Prerequisites\n\n*   Visual Studio 2019 version 16.3 or higher\n*   A Nexmo account. If you don’t have one, you can [sign up here](https://dashboard.nexmo.com/sign-up)\n*   An Azure Account\n*   Optional: [Ngrok](https://ngrok.com/) for test deployment\n*   Optional: For Facebook Messenger, we will need to link a Facebook Page to our Nexmo account—you can see step by step instructions on [Nexmo Developer](https://developer.nexmo.com/use-cases/sending-facebook-messenger-messages-with-messages-api). Completing [part 2](https://developer.nexmo.com/use-cases/sending-facebook-messenger-messages-with-messages-api#part-2-link-your-facebook-page-to-your-nexmo-application) of the guide will create a Nexmo App with a linked Facebook Page; be sure to save the private key file that is generated for this application.\n\n> Note: The code in this demo will work with WhatsApp Messages once WhatsApp Business is configured. That said, WhatsApp is more meant for a business case—to see more details about getting an app configured for WhatsApp you can look at the guide on [Nexmo Developer](https://developer.nexmo.com/use-cases/sending-whatsapp-messages-with-messages-api)\n\n## Building Our Bot\n\n### Setup\n\nTo build out our bot we are going to head over to [QnAMaker](https://www.qnamaker.ai/) and sign in using an Azure account.\n\nClick “Create a Knowledge Base”.\n\nFollow the instructions in step 1 for creating a QnA service in Azure.\n\nFor Step 2, set the following:\n\n*   Microsoft Azure Directory ID\n*   The Subscription’s name from the Azure account\n*   The QnA service we’re going to use (this will match the Service Name we just created in the Azure Portal)\n*   The language of our bot\n\n![Build QnAMaker gif](https://www.nexmo.com/wp-content/uploads/2019/12/qnamakerDemo.gif)\n\nFor Step 3 we’re going to name our knowledge base “Santa’s Nexmo Helper.”\n\nStep 4 is where QnA Maker gets cool—populating this bot’s knowledge base is as easy as linking it to an FAQ page or uploading an FAQ file. Of course for this demo, we’re going to use the official Santa Claus website’s [FAQ page](http://www.santaclaus.com/2014/11/santas-faq-page-frequently-ask-questions-about-santa-claus/).\n\nWe’re also going to add some chitchat to our bot—since our bot is going to be an honorary elf, we’re going to use the witty chitchat selection\n\nWith all this set, click Create Knowledge Base.\n\nThis will ingest the FAQ’s that we pointed QnA Maker at and will bring us to a page that looks like this:\n\n![QnA Maker Knowledgebase edit screen](https://www.nexmo.com/wp-content/uploads/2019/12/QnAMaker_Kb_edit_screen.png)\n\n### Editing, Publishing, and Testing Our Knowledgebase\n\nThis is our Knowledgebase edit screen. From here we can see what our knowledge base looks like. We can also freely edit it if we want to change some answers; e.g. maybe let’s shorten the “Who Is Santa Claus?” answer.\n\nAfter editing the Knowledge Base sufficiently, clicking `Save and Train` will save and train the Bot.\n\nTo test, click the `Test` button in the upper right-hand corner. This will open the testing dialog, you can send id a question e.g. `how do reindeer fly?` and the bot will respond!\n\n![Test Question](https://www.nexmo.com/wp-content/uploads/2019/12/TestQuestion.png)\n\nIt’s even possible to inspect how the bot made its determination. Click the inspect link and the inspection dialog will pop out. This will show the bot’s confidence in its answer and some alternatives it came up with.\n\n![Inspect Drill down](https://www.nexmo.com/wp-content/uploads/2019/12/inspect_drill_down.png)\n\nWhen the bot’s ready to go, click publish on the top of the page, then click publish inside the dialog that shows up. When this completes there will be a screen that pops up with some helpful request structures that can be used to generate an answer from the bot. It’ll look something like:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">POST /knowledgebases/YOUR_KNOWLEDGE_BASE_ID/generateAnswer Host: https://nexmofaqbot.azurewebsites.net/qnamaker Authorization: EndpointKey YOUR_KNOWLEDGE_BASE_ENDPOINT_KEY Content-Type: application/json {\"question\":\"YOUR_QUESTION\"}</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058f7313528368-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058f7313528368-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058f7313528368-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058f7313528368-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058f7313528368-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058f7313528368-6\">6</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058f7313528368-1\"><span class=\"crayon-v\">POST</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">knowledgebases</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">YOUR_KNOWLEDGE_BASE_ID</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">generateAnswer</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058f7313528368-2\"><span class=\"crayon-v\">Host</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">https</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//nexmofaqbot.azurewebsites.net/qnamaker</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058f7313528368-3\"><span class=\"crayon-v\">Authorization</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">EndpointKey </span><span class=\"crayon-e\">YOUR_KNOWLEDGE_BASE_ENDPOINT_KEY</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058f7313528368-4\"><span class=\"crayon-v\">Content</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">Type</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">application</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">json</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058f7313528368-5\"><span class=\"crayon-sy\">{</span><span class=\"crayon-s\">\"question\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-s\">\"YOUR_QUESTION\"</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058f7313528368-6\">&nbsp;</div></div></td></tr></tbody></table>\n\nSave this string—it’s going to be used to create the WebService that will drive our bot over the Messages API.\n\n## Building Our App\n\nStart by opening Visual Studio and selecting “Create a New Project.” In the dialog that opens, select an ASP.NET Core Web Application. Name it something like “QnAMakerMessagesDemo.” Select ASP.NET Core 3.0, “Web Application (Model-View-Control)” as the type and click create.\n\n### Install NuGet Packages\n\nIn Visual Studio go to Tools -> NuGet Package Manager -> Manage NuGet Packages for Solution.\n\nInstall the following NuGet packages:\n\n*   Newtonsoft.Json\n*   Nexmo.Csharp.Client\n*   BouncyCastle\n*   jose-jwt\n\n### Building Our Token Generator\n\nCreate a class called TokenGenerator and add the following code to it:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public static string GenerateToken(IConfiguration config) { // retrieve appID and privateKey from configuration var appId = config[\"Authentication:appId\"]; var priavteKeyPath = config[\"Authentication:privateKey\"]; string privateKey = \"\"; using (var reader = File.OpenText(priavteKeyPath)) // file containing RSA PKCS1 private key privateKey = reader.ReadToEnd(); //generate claims list const int SECONDS_EXPIRY = 3600; var t = DateTime.UtcNow - new DateTime(1970, 1, 1); var iat = new Claim(\"iat\", ((Int32)t.TotalSeconds).ToString(), ClaimValueTypes.Integer32); // Unix Timestamp for right now var application_id = new Claim(\"application_id\", appId); // Current app ID var exp = new Claim(\"exp\", ((Int32)(t.TotalSeconds + SECONDS_EXPIRY)).ToString(), ClaimValueTypes.Integer32); // Unix timestamp for when the token expires var jti = new Claim(\"jti\", Guid.NewGuid().ToString()); // Unique Token ID var claims = new List&lt;Claim&gt;() { iat, application_id, exp, jti }; //create rsa parameters RSAParameters rsaParams; using (var tr = new StringReader(privateKey)) { var pemReader = new PemReader(tr); var kp = pemReader.ReadObject(); var privateRsaParams = kp as RsaPrivateCrtKeyParameters; rsaParams = DotNetUtilities.ToRSAParameters(privateRsaParams); } //generate and return JWT using (RSACryptoServiceProvider rsa = new RSACryptoServiceProvider()) { rsa.ImportParameters(rsaParams); Dictionary&lt;string, object&gt; payload = claims.ToDictionary(k =&gt; k.Type, v =&gt; (object)v.Value); return Jose.JWT.Encode(payload, rsa, Jose.JwsAlgorithm.RS256); } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fb015934530-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fb015934530-37\">37</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">GenerateToken</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">// retrieve appID and privateKey from configuration</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">appId</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">\"Authentication:appId\"</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">priavteKeyPath</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">\"Authentication:privateKey\"</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">reader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">File</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">OpenText</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">priavteKeyPath</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// file containing RSA PKCS1 private key</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">reader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReadToEnd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-9\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">//generate claims list</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">int</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SECONDS_EXPIRY</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">3600</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">t</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DateTime</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">UtcNow</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DateTime</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">1970</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iat</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"iat\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Int32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">TotalSeconds</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClaimValueTypes</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Integer32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Unix Timestamp for right now</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">application_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"application_id\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">appId</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Current app ID</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">exp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"exp\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">Int32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">t</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">TotalSeconds</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SECONDS_EXPIRY</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ClaimValueTypes</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Integer32</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Unix timestamp for when the token expires</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jti</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Claim</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"jti\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Guid</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">NewGuid</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Unique Token ID</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">claims</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">List</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-v\">Claim</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">iat</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">application_id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">exp</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">jti</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-18\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">//create rsa parameters</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">RSAParameters </span><span class=\"crayon-v\">rsaParams</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">tr</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StringReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">privateKey</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pemReader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">PemReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">tr</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">kp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">pemReader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReadObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">privateRsaParams</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">kp </span><span class=\"crayon-st\">as</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">RsaPrivateCrtKeyParameters</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">rsaParams</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DotNetUtilities</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToRSAParameters</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">privateRsaParams</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-28\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">//generate and return JWT</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">RSACryptoServiceProvider </span><span class=\"crayon-v\">rsa</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RSACryptoServiceProvider</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">rsa</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ImportParameters</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">rsaParams</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Dictionary</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">object</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">payload</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">claims</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToDictionary</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">k</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">k</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Type</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">v</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">object</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">v</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Value</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Jose</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">JWT</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Encode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">payload</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">rsa</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Jose</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">JwsAlgorithm</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">RS256</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fb015934530-36\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fb015934530-37\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis will generate the JWT that’s needed to authenticate against the Messages App created as part of the prerequisites.\n\n### Add appId and the Private Key Path to the Configuration\n\nThe JWT generator calls on an appId and path to the private key saved earlier to be in the appsettings.json file.\n\nOpen this file and add the following to the configuration object:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">\"Authentication\": { \"appId\": \"NEXMO_APPLICATION_ID\", \"privateKey\": \"C:\\\\Path\\\\to\\\\Private\\\\key.key\" }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fd221824463-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fd221824463-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fd221824463-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fd221824463-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fd221824463-5\">5</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fd221824463-1\"><span class=\"crayon-s\">\"Authentication\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fd221824463-2\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"appId\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"NEXMO_APPLICATION_ID\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fd221824463-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-s\">\"privateKey\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"C:\\\\Path\\\\to\\\\Private\\\\key.key\"</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fd221824463-4\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fd221824463-5\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Build Data Structures to Receive and Send Data\n\nA couple of POCO’s are needed for this demo; they’re a tad verbose, and don’t do anything except define the messages objects per the [spec](https://developer.nexmo.com/api/messages-olympus), so the full structure is omitted from this post. Simply add the following classes to the project:\n\n[InboundMessage.cs](https://github.com/nexmo-community/QnAMakerMessagesDemo/blob/master/QnAMakerMessagesDemo/InboundMessage.cs)  \n[MessageRequest.cs](https://github.com/nexmo-community/QnAMakerMessagesDemo/blob/master/QnAMakerMessagesDemo/MessageRequest.cs)\n\n### Send Messages\n\nWith the structures sorted the next step is to send messages across the Nexmo messages API. Create a class called `MessageSender`, this will have a single static method `SendMessage` which will simply create a Message Request, create a JWT, create a request, and send the request to the Messages API—it should look something like this:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public static void SendMessage(string message, string fromId, string toId, IConfiguration config, string type) { const string MESSAGING_URL = @\"https://api.nexmo.com/v0.1/messages\"; try { var jwt = TokenGenerator.GenerateToken(config); //construct message Request var requestObject = new MessageRequest() { to = new MessageRequest.To() { type = type }, from = new MessageRequest.From() { type = type }, message = new MessageRequest.Message() { content = new MessageRequest.Message.Content() { type = \"text\", text = message } } }; //special messenger request formatting (use to/from id rather than number, set category to RESPONSE) if (type == \"messenger\") { requestObject.message.messenger = new MessageRequest.Message.Messenger() { category = \"RESPONSE\" }; requestObject.to.id = toId; requestObject.from.id = fromId; } else { requestObject.to.number = toId; requestObject.from.number = fromId; } //Generate Request payload from requestObject var requestPayload = JsonConvert.SerializeObject(requestObject, new JsonSerializerSettings() { NullValueHandling = NullValueHandling.Ignore, DefaultValueHandling = DefaultValueHandling.Ignore }); //build request var httpWebRequest = (HttpWebRequest)WebRequest.Create(MESSAGING_URL); httpWebRequest.ContentType = \"application/json\"; httpWebRequest.Accept = \"application/json\"; httpWebRequest.Method = \"POST\"; httpWebRequest.PreAuthenticate = true; httpWebRequest.Headers.Add(\"Authorization\", \"Bearer \" + jwt); using (var streamWriter = new StreamWriter(httpWebRequest.GetRequestStream())) { streamWriter.Write(requestPayload); } //handle response using (var httpResponse = (HttpWebResponse)httpWebRequest.GetResponse()) { using (var streamReader = new StreamReader(httpResponse.GetResponseStream())) { var result = streamReader.ReadToEnd(); Console.WriteLine(result); Console.WriteLine(\"Message Sent\"); } } } catch (Exception e) { Debug.WriteLine(e.ToString()); } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-19\">19</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-21\">21</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-23\">23</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-25\">25</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-27\">27</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-29\">29</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-31\">31</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-33\">33</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-35\">35</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-37\">37</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-39\">39</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-41\">41</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-43\">43</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-45\">45</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-47\">47</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-49\">49</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-51\">51</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-53\">53</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-55\">55</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-57\">57</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-59\">59</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-61\">61</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-63\">63</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-64\">64</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-65\">65</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-66\">66</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-67\">67</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-68\">68</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-69\">69</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-70\">70</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-71\">71</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-72\">72</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-73\">73</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-74\">74</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058fe399342810-75\">75</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058fe399342810-76\">76</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">void</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">SendMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fromId</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">toId</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">type</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MESSAGING_URL</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-s\">\"https://api.nexmo.com/v0.1/messages\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">try</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">TokenGenerator</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GenerateToken</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-7\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">//construct message Request</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">requestObject</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MessageRequest</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">to</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">To</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">type</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">From</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-17\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">type</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-18\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-19\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">message</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Message</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-20\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-21\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">content</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Content</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-22\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-23\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"text\"</span><span class=\"crayon-sy\">,</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-24\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">text</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-i\">message</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-25\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-26\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-27\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-28\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-29\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">//special messenger request formatting (use to/from id rather than number, set category to RESPONSE)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-30\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"messenger\"</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-31\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-32\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">requestObject</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">messenger</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">MessageRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Messenger</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-33\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-34\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">category</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"RESPONSE\"</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-35\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-36\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">requestObject</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">to</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">toId</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-37\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">requestObject</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fromId</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-38\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-39\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-40\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-41\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">requestObject</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">to</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">number</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">toId</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-42\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">requestObject</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">number</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">fromId</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-43\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-44\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-45\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">//Generate Request payload from requestObject</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-46\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">requestPayload</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">JsonConvert</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SerializeObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">requestObject</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">JsonSerializerSettings</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NullValueHandling</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">NullValueHandling</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Ignore</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DefaultValueHandling</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">DefaultValueHandling</span><span class=\"crayon-sy\">.</span><span class=\"crayon-i\">Ignore</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-47\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-48\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">//build request</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-49\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">HttpWebRequest</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">WebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Create</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">MESSAGING_URL</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-50\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">ContentType</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"application/json\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-51\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Accept</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"application/json\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-52\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Method</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"POST\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-53\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">PreAuthenticate</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">true</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-54\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Headers</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"Authorization\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Bearer \"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jwt</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-55\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">streamWriter</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StreamWriter</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetRequestStream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-56\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-57\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">streamWriter</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Write</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">requestPayload</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-58\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-59\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-60\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-c\">//handle response</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-61\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">httpResponse</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">HttpWebResponse</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">httpWebRequest</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetResponse</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-62\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-63\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">streamReader</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StreamReader</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">httpResponse</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">GetResponseStream</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-64\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-65\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">result</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">streamReader</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReadToEnd</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-66\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">result</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-67\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"Message Sent\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-68\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-69\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-70\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-71\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">catch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">Exception</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-72\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-73\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Debug</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">e</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-74\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058fe399342810-75\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058fe399342810-76\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Ask the Bot a Question and Send a Response\n\nNow it’s time to talk to the FAQ bot from the app. This is where the sample REST calls that QnAMaker presented earlier will come into play. Recall this string from earlier.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">POST /knowledgebases/YOUR_KNOWLEDGE_BASE_ID/generateAnswer Host: https://AZURE_APP_NAME.azurewebsites.net/qnamaker Authorization: EndpointKey YOUR_KNOWLEDGE_BASE_ENDPOINT_KEY Content-Type: application/json {\"question\":\"YOUR_QUESTION\"}</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058ff355851103-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058ff355851103-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058ff355851103-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058ff355851103-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e058ff355851103-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e058ff355851103-6\">6</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058ff355851103-1\"><span class=\"crayon-v\">POST</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">knowledgebases</span><span class=\"crayon-o\">/</span><span class=\"crayon-v\">YOUR_KNOWLEDGE_BASE_ID</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">generateAnswer</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058ff355851103-2\"><span class=\"crayon-v\">Host</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">https</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//AZURE_APP_NAME.azurewebsites.net/qnamaker</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058ff355851103-3\"><span class=\"crayon-v\">Authorization</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">EndpointKey </span><span class=\"crayon-e\">YOUR_KNOWLEDGE_BASE_ENDPOINT_KEY</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058ff355851103-4\"><span class=\"crayon-v\">Content</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">Type</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">application</span><span class=\"crayon-o\">/</span><span class=\"crayon-e\">json</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e058ff355851103-5\"><span class=\"crayon-sy\">{</span><span class=\"crayon-s\">\"question\"</span><span class=\"crayon-o\">:</span><span class=\"crayon-s\">\"YOUR_QUESTION\"</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e058ff355851103-6\">&nbsp;</div></div></td></tr></tbody></table>\n\nUse that string to create some useful constants/readonly’s for the Questioner—fill in with appropriate values from the string above:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">//TODO: fill in with Knowledgebase ID const string kb_id = \"YOUR_KNOWLEDGE_BASE_ID\"; //TODO: fill in with Knowledgebase Endpoint key const string ENDPOINT_KEY = \"YOUR_KNOWLEDGE_BASE_ENDPOINT_KEY\"; const string QUESTION_FORMAT = @\"{{'question': '{0}'}}\"; //TODO fill in base url static readonly string URI = $\"https://AZURE_APP_NAME.azurewebsites.net/qnamaker/knowledgebases/{kb_id}/generateAnswer\";</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05900024073380-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05900024073380-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05900024073380-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05900024073380-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05900024073380-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05900024073380-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05900024073380-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05900024073380-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05900024073380-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05900024073380-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05900024073380-11\">11</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05900024073380-1\"><span class=\"crayon-c\">//TODO: fill in with Knowledgebase ID</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05900024073380-2\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">kb_id</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"YOUR_KNOWLEDGE_BASE_ID\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05900024073380-3\">&nbsp;</div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05900024073380-4\"><span class=\"crayon-c\">//TODO: fill in with Knowledgebase Endpoint key</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05900024073380-5\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ENDPOINT_KEY</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"YOUR_KNOWLEDGE_BASE_ENDPOINT_KEY\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05900024073380-6\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05900024073380-7\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">QUESTION_FORMAT</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">@</span><span class=\"crayon-s\">\"{{'question': '{0}'}}\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05900024073380-8\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05900024073380-9\"><span class=\"crayon-c\">//TODO fill in base url</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05900024073380-10\"><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">readonly </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">URI</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">$</span><span class=\"crayon-s\">\"https://AZURE_APP_NAME.azurewebsites.net/qnamaker/knowledgebases/{kb_id}/generateAnswer\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05900024073380-11\">&nbsp;</div></div></td></tr></tbody></table>\n\nNext, create a task to ask the question:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public static async Task&lt;string&gt; RequestAnswer(string question) { using (var client = new HttpClient()) using (var request = new HttpRequestMessage()) { request.Method = HttpMethod.Post; request.RequestUri = new Uri(URI); var formatted_question = string.Format(QUESTION_FORMAT, question); request.Content = new StringContent(formatted_question, Encoding.UTF8, \"application/json\"); request.Headers.Add(\"Authorization\", \"EndpointKey \" + ENDPOINT_KEY); var response = await client.SendAsync(request); var jsonResponse = await response.Content.ReadAsStringAsync(); JObject obj = JObject.Parse(jsonResponse); var answer = ((JArray)obj[\"answers\"])[0][\"answer\"]; return answer.ToString(); } }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05901193516337-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05901193516337-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05901193516337-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05901193516337-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05901193516337-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05901193516337-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05901193516337-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05901193516337-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05901193516337-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05901193516337-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05901193516337-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05901193516337-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05901193516337-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05901193516337-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05901193516337-15\">15</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05901193516337-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05901193516337-17\">17</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05901193516337-18\">18</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05901193516337-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">async </span><span class=\"crayon-v\">Task</span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-t\">string</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">RequestAnswer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">question</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05901193516337-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05901193516337-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">client</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HttpClient</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05901193516337-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">using</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">request</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HttpRequestMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05901193516337-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05901193516337-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Method</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpMethod</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Post</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05901193516337-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">RequestUri</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">Uri</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">URI</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05901193516337-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">formatted_question</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Format</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">QUESTION_FORMAT</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">question</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05901193516337-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Content</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">StringContent</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">formatted_question</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Encoding</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">UTF8</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"application/json\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05901193516337-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Headers</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Add</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"Authorization\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"EndpointKey \"</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">ENDPOINT_KEY</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05901193516337-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">response</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">await </span><span class=\"crayon-v\">client</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SendAsync</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">request</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05901193516337-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">jsonResponse</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">await </span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">Content</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ReadAsStringAsync</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05901193516337-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">JObject </span><span class=\"crayon-v\">obj</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">JObject</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Parse</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">jsonResponse</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05901193516337-14\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">JArray</span><span class=\"crayon-sy\">)</span><span class=\"crayon-v\">obj</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">\"answers\"</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">[</span><span class=\"crayon-s\">\"answer\"</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05901193516337-15\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">answer</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">ToString</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05901193516337-16\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05901193516337-17\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05901193516337-18\">&nbsp;</div></div></td></tr></tbody></table>\n\nThis simply formats the question from the messages API and sends the request off as a generateAnswer post request to the QnAMaker bot.\n\nFinally, create a method to drive the request and reply with an answer.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">public static async Task AskQuestion(string to, string from, string type, string question, IConfiguration config) { question = HttpUtility.JavaScriptStringEncode(question); var response = await RequestAnswer(question); MessageSender.SendMessage(response, from, to, config, type); }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05903193284657-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05903193284657-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05903193284657-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05903193284657-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05903193284657-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05903193284657-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05903193284657-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05903193284657-1\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-m\">static</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">async </span><span class=\"crayon-e\">Task </span><span class=\"crayon-e\">AskQuestion</span><span class=\"crayon-sy\">(</span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">to</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">type</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-t\">string</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">question</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05903193284657-2\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05903193284657-3\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">question</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpUtility</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">JavaScriptStringEncode</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">question</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05903193284657-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-t\">var</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">response</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">await </span><span class=\"crayon-e\">RequestAnswer</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">question</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05903193284657-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">MessageSender</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SendMessage</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">response</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-st\">to</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">type</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05903193284657-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05903193284657-7\">&nbsp;</div></div></td></tr></tbody></table>\n\n### Build Controller to Receive Incoming Messages\n\nThe final piece of the puzzle is the controller that will handle the influx of messages from the Messages API. Create an empty MVC controller called `MessagesController`.\n\n#### Dependency Injection and Configuration\n\nAdd an IConfiguration field called \\_config to this and set up Dependency injection of configuration by creating a controller constructor taking an IConfiguration object:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">private IConfiguration _config; public MessagesController(IConfiguration config) { _config = config; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05904539998770-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05904539998770-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05904539998770-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05904539998770-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05904539998770-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05904539998770-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05904539998770-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05904539998770-1\"><span class=\"crayon-m\">private</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">_config</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05904539998770-2\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05904539998770-3\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">MessagesController</span><span class=\"crayon-sy\">(</span><span class=\"crayon-e\">IConfiguration </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05904539998770-4\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05904539998770-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_config</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">config</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05904539998770-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05904539998770-7\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Status Request\n\nNext create a Status Post request that simply returns no content:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">[HttpPost] public HttpStatusCode Status() { return HttpStatusCode.NoContent; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05905383702828-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05905383702828-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05905383702828-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05905383702828-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05905383702828-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05905383702828-6\">6</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05905383702828-1\"><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">HttpPost</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05905383702828-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HttpStatusCode </span><span class=\"crayon-e\">Status</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05905383702828-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05905383702828-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpStatusCode</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NoContent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05905383702828-5\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05905383702828-6\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Inbound Messages\n\nNext, add a Post Request for inbound messages from the Messages API.\n\nThis method will extract the inbound message from the body, then forward on the Questioner tasks from the content of the request body.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">[HttpPost] public HttpStatusCode Inbound([FromBody]InboundMessage message) { Debug.WriteLine(JsonConvert.SerializeObject(message)); if (message.from.type == \"messenger\") { _ = Questioner.AskQuestion(message.from.id, message.to.id, message.from.type, message.message.content.text, _config); } else { _ = Questioner.AskQuestion(message.from.number, message.to.number, message.from.type, message.message.content.text, _config); } return HttpStatusCode.NoContent; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05906079666965-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05906079666965-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05906079666965-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05906079666965-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05906079666965-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05906079666965-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05906079666965-7\">7</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05906079666965-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05906079666965-9\">9</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05906079666965-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05906079666965-11\">11</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05906079666965-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05906079666965-13\">13</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05906079666965-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05906079666965-15\">15</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05906079666965-1\"><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">HttpPost</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05906079666965-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HttpStatusCode </span><span class=\"crayon-e\">Inbound</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">FromBody</span><span class=\"crayon-sy\">]</span><span class=\"crayon-e\">InboundMessage </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05906079666965-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05906079666965-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">Debug</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">WriteLine</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">JsonConvert</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SerializeObject</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05906079666965-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">if</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">type</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">==</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"messenger\"</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05906079666965-6\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05906079666965-7\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Questioner</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AskQuestion</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">to</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">id</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">type</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_config</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05906079666965-8\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05906079666965-9\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">else</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05906079666965-10\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05906079666965-11\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Questioner</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AskQuestion</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">number</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">to</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">number</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">from</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">type</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">message</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">content</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_config</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05906079666965-12\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05906079666965-13\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpStatusCode</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NoContent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05906079666965-14\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05906079666965-15\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Inbound SMS\n\nFinally, add an HttpGet request to manage the inbound SMS messages. This will similarly extract the needed information from the inbound message and ask the question of the questioner.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">[HttpGet] public HttpStatusCode InboundSms([FromQuery] SMS.SMSInbound inboundMessage) { _ = Questioner.AskQuestion(inboundMessage.msisdn, inboundMessage.to, \"sms\", inboundMessage.text, _config); return HttpStatusCode.NoContent; }</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05907475662063-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05907475662063-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05907475662063-3\">3</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05907475662063-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05907475662063-5\">5</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05907475662063-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05907475662063-7\">7</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05907475662063-1\"><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">HttpGet</span><span class=\"crayon-sy\">]</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05907475662063-2\"><span class=\"crayon-m\">public</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">HttpStatusCode </span><span class=\"crayon-e\">InboundSms</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">FromQuery</span><span class=\"crayon-sy\">]</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">SMS</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">SMSInbound </span><span class=\"crayon-v\">inboundMessage</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05907475662063-3\"><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05907475662063-4\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">_</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Questioner</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">AskQuestion</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">inboundMessage</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">msisdn</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inboundMessage</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">to</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"sms\"</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">inboundMessage</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">_config</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05907475662063-5\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">return</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">HttpStatusCode</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">NoContent</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05907475662063-6\"><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05907475662063-7\">&nbsp;</div></div></td></tr></tbody></table>\n\nWith this sorted, the service is ready for deployment.\n\n## Testing\n\nThe last thing needed is to fire up the service, expose it to the internet, and wire up the Nexmo Messages App to send webhooks to the service.\n\n### IIS Express Configuration\n\nFor simplicity this demo uses IIS. To make setting up ngrok easier disable SSL for IIS Express by going into the project Debug properties and unchecking the “Enable SSL” setting:\n\n![Debug settings](https://www.nexmo.com/wp-content/uploads/2019/12/IIS_Config.png)\n\nTake note of the port number in the app URL field, it will be used in the next step.\n\n### Setting up Ngrok\n\nThe next step is to expose this endpoint to the internet. For this demo, something like [ngrok](https://ngrok.com/) can be used to create a tunnel back to the IIS Express port. After installing ngrok use a command like:\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">ngrok http --host-header=\"localhost:PORT_NUMBER\" http://localhost:PORT_NUMBER</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05908561508739-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05908561508739-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05908561508739-1\"><span class=\"crayon-e\">ngrok </span><span class=\"crayon-v\">http</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">--</span><span class=\"crayon-v\">host</span><span class=\"crayon-o\">-</span><span class=\"crayon-v\">header</span><span class=\"crayon-o\">=</span><span class=\"crayon-s\">\"localhost:PORT_NUMBER\"</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//localhost:PORT_NUMBER</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05908561508739-2\">&nbsp;</div></div></td></tr></tbody></table>\n\nTo set up the tunnel, replace ‘PORT\\_NUMBER’ with the IIS Express port number noted earlier. This will create an output that looks something like this:\n\n![ngrok output](https://www.nexmo.com/wp-content/uploads/2019/12/ngrok-1.png)\n\nTake note of the http base url here—in the image above the base url is http://dc0feb1d.ngrok.io.\n\n### Configuring webhooks\n\nThe final step before turning the service on is to configure the webhooks to callback into the service.\n\n#### Inbound SMS\n\nGo do the [Nexmo Dashboard](https://dashboard.nexmo.com/) and go to `Settings`. Set the Inbound Messages URL for SMS to the ngrok\\_baseurl/messages/InboundSms, given the example above.\n\n<textarea wrap=\"soft\" class=\"crayon-plain print-no\" data-settings=\"dblclick\" readonly=\"\" style=\"-moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4; font-size: 14px !important; line-height: 22px !important;\">http://dc0feb1d.ngroke.io/messages/InboundSms</textarea>\n\n<table class=\"crayon-table\"><tbody><tr class=\"crayon-row\"><td class=\"crayon-nums \" data-settings=\"show\"><div class=\"crayon-nums-content\" style=\"font-size: 14px !important; line-height: 22px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5e9ddc1e05909252783658-1\">1</div><div class=\"crayon-num crayon-striped-num\" data-line=\"crayon-5e9ddc1e05909252783658-2\">2</div></div></td><td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 14px !important; line-height: 22px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5e9ddc1e05909252783658-1\"><span class=\"crayon-v\">http</span><span class=\"crayon-o\">:</span><span class=\"crayon-c\">//dc0feb1d.ngroke.io/messages/InboundSms</span></div><div class=\"crayon-line crayon-striped-line\" id=\"crayon-5e9ddc1e05909252783658-2\">&nbsp;</div></div></td></tr></tbody></table>\n\n#### Other Inbound Messages\n\nIn the [Nexmo Dashboard](https://dashboard.nexmo.com/) open Messages and Dispatch -> Your Applications. Open the application associated with the linked accounts, and click ‘Edit’. Under Capabilities in the Messages section, set the Inbound URL and Status URL to match the ngrok baseurl /Messages/Inbound and /Messages/Status respectively and click save.\n\nPer the example ngrok tunnel it will look something like:\n\n![messages urls](https://www.nexmo.com/wp-content/uploads/2019/12/messages_urls.png)\n\n> NOTE: The 8 characters preceding ngrok.io are not fixed on the free tier. This means every time the ngrok command is run it will be necessary to change where the webhooks are aiming. It’s possible to create a static hostname by upgrading to a paid ngrok tier.\n\n## Fire It Up and Test\n\nAnd that’s it! Santa’s Nexmo Helper is ready to deploy. Fire up IIS Express and message away. This can be reached over any channel configured to reach the messages app.\n\nHere’s an example from Facebook:\n\n![Facebook Example](https://www.nexmo.com/wp-content/uploads/2019/12/facebook_sample.jpg)\n\nAnd one from SMS:\n\n![SMS Example](https://www.nexmo.com/wp-content/uploads/2019/12/sms_sample.jpg)\n\nWell, there it is, Santa’s Nexmo Helper is up and operational.\n\n## Further reading\n\n*   Full source code for this demo can be found in [GitHub](https://github.com/nexmo-community/QnAMakerMessagesDemo)\n*   For more info on QnAMaker check out their website [here](https://www.qnamaker.ai/)\n*   For fully interactive bots check out [Luis Ai](https://www.luis.ai/)\n*   For more information on the Nexmo Messages API, check out the documentation on [Nexmo Developer](https://developer.nexmo.com/messages/overview)\n*   For more APIs by Nexmo check out our [Developer site](https://developer.nexmo.com/)\n*   To check out the Nexmo .NET SDK you can take a look at out our [GitHub Repo](https://github.com/nexmo/nexmo-dotnet)"}